
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>FSL’s fMRI Data Analysis via Nipype &#8212; Neurodesk</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/algolia.css?v=6923f26e" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-4Z9774J59Y"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-4Z9774J59Y');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-4Z9774J59Y');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'functional_imaging/nipype_fsl_all_levels_flanker';</script>
    <script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3.3.3/dist/umd/index.js"></script>
    <script src="../_static/algolia.js?v=b553005c"></script>
    <link rel="canonical" href="https://neurodesk.github.io/example-notebooks/intro.html/functional_imaging/nipype_fsl_all_levels_flanker.html" />
    <link rel="icon" href="../_static/neurodesk_logo.svg"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Introduction to Preprocessing" href="intro_to_preprocessing.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/neurodesk_logo.svg" class="logo__image only-light" alt="Neurodesk - Home"/>
    <script>document.write(`<img src="../_static/neurodesk_logo.svg" class="logo__image only-dark" alt="Neurodesk - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Neurodesk environment
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Workflows</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../workflows/MRIQC.html">MRIQC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../workflows/RISE_slideshow.html">RISE Slideshow of a Jupyter Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../workflows/bids_conversion.html">BIDS conversion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../workflows/nipype_full.html">Nipype on Neurodesk</a></li>
<li class="toctree-l1"><a class="reference internal" href="../workflows/nipype_short.html">Basic Nipype</a></li>


<li class="toctree-l1"><a class="reference internal" href="../workflows/pyBIDS.html">pyBIDS - a Python API for working with BIDS datasets</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Structural Imaging</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../structural_imaging/brain_extraction_different_tools.html">Brain extraction with different software packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../structural_imaging/freesurfer.html">Freesurfer</a></li>



<li class="toctree-l1"><a class="reference internal" href="../structural_imaging/qsmxt.html">QSMxT</a></li>








<li class="toctree-l1"><a class="reference internal" href="../structural_imaging/sct_toolbox.html">SCT Toolbox</a></li>


</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Diffusion Imaging</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../diffusion_imaging/MRtrix_CSD.html">Diffusion Analysis with MRtrix: Part 2 - Constrained Spherical Deconvolution and Tissue estimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../diffusion_imaging/MRtrix_CoReg_Streamline.html">Diffusion Analysis with MRtrix: Part 3 - Registration and Streamline Fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../diffusion_imaging/MRtrix_Preprocessing.html">Diffusion Analysis with MRtrix: Part 1 - Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../diffusion_imaging/mrtrix3tissue.html">MRtrix3Tissue</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Functional Imaging</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="AFNI_preprocessing_and_glm.html">AFNI Preprocessing and GLM</a></li>
<li class="toctree-l1"><a class="reference internal" href="AFNI_preprocessing_only.html">AFNI Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="aslprep.html">ASLprep</a></li>
<li class="toctree-l1"><a class="reference internal" href="deepretinotopy.html">DeepRetinotopy</a></li>



<li class="toctree-l1"><a class="reference internal" href="first_and_second_level_spm.html">First and Second Level fMRI Analysis with SPM</a></li>
<li class="toctree-l1"><a class="reference internal" href="fmriprep.html">fMRIprep</a></li>
<li class="toctree-l1"><a class="reference internal" href="intro_to_preprocessing.html">Introduction to Preprocessing</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">FSL’s fMRI Data Analysis via Nipype</a></li>




</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/NeuroDesk/example-notebooks/blob/main/books/functional_imaging/nipype_fsl_all_levels_flanker.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/NeuroDesk/example-notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/NeuroDesk/example-notebooks/edit/main/books/functional_imaging/nipype_fsl_all_levels_flanker.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/NeuroDesk/example-notebooks/issues/new?title=Issue%20on%20page%20%2Ffunctional_imaging/nipype_fsl_all_levels_flanker.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/functional_imaging/nipype_fsl_all_levels_flanker.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>FSL’s fMRI Data Analysis via Nipype</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">FSL’s fMRI Data Analysis via Nipype</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#setup-neurodesk">Setup Neurodesk</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#first-level-glm-using-nipype-fsl">First-level GLM using Nipype FSL</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preparation">Preparation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up-data-path">Set up data path</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#start-the-workflow">Start the workflow</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#initialisation">Initialisation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preprocessing">Preprocessing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#motion-correction">Motion Correction</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#functionally-masking">Functionally Masking</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#grand-mean-scaling">Grand Mean Scaling</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#susan-noise-reduction">SUSAN Noise Reduction</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#temporal-filtering">Temporal Filtering</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#first-level-glm">First-Level GLM</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#get-events">Get events</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up-contrasts">Set-up contrasts</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#registration">Registration</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1">Step 1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2">Step 2</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-first-level-glm">The first-level GLM</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#second-level-glm-using-nipype-fsl">Second level GLM using Nipype FSL</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#second-level-glm">Second-level GLM</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#higher-level-input-files-preparation">Higher-level input files preparation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-merge-registered-copes-varcopes-masks">Step 1: Merge registered copes &amp; varcopes &amp; masks</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-making-mask">Step 2: Making mask</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-masking-copes-varcopes">Step 3: Masking copes &amp; varcopes</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up-second-level-contrasts-and-fixed-effects">Set up second-level contrasts and fixed-effects</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-second-level-glm">The second-level GLM</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#regapply">Regapply</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#copes-from-the-second-level-glm">Copes from the second-level GLM</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#third-level-glm-using-nipype-fsl">Third-level GLM using Nipype FSL</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#third-level-glm">Third-level GLM</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Higher-level input files preparation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Step 1: Merge registered copes &amp; varcopes &amp; masks</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Step 2: Making mask</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Step 3: Masking copes &amp; varcopes</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up-third-level-contrasts">Set up third-level contrasts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#post-stats">Post-Stats</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#smoothness-estimation">Smoothness estimation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#mask-zstats-file">Mask zstats file</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cluster-wise-thresholding">Cluster-wise thresholding</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#save-the-output">Save the output</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#unthresholded-copes">Unthresholded COPEs</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#thresholded-p-0-05-zstats">Thresholded (p &lt; 0.05) zstats</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <p><a href="https://colab.research.google.com/github/NeuroDesk/example-notebooks/blob/main/books/functional_imaging/nipype_fsl_all_levels_flanker.ipynb" target="_parent"><img alt="Open In Google Colab" src="https://colab.research.google.com/assets/colab-badge.svg" />   </a></p>
<section id="fsl-s-fmri-data-analysis-via-nipype">
<h1>FSL’s fMRI Data Analysis via Nipype<a class="headerlink" href="#fsl-s-fmri-data-analysis-via-nipype" title="Link to this heading">#</a></h1>
<p>Author: Monika Doerig</p>
<p>Citation:</p>
<ul class="simple">
<li><p>Chen Y, Hopp FR, Malik M, Wang PT, Woodman K, Youk S and Weber R (2022) Reproducing FSL’s fMRI data analysis via Nipype: Relevance, challenges, and solutions. Front. Neuroimaging 1:953215. doi: <a class="reference external" href="https://www.frontiersin.org/articles/10.3389/fnimg.2022.953215/full">10.3389/fnimg.2022.953215</a></p></li>
<li><p><a class="reference external" href="https://osf.io/prg53/?view_only=9d7974834a484cdb972bcc3989589b78">Original code on OSF</a></p></li>
</ul>
</section>
<section id="setup-neurodesk">
<h1>Setup Neurodesk<a class="headerlink" href="#setup-neurodesk" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="n">IN_COLAB</span> <span class="o">=</span> <span class="s1">&#39;google.colab&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span>

<span class="k">if</span> <span class="n">IN_COLAB</span><span class="p">:</span>
  <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;LD_PRELOAD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;APPTAINER_BINDPATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;/content,/tmp,/cvmfs&quot;</span>
  <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MPLCONFIGDIR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;/content/matplotlib-mpldir&quot;</span>
  <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;LMOD_CMD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;/usr/share/lmod/lmod/libexec/lmod&quot;</span>

  <span class="err">!</span><span class="n">curl</span> <span class="o">-</span><span class="n">J</span> <span class="o">-</span><span class="n">O</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">NeuroDesk</span><span class="o">/</span><span class="n">neurocommand</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">googlecolab_setup</span><span class="o">.</span><span class="n">sh</span>
  <span class="err">!</span><span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="n">googlecolab_setup</span><span class="o">.</span><span class="n">sh</span>
  <span class="err">!</span><span class="o">./</span><span class="n">googlecolab_setup</span><span class="o">.</span><span class="n">sh</span>

  <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MODULEPATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/&#39;</span><span class="p">),</span> <span class="n">x</span><span class="p">),</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/&#39;</span><span class="p">)))))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Output CPU information:</span>
<span class="o">!</span>cat<span class="w"> </span>/proc/cpuinfo<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">&#39;vendor&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>uniq
<span class="o">!</span>cat<span class="w"> </span>/proc/cpuinfo<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">&#39;model name&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>uniq
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>vendor_id	: AuthenticAMD
model name	: AMD EPYC 7742 64-Core Processor
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>pandas<span class="w"> </span>nilearn<span class="w"> </span>matplotlib
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="first-level-glm-using-nipype-fsl">
<h1>First-level GLM using Nipype FSL<a class="headerlink" href="#first-level-glm-using-nipype-fsl" title="Link to this heading">#</a></h1>
<p>In this notebook, we recreate the first-level GLM and the first level GLM of FSL GUI using nipype code. For each nipype node, we list the corresponding fsl command from the log file. The dataset we use is a Flanker task, which can be downloaded <a class="reference external" href="https://openneuro.org/datasets/ds000102/versions/00001">here</a>.</p>
<p>We also borrow some helps from this <a class="reference external" href="https://nipype.readthedocs.io/en/latest/users/examples/fmri_fsl.html">document</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#load fsl module</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lmod</span>
<span class="k">await</span> <span class="n">lmod</span><span class="o">.</span><span class="n">purge</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">await</span> <span class="n">lmod</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;fsl/6.0.5.1&#39;</span><span class="p">)</span> <span class="c1">#Original pipeline: FSL 6.0.4, nipype 1.6.1.</span>
<span class="k">await</span> <span class="n">lmod</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;fsl/6.0.5.1&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;FSLOUTPUTTYPE&quot;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;NIFTI_GZ&quot;</span>
</pre></div>
</div>
</div>
</div>
<section id="preparation">
<h2>Preparation<a class="headerlink" href="#preparation" title="Link to this heading">#</a></h2>
<p>Import all the relevant libraries needed for the preprocessing stage.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">builtins</span><span class="w"> </span><span class="kn">import</span> <span class="nb">str</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">builtins</span><span class="w"> </span><span class="kn">import</span> <span class="nb">range</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">glob</span><span class="w"> </span><span class="kn">import</span> <span class="n">glob</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">nipype</span><span class="w"> </span><span class="kn">import</span> <span class="n">Function</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nipype.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">fsl</span><span class="p">,</span> <span class="n">utility</span> <span class="k">as</span> <span class="n">util</span><span class="p">,</span> <span class="n">io</span> <span class="k">as</span> <span class="n">nio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">nipype.pipeline.engine</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pe</span>  <span class="c1"># pypeline engine</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">nipype.algorithms.modelgen</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">model</span>  <span class="c1"># model generation</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">nipype.algorithms.rapidart</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ra</span>  <span class="c1"># artifact detection</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">nilearn</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nilearn</span><span class="w"> </span><span class="kn">import</span> <span class="n">surface</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nilearn</span><span class="w"> </span><span class="kn">import</span> <span class="n">plotting</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># check output type and fsl version</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fsl</span><span class="o">.</span><span class="n">Info</span><span class="o">.</span><span class="n">output_type</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fsl</span><span class="o">.</span><span class="n">Info</span><span class="o">.</span><span class="n">version</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>NIFTI_GZ
6.0.5.1:57b01774
</pre></div>
</div>
</div>
</div>
<section id="set-up-data-path">
<h3>Set up data path<a class="headerlink" href="#set-up-data-path" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Input: Set the BIDS path</span>
<span class="n">data_dir_first</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;ds000102&#39;</span><span class="p">)</span>
<span class="c1"># Output: Set path where nipype will store stepwise results</span>
<span class="n">exp_dir_first</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;output_level1&#39;</span><span class="p">)</span>

<span class="c1"># Input: Set path of first level outputs</span>
<span class="n">data_dir_second</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;output_level1/level1_results/&#39;</span><span class="p">)</span>
<span class="c1"># Output: Set path where nipype will store stepwise results</span>
<span class="n">exp_dir_second</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;output_level2/&#39;</span><span class="p">)</span>

<span class="c1"># Input: Set path of second level outputs</span>
<span class="n">data_dir_third</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;output_level2/level2_results/&#39;</span><span class="p">)</span>
<span class="c1"># Output: Set path where nipype will store stepwise results</span>
<span class="n">exp_dir_third</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;output_level3/&#39;</span><span class="p">)</span>

<span class="n">PATTERN</span> <span class="o">=</span> <span class="s2">&quot;sub-0*&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_scroll-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>datalad<span class="w"> </span>install<span class="w"> </span>https://github.com/OpenNeuroDatasets/ds000102.git
<span class="o">!</span><span class="nb">cd</span><span class="w"> </span>ds000102<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>datalad<span class="w"> </span>get<span class="w"> </span><span class="nv">$PATTERN</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Clone attempt:   0%|              | 0.00/2.00 [00:00&lt;?, ? Candidate locations/s]
Enumerating: 0.00 Objects [00:00, ? Objects/s]
                                              
Counting:   0%|                               | 0.00/27.0 [00:00&lt;?, ? Objects/s]
                                                                                
Compressing:   0%|                            | 0.00/23.0 [00:00&lt;?, ? Objects/s]
                                                                                
Receiving:   0%|                             | 0.00/2.15k [00:00&lt;?, ? Objects/s]
                                                                                
Resolving:   0%|                                | 0.00/537 [00:00&lt;?, ? Deltas/s]
[INFO   ] Filesystem allows writing to files whose write bit is not set.        
[INFO   ] Detected a crippled filesystem. 
[INFO   ] Disabling core.symlinks. 
[INFO   ] Entering an adjusted branch where files are unlocked as this filesystem does not support locked files. 
[INFO   ] Switched to branch &#39;adjusted/master(unlocked)&#39; 
[INFO   ] Remote origin not usable by git-annex; setting annex-ignore 
[INFO   ] https://github.com/OpenNeuroDatasets/ds000102.git/config download failed: Not Found 
[INFO   ] access to 1 dataset sibling s3-PRIVATE not auto-enabled, enable with:
| 		datalad siblings -d &quot;/home/jovyan/example-notebooks/functional_imaging/ds000102&quot; enable -s s3-PRIVATE 
<span class=" -Color -Color-Bold">install</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): /home/jovyan/example-notebooks/functional_imaging/ds000102 (<span class=" -Color -Color-Bold -Color-Bold-Magenta">dataset</span>)
Total:   0%|                                    | 0.00/618M [00:00&lt;?, ? Bytes/s]
Get sub-07/a .. 7_T1w.nii.gz:   0%|            | 0.00/10.7M [00:00&lt;?, ? Bytes/s]
Get sub-07/a .. 7_T1w.nii.gz:   0%|    | 18.9k/10.7M [00:00&lt;01:28, 121k Bytes/s]
Get sub-07/a .. 7_T1w.nii.gz:   0%|    | 50.7k/10.7M [00:00&lt;01:07, 158k Bytes/s]
Get sub-07/a .. 7_T1w.nii.gz:   1%|     | 138k/10.7M [00:00&lt;00:34, 304k Bytes/s]
Get sub-07/a .. 7_T1w.nii.gz:   3%|▏    | 277k/10.7M [00:00&lt;00:20, 515k Bytes/s]
Get sub-07/a .. 7_T1w.nii.gz:   5%|▎    | 573k/10.7M [00:00&lt;00:10, 947k Bytes/s]
Get sub-07/a .. 7_T1w.nii.gz:  11%|▎  | 1.16M/10.7M [00:01&lt;00:05, 1.79M Bytes/s]
Get sub-07/a .. 7_T1w.nii.gz:  22%|▋  | 2.36M/10.7M [00:01&lt;00:02, 3.45M Bytes/s]
Get sub-07/a .. 7_T1w.nii.gz:  35%|█  | 3.73M/10.7M [00:01&lt;00:01, 4.69M Bytes/s]
Get sub-07/a .. 7_T1w.nii.gz:  54%|█▌ | 5.76M/10.7M [00:01&lt;00:00, 7.82M Bytes/s]
Get sub-07/a .. 7_T1w.nii.gz:  73%|██▏| 7.78M/10.7M [00:01&lt;00:00, 10.6M Bytes/s]
Get sub-07/a .. 7_T1w.nii.gz:  88%|██▋| 9.39M/10.7M [00:01&lt;00:00, 10.6M Bytes/s]
Total:   2%|▍                          | 10.7M/618M [00:03&lt;02:57, 3.42M Bytes/s]
Get sub-07/f .. _bold.nii.gz:   0%|            | 0.00/28.9M [00:00&lt;?, ? Bytes/s]
Get sub-07/f .. _bold.nii.gz:   6%|▏  | 1.88M/28.9M [00:00&lt;00:02, 10.8M Bytes/s]
Get sub-07/f .. _bold.nii.gz:  13%|▍  | 3.80M/28.9M [00:00&lt;00:02, 10.9M Bytes/s]
Get sub-07/f .. _bold.nii.gz:  20%|▌  | 5.75M/28.9M [00:00&lt;00:02, 11.0M Bytes/s]
Get sub-07/f .. _bold.nii.gz:  26%|▊  | 7.52M/28.9M [00:00&lt;00:01, 12.8M Bytes/s]
Get sub-07/f .. _bold.nii.gz:  33%|█  | 9.70M/28.9M [00:00&lt;00:01, 10.8M Bytes/s]
Get sub-07/f .. _bold.nii.gz:  40%|█▏ | 11.7M/28.9M [00:01&lt;00:01, 11.0M Bytes/s]
Get sub-07/f .. _bold.nii.gz:  47%|█▍ | 13.7M/28.9M [00:01&lt;00:01, 11.2M Bytes/s]
Get sub-07/f .. _bold.nii.gz:  54%|█▋ | 15.8M/28.9M [00:01&lt;00:01, 11.4M Bytes/s]
Get sub-07/f .. _bold.nii.gz:  62%|█▊ | 17.8M/28.9M [00:01&lt;00:00, 13.2M Bytes/s]
Get sub-07/f .. _bold.nii.gz:  69%|██ | 19.9M/28.9M [00:01&lt;00:00, 11.4M Bytes/s]
Get sub-07/f .. _bold.nii.gz:  75%|██▏| 21.6M/28.9M [00:01&lt;00:00, 12.6M Bytes/s]
Get sub-07/f .. _bold.nii.gz:  82%|██▍| 23.8M/28.9M [00:02&lt;00:00, 11.9M Bytes/s]
Get sub-07/f .. _bold.nii.gz:  90%|██▋| 26.2M/28.9M [00:02&lt;00:00, 12.0M Bytes/s]
Get sub-07/f .. _bold.nii.gz:  97%|██▉| 28.2M/28.9M [00:02&lt;00:00, 12.6M Bytes/s]
Total:   6%|█▋                         | 39.7M/618M [00:05&lt;01:27, 6.65M Bytes/s]
Get sub-07/f .. _bold.nii.gz:   0%|            | 0.00/29.0M [00:00&lt;?, ? Bytes/s]
Get sub-07/f .. _bold.nii.gz:   9%|▎  | 2.60M/29.0M [00:00&lt;00:02, 13.0M Bytes/s]
Get sub-07/f .. _bold.nii.gz:  14%|▍  | 4.10M/29.0M [00:00&lt;00:02, 11.1M Bytes/s]
Get sub-07/f .. _bold.nii.gz:  21%|▋  | 6.22M/29.0M [00:00&lt;00:02, 9.35M Bytes/s]
Get sub-07/f .. _bold.nii.gz:  27%|▊  | 7.89M/29.0M [00:00&lt;00:01, 11.1M Bytes/s]
Get sub-07/f .. _bold.nii.gz:  36%|█  | 10.4M/29.0M [00:01&lt;00:01, 9.39M Bytes/s]
Get sub-07/f .. _bold.nii.gz:  41%|█▏ | 12.0M/29.0M [00:01&lt;00:01, 9.25M Bytes/s]
Get sub-07/f .. _bold.nii.gz:  47%|█▍ | 13.6M/29.0M [00:01&lt;00:01, 9.21M Bytes/s]
Get sub-07/f .. _bold.nii.gz:  52%|█▌ | 15.2M/29.0M [00:01&lt;00:01, 9.19M Bytes/s]
Get sub-07/f .. _bold.nii.gz:  58%|█▋ | 16.8M/29.0M [00:01&lt;00:01, 9.30M Bytes/s]
Get sub-07/f .. _bold.nii.gz:  64%|█▉ | 18.4M/29.0M [00:01&lt;00:01, 9.24M Bytes/s]
Get sub-07/f .. _bold.nii.gz:  69%|██ | 20.1M/29.0M [00:02&lt;00:00, 9.31M Bytes/s]
Get sub-07/f .. _bold.nii.gz:  75%|██▎| 21.7M/29.0M [00:02&lt;00:00, 9.84M Bytes/s]
Get sub-07/f .. _bold.nii.gz:  80%|██▍| 23.2M/29.0M [00:02&lt;00:00, 10.8M Bytes/s]
Get sub-07/f .. _bold.nii.gz:  87%|██▌| 25.1M/29.0M [00:02&lt;00:00, 9.07M Bytes/s]
Get sub-07/f .. _bold.nii.gz:  92%|██▊| 26.8M/29.0M [00:02&lt;00:00, 10.1M Bytes/s]
Get sub-07/f .. _bold.nii.gz:  98%|██▉| 28.5M/29.0M [00:02&lt;00:00, 9.17M Bytes/s]
Total:  11%|██▉                        | 68.6M/618M [00:09&lt;01:14, 7.36M Bytes/s]
Get sub-02/a .. 2_T1w.nii.gz:   0%|            | 0.00/10.7M [00:00&lt;?, ? Bytes/s]
Get sub-02/a .. 2_T1w.nii.gz:  16%|▍  | 1.73M/10.7M [00:00&lt;00:00, 9.87M Bytes/s]
Get sub-02/a .. 2_T1w.nii.gz:  32%|▉  | 3.46M/10.7M [00:00&lt;00:00, 9.91M Bytes/s]
Get sub-02/a .. 2_T1w.nii.gz:  48%|█▍ | 5.21M/10.7M [00:00&lt;00:00, 9.94M Bytes/s]
Get sub-02/a .. 2_T1w.nii.gz:  65%|█▉ | 6.96M/10.7M [00:00&lt;00:00, 9.98M Bytes/s]
Get sub-02/a .. 2_T1w.nii.gz:  81%|██▍| 8.71M/10.7M [00:00&lt;00:00, 10.0M Bytes/s]
Get sub-02/a .. 2_T1w.nii.gz:  98%|██▉| 10.5M/10.7M [00:01&lt;00:00, 10.1M Bytes/s]
                                                                                
Get sub-02/f .. _bold.nii.gz:   0%|            | 0.00/29.2M [00:00&lt;?, ? Bytes/s]
Get sub-02/f .. _bold.nii.gz:   6%|▏  | 1.78M/29.2M [00:00&lt;00:02, 10.2M Bytes/s]
Get sub-02/f .. _bold.nii.gz:  12%|▎  | 3.56M/29.2M [00:00&lt;00:02, 10.2M Bytes/s]
Get sub-02/f .. _bold.nii.gz:  18%|▌  | 5.34M/29.2M [00:00&lt;00:02, 10.2M Bytes/s]
Get sub-02/f .. _bold.nii.gz:  24%|▋  | 7.14M/29.2M [00:00&lt;00:02, 10.2M Bytes/s]
Get sub-02/f .. _bold.nii.gz:  31%|▉  | 8.95M/29.2M [00:00&lt;00:01, 10.3M Bytes/s]
Get sub-02/f .. _bold.nii.gz:  37%|█  | 10.7M/29.2M [00:01&lt;00:01, 10.3M Bytes/s]
Get sub-02/f .. _bold.nii.gz:  43%|█▎ | 12.5M/29.2M [00:01&lt;00:01, 10.3M Bytes/s]
Get sub-02/f .. _bold.nii.gz:  49%|█▍ | 14.4M/29.2M [00:01&lt;00:01, 10.3M Bytes/s]
Get sub-02/f .. _bold.nii.gz:  55%|█▋ | 16.0M/29.2M [00:01&lt;00:01, 11.6M Bytes/s]
Get sub-02/f .. _bold.nii.gz:  62%|█▊ | 18.0M/29.2M [00:01&lt;00:01, 10.1M Bytes/s]
Get sub-02/f .. _bold.nii.gz:  68%|██ | 19.8M/29.2M [00:01&lt;00:00, 10.1M Bytes/s]
Get sub-02/f .. _bold.nii.gz:  74%|██▏| 21.7M/29.2M [00:02&lt;00:00, 10.2M Bytes/s]
Get sub-02/f .. _bold.nii.gz:  80%|██▍| 23.5M/29.2M [00:02&lt;00:00, 10.8M Bytes/s]
Get sub-02/f .. _bold.nii.gz:  85%|██▌| 24.9M/29.2M [00:02&lt;00:00, 11.6M Bytes/s]
Get sub-02/f .. _bold.nii.gz:  93%|██▊| 27.1M/29.2M [00:02&lt;00:00, 9.92M Bytes/s]
Get sub-02/f .. _bold.nii.gz:  99%|██▉| 29.0M/29.2M [00:02&lt;00:00, 11.1M Bytes/s]
Total:  18%|████▉                       | 109M/618M [00:13&lt;01:05, 7.81M Bytes/s]
Get sub-02/f .. _bold.nii.gz:   0%|            | 0.00/29.2M [00:00&lt;?, ? Bytes/s]
Get sub-02/f .. _bold.nii.gz:   6%|▏  | 1.83M/29.2M [00:00&lt;00:02, 10.6M Bytes/s]
Get sub-02/f .. _bold.nii.gz:  13%|▍  | 3.66M/29.2M [00:00&lt;00:02, 10.5M Bytes/s]
Get sub-02/f .. _bold.nii.gz:  19%|▌  | 5.51M/29.2M [00:00&lt;00:02, 10.5M Bytes/s]
Get sub-02/f .. _bold.nii.gz:  25%|▊  | 7.35M/29.2M [00:00&lt;00:02, 10.5M Bytes/s]
Get sub-02/f .. _bold.nii.gz:  31%|▉  | 9.18M/29.2M [00:00&lt;00:01, 10.5M Bytes/s]
Get sub-02/f .. _bold.nii.gz:  38%|█▏ | 11.0M/29.2M [00:01&lt;00:01, 10.5M Bytes/s]
Get sub-02/f .. _bold.nii.gz:  44%|█▎ | 12.9M/29.2M [00:01&lt;00:01, 10.5M Bytes/s]
Get sub-02/f .. _bold.nii.gz:  50%|█▌ | 14.7M/29.2M [00:01&lt;00:01, 10.5M Bytes/s]
Get sub-02/f .. _bold.nii.gz:  57%|█▋ | 16.5M/29.2M [00:01&lt;00:01, 10.5M Bytes/s]
Get sub-02/f .. _bold.nii.gz:  63%|█▉ | 18.4M/29.2M [00:01&lt;00:01, 10.6M Bytes/s]
Get sub-02/f .. _bold.nii.gz:  69%|██ | 20.2M/29.2M [00:01&lt;00:00, 10.5M Bytes/s]
Get sub-02/f .. _bold.nii.gz:  76%|██▎| 22.1M/29.2M [00:02&lt;00:00, 10.5M Bytes/s]
Get sub-02/f .. _bold.nii.gz:  82%|██▍| 23.9M/29.2M [00:02&lt;00:00, 11.0M Bytes/s]
Get sub-02/f .. _bold.nii.gz:  86%|██▌| 25.2M/29.2M [00:02&lt;00:00, 11.6M Bytes/s]
Get sub-02/f .. _bold.nii.gz:  94%|██▊| 27.6M/29.2M [00:02&lt;00:00, 10.2M Bytes/s]
                                                                                
Get sub-02/f .. _bold.nii.gz:   0%|            | 0.00/29.2M [00:00&lt;?, ? Bytes/s]
                                                                                
Get sub-05/a .. 5_T1w.nii.gz:   0%|            | 0.00/10.8M [00:00&lt;?, ? Bytes/s]
Get sub-05/a .. 5_T1w.nii.gz:  17%|▌  | 1.84M/10.8M [00:00&lt;00:00, 10.6M Bytes/s]
Get sub-05/a .. 5_T1w.nii.gz:  34%|█  | 3.69M/10.8M [00:00&lt;00:00, 10.5M Bytes/s]
Get sub-05/a .. 5_T1w.nii.gz:  51%|█▌ | 5.52M/10.8M [00:00&lt;00:00, 10.5M Bytes/s]
Get sub-05/a .. 5_T1w.nii.gz:  68%|██ | 7.36M/10.8M [00:00&lt;00:00, 10.6M Bytes/s]
Get sub-05/a .. 5_T1w.nii.gz:  86%|██▌| 9.21M/10.8M [00:00&lt;00:00, 10.5M Bytes/s]
Total:  24%|██████▋                     | 148M/618M [00:18&lt;00:57, 8.15M Bytes/s]
Get sub-05/f .. _bold.nii.gz:   0%|            | 0.00/29.7M [00:00&lt;?, ? Bytes/s]
Get sub-05/f .. _bold.nii.gz:   6%|▏  | 1.83M/29.7M [00:00&lt;00:02, 10.5M Bytes/s]
Get sub-05/f .. _bold.nii.gz:  12%|▎  | 3.69M/29.7M [00:00&lt;00:02, 10.6M Bytes/s]
Get sub-05/f .. _bold.nii.gz:  19%|▌  | 5.52M/29.7M [00:00&lt;00:02, 10.6M Bytes/s]
Get sub-05/f .. _bold.nii.gz:  25%|▋  | 7.29M/29.7M [00:00&lt;00:01, 12.5M Bytes/s]
Get sub-05/f .. _bold.nii.gz:  31%|▉  | 9.21M/29.7M [00:00&lt;00:02, 10.1M Bytes/s]
Get sub-05/f .. _bold.nii.gz:  37%|█  | 11.1M/29.7M [00:01&lt;00:01, 10.3M Bytes/s]
Get sub-05/f .. _bold.nii.gz:  43%|█▎ | 12.9M/29.7M [00:01&lt;00:01, 10.6M Bytes/s]
Get sub-05/f .. _bold.nii.gz:  50%|█▍ | 14.7M/29.7M [00:01&lt;00:01, 12.2M Bytes/s]
Get sub-05/f .. _bold.nii.gz:  56%|█▋ | 16.6M/29.7M [00:01&lt;00:01, 10.0M Bytes/s]
Get sub-05/f .. _bold.nii.gz:  62%|█▊ | 18.5M/29.7M [00:01&lt;00:01, 10.8M Bytes/s]
Get sub-05/f .. _bold.nii.gz:  67%|██ | 19.8M/29.7M [00:01&lt;00:00, 11.3M Bytes/s]
Get sub-05/f .. _bold.nii.gz:  75%|██▏| 22.2M/29.7M [00:02&lt;00:00, 10.0M Bytes/s]
Get sub-05/f .. _bold.nii.gz:  81%|██▍| 24.0M/29.7M [00:02&lt;00:00, 11.2M Bytes/s]
Get sub-05/f .. _bold.nii.gz:  87%|██▌| 25.9M/29.7M [00:02&lt;00:00, 10.1M Bytes/s]
Get sub-05/f .. _bold.nii.gz:  94%|██▊| 27.8M/29.7M [00:02&lt;00:00, 10.3M Bytes/s]
                                                                                
Get sub-05/f .. _bold.nii.gz:   0%|            | 0.00/29.7M [00:00&lt;?, ? Bytes/s]
Get sub-05/f .. _bold.nii.gz:   6%|▏  | 1.79M/29.7M [00:00&lt;00:02, 10.3M Bytes/s]
Get sub-05/f .. _bold.nii.gz:  12%|▎  | 3.68M/29.7M [00:00&lt;00:02, 10.6M Bytes/s]
Get sub-05/f .. _bold.nii.gz:  19%|▌  | 5.56M/29.7M [00:00&lt;00:02, 10.7M Bytes/s]
Get sub-05/f .. _bold.nii.gz:  25%|▊  | 7.46M/29.7M [00:00&lt;00:02, 10.8M Bytes/s]
Get sub-05/f .. _bold.nii.gz:  32%|▉  | 9.37M/29.7M [00:00&lt;00:01, 10.8M Bytes/s]
Get sub-05/f .. _bold.nii.gz:  38%|█▏ | 11.3M/29.7M [00:01&lt;00:01, 10.8M Bytes/s]
Get sub-05/f .. _bold.nii.gz:  45%|█▎ | 13.2M/29.7M [00:01&lt;00:01, 11.1M Bytes/s]
Get sub-05/f .. _bold.nii.gz:  51%|█▌ | 15.1M/29.7M [00:01&lt;00:01, 12.7M Bytes/s]
Get sub-05/f .. _bold.nii.gz:  58%|█▋ | 17.1M/29.7M [00:01&lt;00:01, 10.5M Bytes/s]
Get sub-05/f .. _bold.nii.gz:  64%|█▉ | 19.0M/29.7M [00:01&lt;00:00, 11.3M Bytes/s]
Get sub-05/f .. _bold.nii.gz:  69%|██ | 20.4M/29.7M [00:01&lt;00:00, 11.9M Bytes/s]
Get sub-05/f .. _bold.nii.gz:  77%|██▎| 23.0M/29.7M [00:02&lt;00:00, 10.6M Bytes/s]
Get sub-05/f .. _bold.nii.gz:  84%|██▌| 24.9M/29.7M [00:02&lt;00:00, 11.9M Bytes/s]
Get sub-05/f .. _bold.nii.gz:  91%|██▋| 26.9M/29.7M [00:02&lt;00:00, 10.7M Bytes/s]
Get sub-05/f .. _bold.nii.gz:  98%|██▉| 29.0M/29.7M [00:02&lt;00:00, 10.9M Bytes/s]
                                                                                
Get sub-05/f .. _bold.nii.gz:   0%|            | 0.00/29.7M [00:00&lt;?, ? Bytes/s]
Total:  34%|█████████▍                  | 208M/618M [00:24&lt;00:48, 8.52M Bytes/s]
Get sub-09/a .. 9_T1w.nii.gz:   0%|            | 0.00/10.8M [00:00&lt;?, ? Bytes/s]
Get sub-09/a .. 9_T1w.nii.gz:  17%|▍  | 1.79M/10.8M [00:00&lt;00:00, 17.8M Bytes/s]
Get sub-09/a .. 9_T1w.nii.gz:  38%|█▏ | 4.05M/10.8M [00:00&lt;00:00, 11.0M Bytes/s]
Get sub-09/a .. 9_T1w.nii.gz:  57%|█▋ | 6.11M/10.8M [00:00&lt;00:00, 11.4M Bytes/s]
Get sub-09/a .. 9_T1w.nii.gz:  76%|██▎| 8.14M/10.8M [00:00&lt;00:00, 13.7M Bytes/s]
Get sub-09/a .. 9_T1w.nii.gz:  95%|██▊| 10.3M/10.8M [00:00&lt;00:00, 11.2M Bytes/s]
                                                                                
Get sub-09/f .. _bold.nii.gz:   0%|            | 0.00/29.2M [00:00&lt;?, ? Bytes/s]
Get sub-09/f .. _bold.nii.gz:   7%|▏  | 2.10M/29.2M [00:00&lt;00:02, 13.3M Bytes/s]
Get sub-09/f .. _bold.nii.gz:  13%|▍  | 3.81M/29.2M [00:00&lt;00:01, 15.1M Bytes/s]
Get sub-09/f .. _bold.nii.gz:  22%|▋  | 6.37M/29.2M [00:00&lt;00:01, 11.6M Bytes/s]
Get sub-09/f .. _bold.nii.gz:  29%|▊  | 8.41M/29.2M [00:00&lt;00:01, 13.9M Bytes/s]
Get sub-09/f .. _bold.nii.gz:  37%|█  | 10.7M/29.2M [00:00&lt;00:01, 11.7M Bytes/s]
Get sub-09/f .. _bold.nii.gz:  44%|█▎ | 12.8M/29.2M [00:00&lt;00:01, 13.7M Bytes/s]
Get sub-09/f .. _bold.nii.gz:  52%|█▌ | 15.1M/29.2M [00:01&lt;00:01, 13.2M Bytes/s]
Get sub-09/f .. _bold.nii.gz:  59%|█▊ | 17.3M/29.2M [00:01&lt;00:00, 13.3M Bytes/s]
Get sub-09/f .. _bold.nii.gz:  67%|██ | 19.7M/29.2M [00:01&lt;00:00, 11.7M Bytes/s]
Get sub-09/f .. _bold.nii.gz:  75%|██▏| 21.8M/29.2M [00:01&lt;00:00, 13.5M Bytes/s]
Get sub-09/f .. _bold.nii.gz:  83%|██▍| 24.3M/29.2M [00:01&lt;00:00, 12.1M Bytes/s]
Get sub-09/f .. _bold.nii.gz:  90%|██▋| 26.4M/29.2M [00:02&lt;00:00, 13.8M Bytes/s]
Get sub-09/f .. _bold.nii.gz:  99%|██▉| 29.0M/29.2M [00:02&lt;00:00, 12.5M Bytes/s]
                                                                                
Get sub-09/f .. _bold.nii.gz:   0%|            | 0.00/29.2M [00:00&lt;?, ? Bytes/s]
Get sub-09/f .. _bold.nii.gz:   6%|▏  | 1.70M/29.2M [00:00&lt;00:01, 16.9M Bytes/s]
Get sub-09/f .. _bold.nii.gz:  13%|▍  | 3.85M/29.2M [00:00&lt;00:02, 10.5M Bytes/s]
Get sub-09/f .. _bold.nii.gz:  19%|▌  | 5.58M/29.2M [00:00&lt;00:02, 10.2M Bytes/s]
Get sub-09/f .. _bold.nii.gz:  25%|▊  | 7.31M/29.2M [00:00&lt;00:02, 10.1M Bytes/s]
Get sub-09/f .. _bold.nii.gz:  31%|▉  | 9.13M/29.2M [00:00&lt;00:01, 10.2M Bytes/s]
Get sub-09/f .. _bold.nii.gz:  38%|█▏ | 11.0M/29.2M [00:01&lt;00:01, 10.3M Bytes/s]
Get sub-09/f .. _bold.nii.gz:  44%|█▎ | 12.8M/29.2M [00:01&lt;00:01, 10.9M Bytes/s]
Get sub-09/f .. _bold.nii.gz:  49%|█▍ | 14.4M/29.2M [00:01&lt;00:01, 12.0M Bytes/s]
Get sub-09/f .. _bold.nii.gz:  57%|█▋ | 16.7M/29.2M [00:01&lt;00:01, 10.3M Bytes/s]
Get sub-09/f .. _bold.nii.gz:  64%|█▉ | 18.6M/29.2M [00:01&lt;00:00, 11.4M Bytes/s]
Get sub-09/f .. _bold.nii.gz:  70%|██ | 20.6M/29.2M [00:01&lt;00:00, 10.5M Bytes/s]
Get sub-09/f .. _bold.nii.gz:  77%|██▎| 22.4M/29.2M [00:02&lt;00:00, 12.0M Bytes/s]
Get sub-09/f .. _bold.nii.gz:  84%|██▌| 24.6M/29.2M [00:02&lt;00:00, 12.0M Bytes/s]
Get sub-09/f .. _bold.nii.gz:  91%|██▋| 26.5M/29.2M [00:02&lt;00:00, 11.9M Bytes/s]
Get sub-09/f .. _bold.nii.gz:  98%|██▉| 28.7M/29.2M [00:02&lt;00:00, 10.6M Bytes/s]
Total:  45%|████████████▌               | 277M/618M [00:31&lt;00:38, 8.83M Bytes/s]
Get sub-04/a .. 4_T1w.nii.gz:   0%|            | 0.00/10.7M [00:00&lt;?, ? Bytes/s]
Get sub-04/a .. 4_T1w.nii.gz:  19%|▌  | 2.06M/10.7M [00:00&lt;00:00, 11.8M Bytes/s]
Get sub-04/a .. 4_T1w.nii.gz:  39%|█▏ | 4.19M/10.7M [00:00&lt;00:00, 12.0M Bytes/s]
Get sub-04/a .. 4_T1w.nii.gz:  59%|█▊ | 6.30M/10.7M [00:00&lt;00:00, 15.0M Bytes/s]
Get sub-04/a .. 4_T1w.nii.gz:  79%|██▎| 8.49M/10.7M [00:00&lt;00:00, 11.7M Bytes/s]
Get sub-04/a .. 4_T1w.nii.gz:  98%|██▉| 10.6M/10.7M [00:00&lt;00:00, 13.8M Bytes/s]
                                                                                
Get sub-04/f .. _bold.nii.gz:   0%|            | 0.00/29.1M [00:00&lt;?, ? Bytes/s]
Get sub-04/f .. _bold.nii.gz:   7%|▏  | 2.16M/29.1M [00:00&lt;00:01, 21.6M Bytes/s]
Get sub-04/f .. _bold.nii.gz:  15%|▍  | 4.40M/29.1M [00:00&lt;00:02, 11.6M Bytes/s]
Get sub-04/f .. _bold.nii.gz:  23%|▋  | 6.56M/29.1M [00:00&lt;00:01, 14.7M Bytes/s]
Get sub-04/f .. _bold.nii.gz:  33%|▉  | 9.54M/29.1M [00:00&lt;00:01, 11.0M Bytes/s]
Get sub-04/f .. _bold.nii.gz:  39%|█▏ | 11.4M/29.1M [00:01&lt;00:01, 9.63M Bytes/s]
Get sub-04/f .. _bold.nii.gz:  45%|█▎ | 13.0M/29.1M [00:01&lt;00:01, 9.86M Bytes/s]
Get sub-04/f .. _bold.nii.gz:  50%|█▌ | 14.6M/29.1M [00:01&lt;00:01, 11.0M Bytes/s]
Get sub-04/f .. _bold.nii.gz:  56%|█▋ | 16.3M/29.1M [00:01&lt;00:01, 8.96M Bytes/s]
Get sub-04/f .. _bold.nii.gz:  62%|█▊ | 17.9M/29.1M [00:01&lt;00:01, 9.84M Bytes/s]
Get sub-04/f .. _bold.nii.gz:  68%|██ | 19.6M/29.1M [00:01&lt;00:01, 9.09M Bytes/s]
Get sub-04/f .. _bold.nii.gz:  73%|██▏| 21.3M/29.1M [00:02&lt;00:00, 9.32M Bytes/s]
Get sub-04/f .. _bold.nii.gz:  79%|██▍| 23.0M/29.1M [00:02&lt;00:00, 10.6M Bytes/s]
Get sub-04/f .. _bold.nii.gz:  85%|██▌| 24.8M/29.1M [00:02&lt;00:00, 9.23M Bytes/s]
Get sub-04/f .. _bold.nii.gz:  91%|██▋| 26.5M/29.1M [00:02&lt;00:00, 9.50M Bytes/s]
Get sub-04/f .. _bold.nii.gz:  97%|██▉| 28.3M/29.1M [00:02&lt;00:00, 9.66M Bytes/s]
                                                                                
Get sub-04/f .. _bold.nii.gz:   0%|            | 0.00/29.1M [00:00&lt;?, ? Bytes/s]
Get sub-04/f .. _bold.nii.gz:   6%|▏  | 1.77M/29.1M [00:00&lt;00:02, 10.2M Bytes/s]
Get sub-04/f .. _bold.nii.gz:  12%|▎  | 3.54M/29.1M [00:00&lt;00:02, 10.2M Bytes/s]
Get sub-04/f .. _bold.nii.gz:  18%|▌  | 5.34M/29.1M [00:00&lt;00:02, 10.2M Bytes/s]
Get sub-04/f .. _bold.nii.gz:  25%|▋  | 7.14M/29.1M [00:00&lt;00:02, 10.3M Bytes/s]
Get sub-04/f .. _bold.nii.gz:  31%|▉  | 8.95M/29.1M [00:00&lt;00:01, 10.3M Bytes/s]
Get sub-04/f .. _bold.nii.gz:  37%|█  | 10.8M/29.1M [00:01&lt;00:01, 10.3M Bytes/s]
Get sub-04/f .. _bold.nii.gz:  43%|█▎ | 12.6M/29.1M [00:01&lt;00:01, 10.4M Bytes/s]
Get sub-04/f .. _bold.nii.gz:  50%|█▍ | 14.4M/29.1M [00:01&lt;00:01, 10.4M Bytes/s]
Get sub-04/f .. _bold.nii.gz:  56%|█▋ | 16.3M/29.1M [00:01&lt;00:01, 10.4M Bytes/s]
Get sub-04/f .. _bold.nii.gz:  62%|█▊ | 18.1M/29.1M [00:01&lt;00:01, 10.8M Bytes/s]
Get sub-04/f .. _bold.nii.gz:  68%|██ | 19.9M/29.1M [00:01&lt;00:00, 12.2M Bytes/s]
Get sub-04/f .. _bold.nii.gz:  75%|██▎| 21.9M/29.1M [00:02&lt;00:00, 10.1M Bytes/s]
Get sub-04/f .. _bold.nii.gz:  82%|██▍| 23.7M/29.1M [00:02&lt;00:00, 11.0M Bytes/s]
Get sub-04/f .. _bold.nii.gz:  86%|██▌| 25.0M/29.1M [00:02&lt;00:00, 11.3M Bytes/s]
Get sub-04/f .. _bold.nii.gz:  95%|██▊| 27.5M/29.1M [00:02&lt;00:00, 10.1M Bytes/s]
                                                                                
Get sub-04/f .. _bold.nii.gz:   0%|            | 0.00/29.1M [00:00&lt;?, ? Bytes/s]
                                                                                
Get sub-01/a .. 1_T1w.nii.gz:   0%|            | 0.00/10.6M [00:00&lt;?, ? Bytes/s]
Get sub-01/a .. 1_T1w.nii.gz:  17%|▌  | 1.85M/10.6M [00:00&lt;00:00, 10.7M Bytes/s]
Get sub-01/a .. 1_T1w.nii.gz:  35%|█  | 3.74M/10.6M [00:00&lt;00:00, 10.7M Bytes/s]
Get sub-01/a .. 1_T1w.nii.gz:  53%|█▌ | 5.64M/10.6M [00:00&lt;00:00, 10.8M Bytes/s]
Get sub-01/a .. 1_T1w.nii.gz:  63%|█▉ | 6.72M/10.6M [00:00&lt;00:00, 8.83M Bytes/s]
Get sub-01/a .. 1_T1w.nii.gz:  83%|██▍| 8.81M/10.6M [00:00&lt;00:00, 11.7M Bytes/s]
Get sub-01/a .. 1_T1w.nii.gz:  97%|██▉| 10.3M/10.6M [00:01&lt;00:00, 9.21M Bytes/s]
Total:  58%|████████████████▏           | 356M/618M [00:40&lt;00:29, 8.85M Bytes/s]
Get sub-01/f .. _bold.nii.gz:   0%|            | 0.00/28.1M [00:00&lt;?, ? Bytes/s]
Get sub-01/f .. _bold.nii.gz:   5%|▏  | 1.36M/28.1M [00:00&lt;00:03, 7.99M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  10%|▎  | 2.74M/28.1M [00:00&lt;00:03, 7.94M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  15%|▍  | 4.12M/28.1M [00:00&lt;00:03, 7.93M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  20%|▌  | 5.52M/28.1M [00:00&lt;00:02, 8.31M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  25%|▋  | 6.96M/28.1M [00:00&lt;00:02, 7.95M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  30%|▉  | 8.40M/28.1M [00:01&lt;00:02, 8.04M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  35%|█  | 9.83M/28.1M [00:01&lt;00:02, 8.81M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  39%|█▏ | 11.0M/28.1M [00:01&lt;00:01, 9.40M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  46%|█▎ | 12.8M/28.1M [00:01&lt;00:01, 7.82M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  51%|█▌ | 14.3M/28.1M [00:01&lt;00:01, 9.02M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  56%|█▋ | 15.8M/28.1M [00:01&lt;00:01, 7.92M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  62%|█▊ | 17.3M/28.1M [00:02&lt;00:01, 8.11M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  67%|██ | 18.8M/28.1M [00:02&lt;00:01, 8.28M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  72%|██▏| 20.3M/28.1M [00:02&lt;00:00, 8.41M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  78%|██▎| 21.8M/28.1M [00:02&lt;00:00, 8.54M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  83%|██▍| 23.4M/28.1M [00:02&lt;00:00, 8.62M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  89%|██▋| 24.9M/28.1M [00:02&lt;00:00, 8.68M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  94%|██▊| 26.5M/28.1M [00:03&lt;00:00, 8.72M Bytes/s]
Get sub-01/f .. _bold.nii.gz: 100%|██▉| 28.0M/28.1M [00:03&lt;00:00, 8.81M Bytes/s]
                                                                                
Get sub-01/f .. _bold.nii.gz:   0%|            | 0.00/28.1M [00:00&lt;?, ? Bytes/s]
Get sub-01/f .. _bold.nii.gz:   6%|▏  | 1.55M/28.1M [00:00&lt;00:02, 9.47M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  11%|▎  | 3.14M/28.1M [00:00&lt;00:02, 8.91M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  17%|▌  | 4.71M/28.1M [00:00&lt;00:02, 8.95M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  22%|▋  | 6.28M/28.1M [00:00&lt;00:02, 9.70M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  27%|▊  | 7.57M/28.1M [00:00&lt;00:01, 10.5M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  34%|█  | 9.46M/28.1M [00:01&lt;00:02, 8.56M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  38%|█▏ | 10.6M/28.1M [00:01&lt;00:01, 9.09M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  45%|█▎ | 12.7M/28.1M [00:01&lt;00:01, 8.77M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  51%|█▌ | 14.2M/28.1M [00:01&lt;00:01, 8.89M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  56%|█▋ | 15.8M/28.1M [00:01&lt;00:01, 8.96M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  62%|█▊ | 17.5M/28.1M [00:01&lt;00:01, 9.00M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  68%|██ | 19.1M/28.1M [00:02&lt;00:01, 9.06M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  73%|██▏| 20.7M/28.1M [00:02&lt;00:00, 9.09M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  79%|██▎| 22.3M/28.1M [00:02&lt;00:00, 9.08M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  86%|██▌| 24.2M/28.1M [00:02&lt;00:00, 9.28M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  91%|██▋| 25.5M/28.1M [00:02&lt;00:00, 9.13M Bytes/s]
Get sub-01/f .. _bold.nii.gz:  96%|██▉| 27.1M/28.1M [00:02&lt;00:00, 9.21M Bytes/s]
                                                                                
Get sub-08/a .. 8_T1w.nii.gz:   0%|            | 0.00/10.6M [00:00&lt;?, ? Bytes/s]
Get sub-08/a .. 8_T1w.nii.gz:  15%|▍  | 1.62M/10.6M [00:00&lt;00:00, 9.23M Bytes/s]
Get sub-08/a .. 8_T1w.nii.gz:  31%|▉  | 3.23M/10.6M [00:00&lt;00:00, 9.24M Bytes/s]
Get sub-08/a .. 8_T1w.nii.gz:  46%|█▎ | 4.83M/10.6M [00:00&lt;00:00, 9.23M Bytes/s]
Get sub-08/a .. 8_T1w.nii.gz:  61%|█▊ | 6.44M/10.6M [00:00&lt;00:00, 9.20M Bytes/s]
Get sub-08/a .. 8_T1w.nii.gz:  76%|██▎| 8.06M/10.6M [00:00&lt;00:00, 9.21M Bytes/s]
Get sub-08/a .. 8_T1w.nii.gz:  92%|██▋| 9.67M/10.6M [00:01&lt;00:00, 9.20M Bytes/s]
                                                                                
Get sub-08/f .. _bold.nii.gz:   0%|            | 0.00/28.6M [00:00&lt;?, ? Bytes/s]
Get sub-08/f .. _bold.nii.gz:   5%|▏  | 1.57M/28.6M [00:00&lt;00:03, 9.01M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  11%|▎  | 3.19M/28.6M [00:00&lt;00:02, 9.13M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  17%|▌  | 4.80M/28.6M [00:00&lt;00:02, 9.17M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  22%|▋  | 6.41M/28.6M [00:00&lt;00:02, 9.18M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  28%|▊  | 8.02M/28.6M [00:00&lt;00:02, 9.23M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  34%|█  | 9.64M/28.6M [00:01&lt;00:02, 9.20M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  39%|█▏ | 11.2M/28.6M [00:01&lt;00:01, 9.20M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  45%|█▎ | 12.8M/28.6M [00:01&lt;00:01, 9.24M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  51%|█▌ | 14.5M/28.6M [00:01&lt;00:01, 9.18M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  56%|█▋ | 16.1M/28.6M [00:01&lt;00:01, 9.47M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  61%|█▊ | 17.4M/28.6M [00:01&lt;00:01, 10.2M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  67%|██ | 19.3M/28.6M [00:02&lt;00:01, 8.89M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  73%|██▏| 20.9M/28.6M [00:02&lt;00:00, 9.63M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  77%|██▎| 22.0M/28.6M [00:02&lt;00:00, 9.89M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  84%|██▌| 24.2M/28.6M [00:02&lt;00:00, 8.76M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  90%|██▋| 25.8M/28.6M [00:02&lt;00:00, 9.92M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  96%|██▊| 27.4M/28.6M [00:02&lt;00:00, 8.72M Bytes/s]
Total:  73%|████████████████████▍       | 452M/618M [00:52&lt;00:19, 8.62M Bytes/s]
Get sub-08/f .. _bold.nii.gz:   0%|            | 0.00/28.6M [00:00&lt;?, ? Bytes/s]
Get sub-08/f .. _bold.nii.gz:   6%|▏  | 1.62M/28.6M [00:00&lt;00:02, 9.31M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  11%|▎  | 3.24M/28.6M [00:00&lt;00:02, 9.30M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  17%|▌  | 4.86M/28.6M [00:00&lt;00:02, 9.29M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  23%|▋  | 6.50M/28.6M [00:00&lt;00:02, 9.28M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  28%|▊  | 7.99M/28.6M [00:00&lt;00:01, 10.6M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  34%|█  | 9.76M/28.6M [00:01&lt;00:02, 9.03M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  40%|█▏ | 11.4M/28.6M [00:01&lt;00:01, 9.21M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  46%|█▎ | 13.1M/28.6M [00:01&lt;00:01, 9.21M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  51%|█▌ | 14.7M/28.6M [00:01&lt;00:01, 9.25M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  57%|█▋ | 16.3M/28.6M [00:01&lt;00:01, 9.81M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  61%|█▊ | 17.5M/28.6M [00:01&lt;00:01, 10.2M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  69%|██ | 19.7M/28.6M [00:02&lt;00:00, 9.08M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  75%|██▏| 21.3M/28.6M [00:02&lt;00:00, 10.1M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  80%|██▍| 23.0M/28.6M [00:02&lt;00:00, 9.12M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  86%|██▌| 24.7M/28.6M [00:02&lt;00:00, 9.28M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  92%|██▊| 26.4M/28.6M [00:02&lt;00:00, 9.39M Bytes/s]
Get sub-08/f .. _bold.nii.gz:  98%|██▉| 28.1M/28.6M [00:02&lt;00:00, 9.53M Bytes/s]
Total:  78%|█████████████████████▊      | 481M/618M [00:55&lt;00:15, 8.61M Bytes/s]
Get sub-06/a .. 6_T1w.nii.gz:   0%|            | 0.00/10.6M [00:00&lt;?, ? Bytes/s]
Get sub-06/a .. 6_T1w.nii.gz:  16%|▍  | 1.67M/10.6M [00:00&lt;00:00, 9.64M Bytes/s]
Get sub-06/a .. 6_T1w.nii.gz:  32%|▉  | 3.39M/10.6M [00:00&lt;00:00, 9.76M Bytes/s]
Get sub-06/a .. 6_T1w.nii.gz:  48%|█▍ | 5.13M/10.6M [00:00&lt;00:00, 9.84M Bytes/s]
Get sub-06/a .. 6_T1w.nii.gz:  65%|█▉ | 6.87M/10.6M [00:00&lt;00:00, 10.1M Bytes/s]
Get sub-06/a .. 6_T1w.nii.gz:  81%|██▍| 8.64M/10.6M [00:00&lt;00:00, 9.93M Bytes/s]
Get sub-06/a .. 6_T1w.nii.gz:  98%|██▉| 10.4M/10.6M [00:01&lt;00:00, 9.99M Bytes/s]
                                                                                
Get sub-06/f .. _bold.nii.gz:   0%|            | 0.00/29.4M [00:00&lt;?, ? Bytes/s]
Get sub-06/f .. _bold.nii.gz:   6%|▏  | 1.76M/29.4M [00:00&lt;00:02, 10.1M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  12%|▎  | 3.57M/29.4M [00:00&lt;00:02, 10.3M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  18%|▌  | 5.39M/29.4M [00:00&lt;00:02, 10.3M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  26%|▊  | 7.76M/29.4M [00:00&lt;00:01, 11.0M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  31%|▉  | 8.98M/29.4M [00:01&lt;00:02, 7.39M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  38%|█▏ | 11.1M/29.4M [00:01&lt;00:01, 9.85M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  44%|█▎ | 12.8M/29.4M [00:01&lt;00:01, 8.71M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  48%|█▍ | 14.2M/29.4M [00:01&lt;00:01, 8.39M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  53%|█▌ | 15.5M/29.4M [00:01&lt;00:01, 8.28M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  58%|█▋ | 16.9M/29.4M [00:01&lt;00:01, 8.22M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  63%|█▉ | 18.4M/29.4M [00:02&lt;00:01, 8.20M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  67%|██ | 19.8M/29.4M [00:02&lt;00:01, 8.36M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  73%|██▏| 21.3M/29.4M [00:02&lt;00:00, 8.27M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  78%|██▎| 22.8M/29.4M [00:02&lt;00:00, 8.36M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  83%|██▍| 24.3M/29.4M [00:02&lt;00:00, 8.97M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  87%|██▌| 25.7M/29.4M [00:02&lt;00:00, 9.91M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  93%|██▊| 27.5M/29.4M [00:03&lt;00:00, 8.25M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  99%|██▉| 29.0M/29.4M [00:03&lt;00:00, 9.32M Bytes/s]
Total:  84%|███████████████████████▌    | 521M/618M [01:00&lt;00:11, 8.55M Bytes/s]
Get sub-06/f .. _bold.nii.gz:   0%|            | 0.00/29.4M [00:00&lt;?, ? Bytes/s]
Get sub-06/f .. _bold.nii.gz:   5%|▏  | 1.60M/29.4M [00:00&lt;00:03, 9.19M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  11%|▎  | 3.23M/29.4M [00:00&lt;00:02, 9.25M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  17%|▍  | 4.86M/29.4M [00:00&lt;00:02, 9.31M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  22%|▋  | 6.52M/29.4M [00:00&lt;00:02, 9.37M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  28%|▊  | 8.19M/29.4M [00:00&lt;00:02, 9.44M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  34%|█  | 9.87M/29.4M [00:01&lt;00:02, 9.50M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  39%|█▏ | 11.6M/29.4M [00:01&lt;00:01, 9.65M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  45%|█▎ | 13.3M/29.4M [00:01&lt;00:01, 9.64M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  51%|█▌ | 15.0M/29.4M [00:01&lt;00:01, 9.70M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  57%|█▋ | 16.7M/29.4M [00:01&lt;00:01, 10.2M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  62%|█▊ | 18.1M/29.4M [00:01&lt;00:01, 11.0M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  69%|██ | 20.2M/29.4M [00:02&lt;00:00, 9.49M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  75%|██▏| 22.0M/29.4M [00:02&lt;00:00, 10.6M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  81%|██▍| 23.8M/29.4M [00:02&lt;00:00, 9.58M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  87%|██▌| 25.6M/29.4M [00:02&lt;00:00, 9.74M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  93%|██▊| 27.4M/29.4M [00:02&lt;00:00, 9.93M Bytes/s]
Get sub-06/f .. _bold.nii.gz:  99%|██▉| 29.2M/29.4M [00:02&lt;00:00, 10.0M Bytes/s]
                                                                                
Get sub-03/a .. 3_T1w.nii.gz:   0%|            | 0.00/10.7M [00:00&lt;?, ? Bytes/s]
Get sub-03/a .. 3_T1w.nii.gz:  17%|▍  | 1.78M/10.7M [00:00&lt;00:00, 10.6M Bytes/s]
Get sub-03/a .. 3_T1w.nii.gz:  34%|█  | 3.61M/10.7M [00:00&lt;00:00, 10.3M Bytes/s]
Get sub-03/a .. 3_T1w.nii.gz:  51%|█▌ | 5.42M/10.7M [00:00&lt;00:00, 10.3M Bytes/s]
Get sub-03/a .. 3_T1w.nii.gz:  68%|██ | 7.24M/10.7M [00:00&lt;00:00, 11.1M Bytes/s]
Get sub-03/a .. 3_T1w.nii.gz:  82%|██▍| 8.73M/10.7M [00:00&lt;00:00, 12.0M Bytes/s]
Total:  91%|█████████████████████████▍  | 561M/618M [01:05&lt;00:06, 8.55M Bytes/s]
Get sub-03/f .. _bold.nii.gz:   0%|            | 0.00/28.8M [00:00&lt;?, ? Bytes/s]
Get sub-03/f .. _bold.nii.gz:   6%|▏  | 1.81M/28.8M [00:00&lt;00:02, 10.4M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  13%|▍  | 3.66M/28.8M [00:00&lt;00:02, 10.5M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  19%|▌  | 5.49M/28.8M [00:00&lt;00:02, 10.5M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  26%|▊  | 7.35M/28.8M [00:00&lt;00:02, 10.3M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  32%|▉  | 9.20M/28.8M [00:00&lt;00:01, 10.4M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  38%|█▏ | 10.9M/28.8M [00:01&lt;00:01, 10.1M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  45%|█▎ | 13.0M/28.8M [00:01&lt;00:01, 8.31M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  50%|█▍ | 14.3M/28.8M [00:01&lt;00:01, 8.07M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  54%|█▋ | 15.6M/28.8M [00:01&lt;00:01, 8.09M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  59%|█▊ | 17.0M/28.8M [00:01&lt;00:01, 7.85M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  64%|█▉ | 18.4M/28.8M [00:02&lt;00:01, 7.84M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  69%|██ | 19.7M/28.8M [00:02&lt;00:01, 8.30M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  73%|██▏| 21.1M/28.8M [00:02&lt;00:00, 9.37M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  78%|██▎| 22.5M/28.8M [00:02&lt;00:00, 7.43M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  83%|██▍| 23.9M/28.8M [00:02&lt;00:00, 8.40M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  88%|██▋| 25.4M/28.8M [00:02&lt;00:00, 7.57M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  93%|██▊| 26.8M/28.8M [00:03&lt;00:00, 7.77M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  98%|██▉| 28.3M/28.8M [00:03&lt;00:00, 7.92M Bytes/s]
                                                                                
Get sub-03/f .. _bold.nii.gz:   0%|            | 0.00/28.8M [00:00&lt;?, ? Bytes/s]
Get sub-03/f .. _bold.nii.gz:   5%|▏  | 1.45M/28.8M [00:00&lt;00:03, 8.35M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  10%|▎  | 2.93M/28.8M [00:00&lt;00:03, 8.40M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  15%|▍  | 4.40M/28.8M [00:00&lt;00:02, 8.43M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  20%|▌  | 5.89M/28.8M [00:00&lt;00:02, 8.47M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  26%|▊  | 7.40M/28.8M [00:00&lt;00:02, 8.51M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  31%|▉  | 8.91M/28.8M [00:01&lt;00:02, 8.53M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  36%|█  | 10.4M/28.8M [00:01&lt;00:02, 8.61M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  41%|█▏ | 11.9M/28.8M [00:01&lt;00:01, 8.63M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  47%|█▍ | 13.5M/28.8M [00:01&lt;00:01, 8.66M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  52%|█▌ | 15.0M/28.8M [00:01&lt;00:01, 8.69M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  57%|█▋ | 16.5M/28.8M [00:01&lt;00:01, 8.73M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  63%|█▉ | 18.1M/28.8M [00:02&lt;00:01, 8.76M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  68%|██ | 19.6M/28.8M [00:02&lt;00:01, 8.86M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  74%|██▏| 21.2M/28.8M [00:02&lt;00:00, 8.80M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  79%|██▎| 22.7M/28.8M [00:02&lt;00:00, 8.82M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  84%|██▌| 24.3M/28.8M [00:02&lt;00:00, 9.32M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  88%|██▋| 25.3M/28.8M [00:02&lt;00:00, 9.45M Bytes/s]
Get sub-03/f .. _bold.nii.gz:  95%|██▊| 27.4M/28.8M [00:03&lt;00:00, 8.65M Bytes/s]
                                                                                
Get sub-03/f .. _bold.nii.gz:   0%|            | 0.00/28.8M [00:00&lt;?, ? Bytes/s]
<span class=" -Color -Color-Bold">get</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): sub-07/anat/sub-07_T1w.nii.gz (<span class=" -Color -Color-Bold -Color-Bold-Magenta">file</span>) [from s3-PUBLIC...]
<span class=" -Color -Color-Bold">get</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): sub-07/func/sub-07_task-flanker_run-1_bold.nii.gz (<span class=" -Color -Color-Bold -Color-Bold-Magenta">file</span>) [from s3-PUBLIC...]
<span class=" -Color -Color-Bold">get</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): sub-07/func/sub-07_task-flanker_run-2_bold.nii.gz (<span class=" -Color -Color-Bold -Color-Bold-Magenta">file</span>) [from s3-PUBLIC...]
<span class=" -Color -Color-Bold">get</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): sub-02/anat/sub-02_T1w.nii.gz (<span class=" -Color -Color-Bold -Color-Bold-Magenta">file</span>) [from s3-PUBLIC...]
<span class=" -Color -Color-Bold">get</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): sub-02/func/sub-02_task-flanker_run-1_bold.nii.gz (<span class=" -Color -Color-Bold -Color-Bold-Magenta">file</span>) [from s3-PUBLIC...]
<span class=" -Color -Color-Bold">get</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): sub-02/func/sub-02_task-flanker_run-2_bold.nii.gz (<span class=" -Color -Color-Bold -Color-Bold-Magenta">file</span>) [from s3-PUBLIC...]
<span class=" -Color -Color-Bold">get</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): sub-05/anat/sub-05_T1w.nii.gz (<span class=" -Color -Color-Bold -Color-Bold-Magenta">file</span>) [from s3-PUBLIC...]
<span class=" -Color -Color-Bold">get</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): sub-05/func/sub-05_task-flanker_run-1_bold.nii.gz (<span class=" -Color -Color-Bold -Color-Bold-Magenta">file</span>) [from s3-PUBLIC...]
<span class=" -Color -Color-Bold">get</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): sub-05/func/sub-05_task-flanker_run-2_bold.nii.gz (<span class=" -Color -Color-Bold -Color-Bold-Magenta">file</span>) [from s3-PUBLIC...]
<span class=" -Color -Color-Bold">get</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): sub-09/anat/sub-09_T1w.nii.gz (<span class=" -Color -Color-Bold -Color-Bold-Magenta">file</span>) [from s3-PUBLIC...]
  [17 similar messages have been suppressed; disable with datalad.ui.suppress-similar-results=off]
<span class=" -Color -Color-Bold">get</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): sub-07 (<span class=" -Color -Color-Bold -Color-Bold-Magenta">directory</span>)
<span class=" -Color -Color-Bold">get</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): sub-02 (<span class=" -Color -Color-Bold -Color-Bold-Magenta">directory</span>)
<span class=" -Color -Color-Bold">get</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): sub-05 (<span class=" -Color -Color-Bold -Color-Bold-Magenta">directory</span>)
<span class=" -Color -Color-Bold">get</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): sub-09 (<span class=" -Color -Color-Bold -Color-Bold-Magenta">directory</span>)
<span class=" -Color -Color-Bold">get</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): sub-04 (<span class=" -Color -Color-Bold -Color-Bold-Magenta">directory</span>)
<span class=" -Color -Color-Bold">get</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): sub-01 (<span class=" -Color -Color-Bold -Color-Bold-Magenta">directory</span>)
<span class=" -Color -Color-Bold">get</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): sub-08 (<span class=" -Color -Color-Bold -Color-Bold-Magenta">directory</span>)
<span class=" -Color -Color-Bold">get</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): sub-06 (<span class=" -Color -Color-Bold -Color-Bold-Magenta">directory</span>)
<span class=" -Color -Color-Bold">get</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): sub-03 (<span class=" -Color -Color-Bold -Color-Bold-Magenta">directory</span>)
action summary:
  get (ok: 36)

</pre></div>
</div>
</div>
</div>
</section>
<section id="start-the-workflow">
<h3>Start the workflow<a class="headerlink" href="#start-the-workflow" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wf_first</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;level1&#39;</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="n">exp_dir_first</span><span class="p">)</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;execution&quot;</span><span class="p">][</span><span class="s2">&quot;crashfile_format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;txt&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>The following two nodes (<code class="docutils literal notranslate"><span class="pre">infosource</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">dg</span></code>) together define all inputs required for the preprocessing workflow</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get subject_id list - we only do 9 subjects here so the notebook runs in a reasonable time</span>
<span class="n">subj_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="n">data_dir_first</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">PATTERN</span><span class="p">)]</span>
<span class="n">subj_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">subj_list</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;01&#39;, &#39;02&#39;, &#39;03&#39;, &#39;04&#39;, &#39;05&#39;, &#39;06&#39;, &#39;07&#39;, &#39;08&#39;, &#39;09&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">infosource_first</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">]),</span>
                  <span class="n">name</span><span class="o">=</span><span class="s2">&quot;infosource&quot;</span><span class="p">)</span>
<span class="n">infosource_first</span><span class="o">.</span><span class="n">iterables</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;subject_id&quot;</span><span class="p">,</span> <span class="n">subj_list</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dg_first</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">nio</span><span class="o">.</span><span class="n">DataGrabber</span><span class="p">(</span>
        <span class="n">infields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">,</span><span class="s2">&quot;run_id&quot;</span><span class="p">],</span> <span class="n">outfields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;struct&quot;</span><span class="p">,</span> <span class="s2">&quot;func&quot;</span><span class="p">,</span> <span class="s2">&quot;events&quot;</span><span class="p">]</span>
    <span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;dg_first&quot;</span>
<span class="p">)</span>

<span class="c1"># Specify run_ids and return a sorted filelist to ensure we match files to correct runs/tasks</span>
<span class="n">dg_first</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">run_id</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
<span class="n">dg_first</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">sort_filelist</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">dg_first</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span>
<span class="n">dg_first</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">base_directory</span> <span class="o">=</span> <span class="n">data_dir_first</span>

<span class="c1"># Define arguments fill the wildcards in the below paths </span>
<span class="n">dg_first</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">template_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">struct</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">,</span><span class="s2">&quot;subject_id&quot;</span><span class="p">]],</span>
    <span class="n">func</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">,</span><span class="s2">&quot;subject_id&quot;</span><span class="p">,</span><span class="s2">&quot;run_id&quot;</span><span class="p">]],</span>
    <span class="n">events</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">,</span><span class="s2">&quot;subject_id&quot;</span><span class="p">,</span><span class="s2">&quot;run_id&quot;</span><span class="p">]]</span>
<span class="p">)</span>

<span class="n">dg_first</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">field_template</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">struct</span> <span class="o">=</span> <span class="s2">&quot;sub-</span><span class="si">%s</span><span class="s2">/anat/sub-</span><span class="si">%s</span><span class="s2">_T1w.nii.gz&quot;</span><span class="p">,</span>
    <span class="n">func</span><span class="o">=</span><span class="s2">&quot;sub-</span><span class="si">%s</span><span class="s2">/func/sub-</span><span class="si">%s</span><span class="s2">_task-flanker_run-</span><span class="si">%d</span><span class="s2">_bold.nii.gz&quot;</span><span class="p">,</span>
    <span class="n">events</span><span class="o">=</span><span class="s2">&quot;sub-</span><span class="si">%s</span><span class="s2">/func/sub-</span><span class="si">%s</span><span class="s2">_task-flanker_run-</span><span class="si">%d</span><span class="s2">_events.tsv&quot;</span><span class="p">,</span> 
<span class="p">)</span>

<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
        <span class="p">(</span><span class="n">infosource_first</span><span class="p">,</span> <span class="n">dg_first</span><span class="p">,</span> <span class="p">[(</span><span class="s2">&quot;subject_id&quot;</span><span class="p">,</span> <span class="s2">&quot;subject_id&quot;</span><span class="p">)])</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="initialisation">
<h2>Initialisation<a class="headerlink" href="#initialisation" title="Link to this heading">#</a></h2>
<p>Convert functional images to float representation. Since there can be more than one functional run we use a MapNode to convert each run.</p>
<p><strong>Corresponding FSL command:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fslmaths</span> <span class="o">../</span><span class="n">sub</span><span class="o">-</span><span class="mi">11</span><span class="o">/</span><span class="n">func</span><span class="o">/</span><span class="n">sub</span><span class="o">-</span><span class="mi">11</span><span class="n">_task</span><span class="o">-</span><span class="n">flanker_run</span><span class="o">-</span><span class="mi">1</span><span class="n">_bold</span> <span class="n">prefiltered_func_data</span> <span class="o">-</span><span class="n">odt</span> <span class="nb">float</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">img2float</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">out_data_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="n">op_string</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_dtype&#39;</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;img2float&#39;</span><span class="p">,</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">])</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dg_first</span><span class="p">,</span> <span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="n">img2float</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Extract the middle volume of the first run as the reference</p>
<p>(Head movement, motion-correction)</p>
<p><strong>Corresponding FSL command:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fslroi</span> <span class="n">prefiltered_func_data</span> <span class="n">example_func</span> <span class="mi">73</span> <span class="mi">1</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract one roi</span>
<span class="n">extract_ref</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ExtractROI</span><span class="p">(</span><span class="n">t_size</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> 
                         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;extractref&#39;</span><span class="p">,</span>
                         <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">])</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">img2float</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">extract_ref</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

<span class="c1"># Define a function to return the 1 based index of the middle volume</span>
<span class="k">def</span><span class="w"> </span><span class="nf">getmiddlevolume</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">nibabel</span><span class="w"> </span><span class="kn">import</span> <span class="n">load</span>
    <span class="n">funcfile</span> <span class="o">=</span> <span class="n">func</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">funcfile</span> <span class="o">=</span> <span class="n">func</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">timepoints</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">funcfile</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">timepoints</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> 

<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">img2float</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">getmiddlevolume</span><span class="p">),</span> <span class="n">extract_ref</span><span class="p">,</span> <span class="s1">&#39;t_min&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="preprocessing">
<h2>Preprocessing<a class="headerlink" href="#preprocessing" title="Link to this heading">#</a></h2>
<section id="motion-correction">
<h3>Motion Correction<a class="headerlink" href="#motion-correction" title="Link to this heading">#</a></h3>
<p>Realign the functional runs to the middle volume of each run</p>
<p><strong>Corresponding FSL command:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">mcflirt</span> <span class="o">-</span><span class="ow">in</span> <span class="n">prefiltered_func_data</span> <span class="o">-</span><span class="n">out</span> <span class="n">prefiltered_func_data_mcf</span> <span class="o">-</span><span class="n">mats</span> <span class="o">-</span><span class="n">plots</span> <span class="o">-</span><span class="n">reffile</span> <span class="n">example_func</span> <span class="o">-</span><span class="n">rmsrel</span> <span class="o">-</span><span class="n">rmsabs</span> <span class="o">-</span><span class="n">spline_final</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>save_mats (a boolean) – Save transformation matrices. Maps to a command-line argument: -mats.
save_plots (a boolean) – Save transformation parameters. Maps to a command-line argument: -plots.
save_rms (a boolean) – Save rms displacement parameters. Maps to a command-line argument: -rmsabs -rmsrel.
Interpolation (‘spline’ or ‘nn’ or ‘sinc’) – Interpolation method for transformation. Maps to a command-line argument: -%s_final.
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">motion_correct</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">MCFLIRT</span><span class="p">(</span><span class="n">save_mats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_rms</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;spline&#39;</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;realign&#39;</span><span class="p">,</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">,</span><span class="s1">&#39;ref_file&#39;</span><span class="p">])</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">img2float</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">motion_correct</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">extract_ref</span><span class="p">,</span> <span class="s1">&#39;roi_file&#39;</span><span class="p">,</span> <span class="n">motion_correct</span><span class="p">,</span> <span class="s1">&#39;ref_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Plot the estimated motion parameters</p>
<p><strong>Corresponding FSL command:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fsl_tsplot</span> <span class="o">-</span><span class="n">i</span> <span class="n">prefiltered_func_data_mcf</span><span class="o">.</span><span class="n">par</span> <span class="o">-</span><span class="n">t</span> <span class="s1">&#39;MCFLIRT estimated rotations (radians)&#39;</span> <span class="o">-</span><span class="n">u</span> <span class="mi">1</span> <span class="o">--</span><span class="n">start</span><span class="o">=</span><span class="mi">1</span> <span class="o">--</span><span class="n">finish</span><span class="o">=</span><span class="mi">3</span> <span class="o">-</span><span class="n">a</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="o">-</span><span class="n">w</span> <span class="mi">640</span> <span class="o">-</span><span class="n">h</span> <span class="mi">144</span> <span class="o">-</span><span class="n">o</span> <span class="n">rot</span><span class="o">.</span><span class="n">png</span> 

<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fsl_tsplot</span> <span class="o">-</span><span class="n">i</span> <span class="n">prefiltered_func_data_mcf</span><span class="o">.</span><span class="n">par</span> <span class="o">-</span><span class="n">t</span> <span class="s1">&#39;MCFLIRT estimated translations (mm)&#39;</span> <span class="o">-</span><span class="n">u</span> <span class="mi">1</span> <span class="o">--</span><span class="n">start</span><span class="o">=</span><span class="mi">4</span> <span class="o">--</span><span class="n">finish</span><span class="o">=</span><span class="mi">6</span> <span class="o">-</span><span class="n">a</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="o">-</span><span class="n">w</span> <span class="mi">640</span> <span class="o">-</span><span class="n">h</span> <span class="mi">144</span> <span class="o">-</span><span class="n">o</span> <span class="n">trans</span><span class="o">.</span><span class="n">png</span> 

<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fsl_tsplot</span> <span class="o">-</span><span class="n">i</span> <span class="n">prefiltered_func_data_mcf_abs</span><span class="o">.</span><span class="n">rms</span><span class="p">,</span><span class="n">prefiltered_func_data_mcf_rel</span><span class="o">.</span><span class="n">rms</span> <span class="o">-</span><span class="n">t</span> <span class="s1">&#39;MCFLIRT estimated mean displacement (mm)&#39;</span> <span class="o">-</span><span class="n">u</span> <span class="mi">1</span> <span class="o">-</span><span class="n">w</span> <span class="mi">640</span> <span class="o">-</span><span class="n">h</span> <span class="mi">144</span> <span class="o">-</span><span class="n">a</span> <span class="n">absolute</span><span class="p">,</span><span class="n">relative</span> <span class="o">-</span><span class="n">o</span> <span class="n">disp</span><span class="o">.</span><span class="n">png</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_motion</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">PlotMotionParams</span><span class="p">(</span><span class="n">in_source</span><span class="o">=</span><span class="s1">&#39;fsl&#39;</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;plot_motion&#39;</span><span class="p">,</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">])</span>
<span class="n">plot_motion</span><span class="o">.</span><span class="n">iterables</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;plot_type&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;rotations&#39;</span><span class="p">,</span> <span class="s1">&#39;translations&#39;</span><span class="p">,</span><span class="s1">&#39;displacement&#39;</span><span class="p">])</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">motion_correct</span><span class="p">,</span> <span class="s1">&#39;par_file&#39;</span><span class="p">,</span> <span class="n">plot_motion</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="functionally-masking">
<h3>Functionally Masking<a class="headerlink" href="#functionally-masking" title="Link to this heading">#</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Passing</span> <span class="n">the</span> <span class="n">reference</span> <span class="n">volume</span> <span class="n">to</span> <span class="n">the</span> <span class="n">FSL</span> <span class="n">command</span><span class="o">-</span><span class="n">line</span> <span class="n">tool</span> <span class="n">bet</span> <span class="n">to</span> <span class="n">generate</span> <span class="n">a</span> <span class="n">binary</span> <span class="n">brain</span> <span class="n">mask</span> <span class="ow">and</span> <span class="n">afterward</span> <span class="n">multiplying</span> <span class="n">the</span> <span class="n">processed</span> <span class="n">functional</span> <span class="n">time</span> <span class="n">series</span> <span class="n">by</span> <span class="n">the</span> <span class="n">brain</span> <span class="n">mask</span> <span class="n">using</span> <span class="n">the</span> <span class="n">fslmaths</span> <span class="n">command</span> <span class="n">to</span> <span class="n">produce</span> <span class="n">a</span> <span class="n">skull</span><span class="o">-</span><span class="n">stripped</span> <span class="n">time</span> <span class="n">series</span><span class="o">.</span>
</pre></div>
</div>
<p>See <a class="reference external" href="https://www.nature.com/articles/s41596-018-0065-y">Ciric et al.(2018)</a></p>
<p>Extract the mean volume of each functional run</p>
<p><strong>Corresponding FSL command:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fslmaths</span> <span class="n">prefiltered_func_data_mcf</span> <span class="o">-</span><span class="n">Tmean</span> <span class="n">mean_func</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">meanfunc</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">op_string</span><span class="o">=</span><span class="s1">&#39;-Tmean&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_mean&#39;</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;meanfunc&#39;</span><span class="p">,</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">])</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">motion_correct</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">meanfunc</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Strip the skull from the mean functional to generate a mask</p>
<p><strong>Corresponding FSL command:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bet2</span> <span class="n">mean_func</span> <span class="n">mask</span> <span class="o">-</span><span class="n">f</span> <span class="mf">0.3</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">m</span><span class="p">;</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">immv</span> <span class="n">mask_mask</span> <span class="n">mask</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">meanfuncmask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">BET</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">no_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.3</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;meanfuncmask&#39;</span><span class="p">,</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">])</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">meanfunc</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">meanfuncmask</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Mask the functional data with the extracted mask</p>
<p><strong>Corresponding FSL command:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fslmaths</span> <span class="n">prefiltered_func_data_mcf</span> <span class="o">-</span><span class="n">mas</span> <span class="n">mask</span> <span class="n">prefiltered_func_data_bet</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">maskfunc</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_bet&#39;</span><span class="p">,</span> <span class="n">op_string</span><span class="o">=</span><span class="s1">&#39;-mas&#39;</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;maskfunc&#39;</span><span class="p">,</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">,</span><span class="s1">&#39;in_file2&#39;</span><span class="p">])</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">motion_correct</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">maskfunc</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">meanfuncmask</span><span class="p">,</span> <span class="s1">&#39;mask_file&#39;</span><span class="p">,</span> <span class="n">maskfunc</span><span class="p">,</span> <span class="s1">&#39;in_file2&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="grand-mean-scaling">
<h3>Grand Mean Scaling<a class="headerlink" href="#grand-mean-scaling" title="Link to this heading">#</a></h3>
<p>Determine the 2nd and 98th percentile intensities</p>
<p><strong>Corresponding FSL command:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fslstats</span> <span class="n">prefiltered_func_data_bet</span> <span class="o">-</span><span class="n">p</span> <span class="mi">2</span> <span class="o">-</span><span class="n">p</span> <span class="mi">98</span>
<span class="mf">0.000000</span> <span class="mf">873.492249</span> <span class="p">(</span><span class="n">these</span> <span class="n">numbers</span> <span class="n">are</span> <span class="k">for</span> <span class="n">subject</span><span class="o">-</span><span class="mi">11</span> <span class="n">run</span><span class="o">-</span><span class="mi">01</span><span class="p">)</span>
</pre></div>
</div>
<p>More info <a class="reference external" href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/Fslutils">here</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">getthresh</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageStats</span><span class="p">(</span><span class="n">op_string</span><span class="o">=</span><span class="s1">&#39;-p 2 -p 98&#39;</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;getthreshold&#39;</span><span class="p">,</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">])</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">maskfunc</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">getthresh</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Threshold the first TR of the functional data at 10% of the 98th percentile</p>
<p><strong>Corresponding FSL command:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fslmaths</span> <span class="n">prefiltered_func_data_bet</span> <span class="o">-</span><span class="n">thr</span> <span class="mf">87.3492249</span> <span class="o">-</span><span class="n">Tmin</span> <span class="o">-</span><span class="nb">bin</span> <span class="n">mask</span> <span class="o">-</span><span class="n">odt</span> <span class="n">char</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">threshold</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">out_data_type</span><span class="o">=</span><span class="s1">&#39;char&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_thresh&#39;</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;threshold&#39;</span><span class="p">,</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">,</span><span class="s1">&#39;op_string&#39;</span><span class="p">])</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">maskfunc</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

<span class="c1"># Define a function to get 10% of the intensity</span>
<span class="k">def</span><span class="w"> </span><span class="nf">getthreshop</span><span class="p">(</span><span class="n">thresh</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;-thr </span><span class="si">%.10f</span><span class="s1"> -Tmin -bin&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">th</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="n">thresh</span><span class="p">]</span>

<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">getthresh</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;out_stat&#39;</span><span class="p">,</span> <span class="n">getthreshop</span><span class="p">),</span> <span class="n">threshold</span><span class="p">,</span> <span class="s1">&#39;op_string&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Determine the median value of the TRs using the mask</p>
<p><strong>Corresponding FSL command:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fslstats</span> <span class="n">prefiltered_func_data_mcf</span> <span class="o">-</span><span class="n">k</span> <span class="n">mask</span> <span class="o">-</span><span class="n">p</span> <span class="mi">50</span>
<span class="mf">728.800232</span> <span class="p">(</span><span class="n">this</span> <span class="n">number</span> <span class="ow">is</span> <span class="k">for</span> <span class="n">subject</span><span class="o">-</span><span class="mi">11</span> <span class="n">run</span><span class="o">-</span><span class="mi">01</span><span class="p">)</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">medianval</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageStats</span><span class="p">(</span><span class="n">op_string</span><span class="o">=</span><span class="s1">&#39;-k </span><span class="si">%s</span><span class="s1"> -p 50&#39;</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;medianval&#39;</span><span class="p">,</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">,</span><span class="s1">&#39;mask_file&#39;</span><span class="p">])</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">motion_correct</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">medianval</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">medianval</span><span class="p">,</span> <span class="s1">&#39;mask_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Dilate the mask</p>
<p>The brain mask is “dilated” slightly before being used. Because it is normally important that masking be liberal (ie that there be little risk of cutting out valid brain voxels)</p>
<p><strong>Corresponding FSL command:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fslmaths</span> <span class="n">mask</span> <span class="o">-</span><span class="n">dilF</span> <span class="n">mask</span>
</pre></div>
</div>
<p>The output of <code class="docutils literal notranslate"><span class="pre">dilatemask</span></code> (i.e., <code class="docutils literal notranslate"><span class="pre">/srv/scratch/yc/fsl/hw2/level1/_subject_id_26/dilatemask/mapflow/_dilatemask0/sub-26_task-flanker_run-1_bold_dtype_mcf_bet_thresh_dil.nii.gz</span></code>) is equivalent to <code class="docutils literal notranslate"><span class="pre">mask.nii.gz</span></code> from FSL GUI.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dilatemask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_dil&#39;</span><span class="p">,</span> <span class="n">op_string</span><span class="o">=</span><span class="s1">&#39;-dilF&#39;</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dilatemask&#39;</span><span class="p">,</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">])</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">dilatemask</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Mask the motion corrected functional runs with the dilated mask</p>
<p><strong>Corresponding FSL command:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fslmaths</span> <span class="n">prefiltered_func_data_mcf</span> <span class="o">-</span><span class="n">mas</span> <span class="n">mask</span> <span class="n">prefiltered_func_data_thresh</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">maskfunc2</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_thresh&#39;</span><span class="p">,</span> <span class="n">op_string</span><span class="o">=</span><span class="s1">&#39;-mas&#39;</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">,</span><span class="s1">&#39;in_file2&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;maskfunc2&#39;</span><span class="p">)</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">motion_correct</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">maskfunc2</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dilatemask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">maskfunc2</span><span class="p">,</span> <span class="s1">&#39;in_file2&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="susan-noise-reduction">
<h3>SUSAN Noise Reduction<a class="headerlink" href="#susan-noise-reduction" title="Link to this heading">#</a></h3>
<p>Determine the mean image from each TR</p>
<p><strong>Corresponding FSL command:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fslmaths</span> <span class="n">prefiltered_func_data_thresh</span> <span class="o">-</span><span class="n">Tmean</span> <span class="n">mean_func</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">meanfunc2</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">op_string</span><span class="o">=</span><span class="s1">&#39;-Tmean&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_mean&#39;</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;meanfunc2&#39;</span><span class="p">,</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">])</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">maskfunc2</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">meanfunc2</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Merge the median values with the mean functional images into a coupled list</p>
<p>The output of this <code class="docutils literal notranslate"><span class="pre">merge</span></code> node will go into <code class="docutils literal notranslate"><span class="pre">susan</span></code> as <code class="docutils literal notranslate"><span class="pre">usans</span></code>,</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># why here use node not mapnode?</span>
<span class="n">mergenode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">util</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;hstack&#39;</span><span class="p">),</span> 
                       <span class="n">name</span><span class="o">=</span><span class="s1">&#39;merge&#39;</span><span class="p">)</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">meanfunc2</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">mergenode</span><span class="p">,</span> <span class="s1">&#39;in1&#39;</span><span class="p">)</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">medianval</span><span class="p">,</span> <span class="s1">&#39;out_stat&#39;</span><span class="p">,</span> <span class="n">mergenode</span><span class="p">,</span> <span class="s1">&#39;in2&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Smooth each run using SUSAN with the brightness threshold set to 75% of the median value for each run and a mask constituting the mean functional</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Usage</span><span class="p">:</span> <span class="n">susan</span> <span class="o">&lt;</span><span class="nb">input</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">bt</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">dt</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">dim</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">use_median</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">n_usans</span><span class="o">&gt;</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">usan1</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">bt1</span><span class="o">&gt;</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">usan2</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">bt2</span><span class="o">&gt;</span><span class="p">]]</span> <span class="o">&lt;</span><span class="n">output</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">bt</span><span class="o">&gt;</span> <span class="ow">is</span> <span class="n">brightness</span> <span class="n">threshold</span> <span class="ow">and</span> <span class="n">should</span> <span class="n">be</span> <span class="n">greater</span> <span class="n">than</span> <span class="n">noise</span> <span class="n">level</span> <span class="ow">and</span> <span class="n">less</span> <span class="n">than</span> <span class="n">contrast</span> <span class="n">of</span> <span class="n">edges</span> <span class="n">to</span> <span class="n">be</span> <span class="n">preserved</span><span class="o">.</span>
<span class="o">&lt;</span><span class="n">dt</span><span class="o">&gt;</span> <span class="ow">is</span> <span class="n">spatial</span> <span class="n">size</span> <span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="p">,</span> <span class="n">half</span><span class="o">-</span><span class="n">width</span><span class="p">)</span> <span class="n">of</span> <span class="n">smoothing</span><span class="p">,</span> <span class="ow">in</span> <span class="n">mm</span><span class="o">.</span>
<span class="o">&lt;</span><span class="n">dim</span><span class="o">&gt;</span> <span class="ow">is</span> <span class="n">dimensionality</span> <span class="p">(</span><span class="mi">2</span> <span class="ow">or</span> <span class="mi">3</span><span class="p">),</span> <span class="n">depending</span> <span class="n">on</span> <span class="n">whether</span> <span class="n">smoothing</span> <span class="ow">is</span> <span class="n">to</span> <span class="n">be</span> <span class="n">within</span><span class="o">-</span><span class="n">plane</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">fully</span> <span class="mi">3</span><span class="n">D</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span>
<span class="o">&lt;</span><span class="n">use_median</span><span class="o">&gt;</span> <span class="n">determines</span> <span class="n">whether</span> <span class="n">to</span> <span class="n">use</span> <span class="n">a</span> <span class="n">local</span> <span class="n">median</span> <span class="nb">filter</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">cases</span> <span class="n">where</span> <span class="n">single</span><span class="o">-</span><span class="n">point</span> <span class="n">noise</span> <span class="ow">is</span> <span class="n">detected</span> <span class="p">(</span><span class="mi">0</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span>
<span class="o">&lt;</span><span class="n">n_usans</span><span class="o">&gt;</span> <span class="n">determines</span> <span class="n">whether</span> <span class="n">the</span> <span class="n">smoothing</span> <span class="n">area</span> <span class="p">(</span><span class="n">USAN</span><span class="p">)</span> <span class="ow">is</span> <span class="n">to</span> <span class="n">be</span> <span class="n">found</span> <span class="kn">from</span><span class="w"> </span><span class="nn">secondary</span> <span class="n">images</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="ow">or</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span>
<span class="n">A</span> <span class="n">negative</span> <span class="n">value</span> <span class="k">for</span> <span class="nb">any</span> <span class="n">brightness</span> <span class="n">threshold</span> <span class="n">will</span> <span class="n">auto</span><span class="o">-</span><span class="nb">set</span> <span class="n">the</span> <span class="n">threshold</span> <span class="n">at</span> <span class="mi">10</span><span class="o">%</span> <span class="n">of</span> <span class="n">the</span> <span class="n">robust</span> <span class="nb">range</span>
</pre></div>
</div>
<p><strong>Corresponding FSL command:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">susan</span> <span class="n">prefiltered_func_data_thresh</span> <span class="mf">546.600174</span> <span class="mf">2.12314225053</span> <span class="mi">3</span> <span class="mi">1</span> <span class="mi">1</span> <span class="n">mean_func</span> <span class="mf">546.600174</span> <span class="n">prefiltered_func_data_smooth</span>
</pre></div>
</div>
<p><strong>Note:</strong></p>
<p>for <code class="docutils literal notranslate"><span class="pre">&lt;bt&gt;</span></code>, Nipype uses a different algorithm to calculate it -&gt; <code class="docutils literal notranslate"><span class="pre">float(fwhm)</span> <span class="pre">/</span> <span class="pre">np.sqrt(8</span> <span class="pre">*</span> <span class="pre">np.log(2))</span></code>. Therefore, to get <code class="docutils literal notranslate"><span class="pre">2.12314225053</span></code>, fwhm should be <code class="docutils literal notranslate"><span class="pre">4.9996179300001655</span></code> instead of <code class="docutils literal notranslate"><span class="pre">5</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fwhm_thr</span> <span class="o">=</span> <span class="mf">4.9996179300001655</span>

<span class="n">smooth</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">SUSAN</span><span class="p">(</span><span class="n">fwhm</span> <span class="o">=</span> <span class="n">fwhm_thr</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;smooth&#39;</span><span class="p">,</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">,</span> <span class="s1">&#39;brightness_threshold&#39;</span><span class="p">,</span> <span class="s1">&#39;usans&#39;</span><span class="p">])</span>

<span class="c1"># Define a function to get the brightness threshold for SUSAN</span>
<span class="k">def</span><span class="w"> </span><span class="nf">getbtthresh</span><span class="p">(</span><span class="n">medianvals</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="mf">0.75</span> <span class="o">*</span> <span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">medianvals</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">getusans</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[[</span><span class="nb">tuple</span><span class="p">([</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.75</span> <span class="o">*</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]])]</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">maskfunc2</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">smooth</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">medianval</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;out_stat&#39;</span><span class="p">,</span> <span class="n">getbtthresh</span><span class="p">),</span> <span class="n">smooth</span><span class="p">,</span>
                <span class="s1">&#39;brightness_threshold&#39;</span><span class="p">)</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">mergenode</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="n">getusans</span><span class="p">),</span> <span class="n">smooth</span><span class="p">,</span> <span class="s1">&#39;usans&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Mask the smoothed data with the dilated mask</p>
<p><strong>Corresponding FSL command:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fslmaths</span> <span class="n">prefiltered_func_data_smooth</span> <span class="o">-</span><span class="n">mas</span> <span class="n">mask</span> <span class="n">prefiltered_func_data_smooth</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">maskfunc3</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">op_string</span><span class="o">=</span><span class="s1">&#39;-mas&#39;</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;maskfunc3&#39;</span><span class="p">,</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">,</span><span class="s1">&#39;in_file2&#39;</span><span class="p">])</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">smooth</span><span class="p">,</span> <span class="s1">&#39;smoothed_file&#39;</span><span class="p">,</span> <span class="n">maskfunc3</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dilatemask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">maskfunc3</span><span class="p">,</span> <span class="s1">&#39;in_file2&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Scale each volume of the TR so that the median value of the TR is set to 10000</p>
<p><strong>Corresponding FSL command:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fslmaths</span> <span class="n">prefiltered_func_data_smooth</span> <span class="o">-</span><span class="n">mul</span> <span class="mf">13.7211811425</span> <span class="n">prefiltered_func_data_intnorm</span> 
<span class="p">(</span><span class="n">this</span> <span class="n">number</span> <span class="ow">is</span> <span class="k">for</span> <span class="n">subject</span><span class="o">-</span><span class="mi">11</span> <span class="n">run</span><span class="o">-</span><span class="mi">01</span><span class="p">)</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">intnorm</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_intnorm&#39;</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">,</span> <span class="s1">&#39;op_string&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;intnorm&#39;</span><span class="p">)</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">maskfunc3</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">intnorm</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

<span class="c1"># Define a function to get the scaling factor for intensity normalization</span>
<span class="k">def</span><span class="w"> </span><span class="nf">getinormscale</span><span class="p">(</span><span class="n">medianvals</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;-mul </span><span class="si">%.10f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">10000.</span> <span class="o">/</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">medianvals</span><span class="p">]</span>

<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">medianval</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;out_stat&#39;</span><span class="p">,</span> <span class="n">getinormscale</span><span class="p">),</span> <span class="n">intnorm</span><span class="p">,</span> <span class="s1">&#39;op_string&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="temporal-filtering">
<h3>Temporal Filtering<a class="headerlink" href="#temporal-filtering" title="Link to this heading">#</a></h3>
<p>Perform temporal highpass filtering on the data</p>
<p><strong>Corresponding FSL command:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fslmaths</span> <span class="n">prefiltered_func_data_intnorm</span> <span class="o">-</span><span class="n">Tmean</span> <span class="n">tempMean</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fslmaths</span> <span class="n">prefiltered_func_data_intnorm</span> <span class="o">-</span><span class="n">bptf</span> <span class="mf">25.0</span> <span class="o">-</span><span class="mi">1</span> <span class="o">-</span><span class="n">add</span> <span class="n">tempMean</span> <span class="n">prefiltered_func_data_tempfilt</span>
</pre></div>
</div>
<p>The output of <code class="docutils literal notranslate"><span class="pre">highpass</span></code> (i.e., <code class="docutils literal notranslate"><span class="pre">sub-11_task-flanker_run-1_bold_dtype_mcf_mask_smooth_mask_intnorm_tempfilt.nii.gz</span></code>) is equivalent to <code class="docutils literal notranslate"><span class="pre">filtered_func_data.nii.gz</span></code> from FSL GUI.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate a mean functional image from the scaled data and this mean func will be used in performing temporal highpass filtering</span>
<span class="n">meanfunc3</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">op_string</span><span class="o">=</span><span class="s1">&#39;-Tmean&#39;</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;meanfunc3&#39;</span><span class="p">)</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">intnorm</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">meanfunc3</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Perform temporal highpass filtering on the data</span>
<span class="n">hpcutoff</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">TR</span> <span class="o">=</span> <span class="mf">2.</span>  <span class="c1"># ensure float</span>

<span class="n">highpass</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_tempfilt&#39;</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;highpass&#39;</span><span class="p">,</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">,</span><span class="s1">&#39;op_string&#39;</span><span class="p">])</span>

<span class="c1"># 25 = (hpcutoff / 2*TR) not (hpcutoff / TR)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">gethpstring</span><span class="p">(</span><span class="n">tempMean</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;-bptf 25 -1 -add </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tm</span><span class="p">)</span> <span class="k">for</span> <span class="n">tm</span> <span class="ow">in</span> <span class="n">tempMean</span><span class="p">]</span>

<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">intnorm</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">highpass</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">meanfunc3</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span><span class="n">gethpstring</span><span class="p">),</span> <span class="n">highpass</span><span class="p">,</span> <span class="s1">&#39;op_string&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Generate a mean functional image from the functional run</p>
<p><strong>Corresponding FSL command:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fslmaths</span> <span class="n">prefiltered_func_data_tempfilt</span> <span class="n">filtered_func_data</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fslmaths</span> <span class="n">filtered_func_data</span> <span class="o">-</span><span class="n">Tmean</span> <span class="n">mean_func</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">meanfunc4</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">op_string</span><span class="o">=</span><span class="s1">&#39;-Tmean&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_mean&#39;</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;meanfunc4&#39;</span><span class="p">)</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">highpass</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">meanfunc4</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="first-level-glm">
<h2>First-Level GLM<a class="headerlink" href="#first-level-glm" title="Link to this heading">#</a></h2>
<section id="get-events">
<h3>Get events<a class="headerlink" href="#get-events" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">subjinfo</span><span class="p">(</span><span class="n">events</span><span class="p">):</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">nipype.interfaces.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">Bunch</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

    <span class="n">subject_info</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">ev</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ev</span> <span class="o">=</span> <span class="n">ev</span><span class="p">[</span><span class="n">ev</span><span class="p">[</span><span class="s1">&#39;correctness&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;correct&#39;</span><span class="p">]</span>
    <span class="n">ev</span><span class="p">[</span><span class="s1">&#39;new_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ev</span><span class="p">[</span><span class="s1">&#39;trial_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">run_info</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="n">onsets</span><span class="o">=</span><span class="p">[],</span> 
                     <span class="n">durations</span><span class="o">=</span><span class="p">[])</span>

    <span class="n">run_info</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">conditions</span><span class="o">=</span><span class="p">[</span><span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">ev</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;new_type&quot;</span><span class="p">)])</span>

    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">ev</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;new_type&quot;</span><span class="p">):</span>
        <span class="n">run_info</span><span class="o">.</span><span class="n">onsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">onset</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">run_info</span><span class="o">.</span><span class="n">durations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="n">subject_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">run_info</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">subject_info</span>

<span class="n">get_sub_info</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">Function</span><span class="p">(</span>
        <span class="n">function</span><span class="o">=</span><span class="n">subjinfo</span><span class="p">,</span> <span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;events&quot;</span><span class="p">],</span> <span class="n">output_names</span><span class="o">=</span><span class="s2">&quot;subject_info&quot;</span>
    <span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;get_sub_info&quot;</span><span class="p">,</span> <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;events&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Connect to workflow</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dg_first</span><span class="p">,</span> <span class="s1">&#39;events&#39;</span><span class="p">,</span> <span class="n">get_sub_info</span><span class="p">,</span> <span class="s1">&#39;events&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="set-up-contrasts">
<h3>Set-up contrasts<a class="headerlink" href="#set-up-contrasts" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">condition_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;congruent&quot;</span><span class="p">,</span> <span class="s2">&quot;incongruent&quot;</span><span class="p">]</span>

<span class="c1"># Activation Contrasts (similar to https://direct.mit.edu/jocn/article/23/10/3162/5327/Is-Morality-Unified-Evidence-that-Distinct-Neural)</span>
<span class="c1">## From FEAT: &quot;The correct way to tell whether two conditions are significantly different is to run a differential contrast like [1 -1] between them&quot;</span>
<span class="n">cont01</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;congruent&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">condition_names</span><span class="p">,</span>  <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">cont02</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;incongruent&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">condition_names</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">cont03</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;congruent-incongruent&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">condition_names</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">cont04</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;incongruent-congruent&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">condition_names</span><span class="p">,</span>  <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="n">contrast_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">cont01</span><span class="p">,</span>
    <span class="n">cont02</span><span class="p">,</span>
    <span class="n">cont03</span><span class="p">,</span>
    <span class="n">cont04</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">TR</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># Repetition Time</span>
<span class="n">hpcutoff</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># highpass filter cutoff in seconds! </span>

<span class="n">modelspec</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">SpecifyModel</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;modelspec&quot;</span><span class="p">,</span> <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;subject_info&quot;</span><span class="p">,</span><span class="s2">&quot;functional_runs&quot;</span><span class="p">])</span>
<span class="n">modelspec</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">input_units</span> <span class="o">=</span> <span class="s2">&quot;secs&quot;</span>
<span class="n">modelspec</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">high_pass_filter_cutoff</span> <span class="o">=</span> <span class="n">hpcutoff</span>
<span class="n">modelspec</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">time_repetition</span> <span class="o">=</span> <span class="n">TR</span>

<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">get_sub_info</span><span class="p">,</span> <span class="s1">&#39;subject_info&#39;</span><span class="p">,</span> <span class="n">modelspec</span><span class="p">,</span><span class="s1">&#39;subject_info&#39;</span><span class="p">)</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">highpass</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span><span class="n">modelspec</span><span class="p">,</span><span class="s1">&#39;functional_runs&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">level1design</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">Level1Design</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;level1design&quot;</span><span class="p">,</span> <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;session_info&quot;</span><span class="p">])</span>
<span class="n">level1design</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">interscan_interval</span> <span class="o">=</span> <span class="n">TR</span>
<span class="c1"># Set HRF bases functions</span>
<span class="n">level1design</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">bases</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gamma&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;derivs&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;gammasigma&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;gammadelay&#39;</span><span class="p">:</span><span class="mi">6</span><span class="p">}}</span>
<span class="n">level1design</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">model_serial_correlations</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">level1design</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">contrasts</span> <span class="o">=</span> <span class="n">contrast_list</span>

<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">modelspec</span><span class="p">,</span><span class="s1">&#39;session_info&#39;</span><span class="p">,</span> <span class="n">level1design</span><span class="p">,</span> <span class="s1">&#39;session_info&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">modelgen</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FEATModel</span><span class="p">(),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;modelgen&#39;</span><span class="p">,</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fsf_file&#39;</span><span class="p">,</span> <span class="s1">&#39;ev_files&#39;</span><span class="p">])</span>

<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">level1design</span><span class="p">,</span> <span class="n">modelgen</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;fsf_files&#39;</span><span class="p">,</span> <span class="s1">&#39;fsf_file&#39;</span><span class="p">),</span> 
                                    <span class="p">(</span><span class="s1">&#39;ev_files&#39;</span><span class="p">,</span><span class="s1">&#39;ev_files&#39;</span><span class="p">)])])</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Corresponding fsl command:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">film_gls</span> <span class="o">--</span><span class="ow">in</span><span class="o">=</span><span class="n">filtered_func_data</span> <span class="o">--</span><span class="n">rn</span><span class="o">=</span><span class="n">stats</span> <span class="o">--</span><span class="n">pd</span><span class="o">=</span><span class="n">design</span><span class="o">.</span><span class="n">mat</span> <span class="o">--</span><span class="n">thr</span><span class="o">=</span><span class="mf">1000.0</span> <span class="o">--</span><span class="n">sa</span> <span class="o">--</span><span class="n">ms</span><span class="o">=</span><span class="mi">5</span> <span class="o">--</span><span class="n">con</span><span class="o">=</span><span class="n">design</span><span class="o">.</span><span class="n">con</span>  

<span class="o">--</span><span class="n">thr</span><span class="p">:</span> <span class="n">threshold</span>
<span class="o">--</span><span class="n">sa</span><span class="p">:</span> <span class="n">smooth_autocorr</span>
<span class="o">--</span><span class="n">ms</span><span class="p">:</span> <span class="n">mask_size</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">level1estimate</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FILMGLS</span><span class="p">(</span><span class="n">smooth_autocorr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mask_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">1000</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;level1estimate&#39;</span><span class="p">,</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;design_file&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">,</span> <span class="s1">&#39;tcon_file&#39;</span><span class="p">])</span>

<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
    <span class="p">(</span><span class="n">highpass</span><span class="p">,</span><span class="n">level1estimate</span><span class="p">,[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span><span class="s1">&#39;in_file&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">modelgen</span><span class="p">,</span><span class="n">level1estimate</span><span class="p">,[(</span><span class="s1">&#39;design_file&#39;</span><span class="p">,</span><span class="s1">&#39;design_file&#39;</span><span class="p">),</span>
                               <span class="p">(</span><span class="s1">&#39;con_file&#39;</span><span class="p">,</span><span class="s1">&#39;tcon_file&#39;</span><span class="p">)])</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>no need to use <code class="docutils literal notranslate"><span class="pre">ContrastMgr</span></code>,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="n">interface</span> <span class="n">mode</span> <span class="n">this</span> <span class="n">file</span> <span class="n">assumes</span> <span class="n">that</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">required</span> <span class="n">inputs</span> <span class="n">are</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">same</span> <span class="n">location</span><span class="o">.</span> <span class="n">This</span> <span class="n">has</span> <span class="n">deprecated</span> <span class="k">for</span> <span class="n">FSL</span> <span class="n">versions</span> <span class="mf">5.0.7</span><span class="o">+</span> <span class="k">as</span> <span class="n">the</span> <span class="n">necessary</span> <span class="n">corrections</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">no</span> <span class="n">longer</span> <span class="n">generated</span> <span class="n">by</span> <span class="n">FILMGLS</span><span class="o">.</span>
</pre></div>
</div>
<p>see this <a class="reference external" href="https://nipype.readthedocs.io/en/latest/api/generated/nipype.interfaces.fsl.model.html#contrastmgr">link</a></p>
</section>
</section>
<section id="registration">
<h2>Registration<a class="headerlink" href="#registration" title="Link to this heading">#</a></h2>
<p>According to <a class="reference external" href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FEAT/UserGuide#Higher-Level_FEAT_Output">FSL UserGuide</a>, the different sessions need to be <strong>registered</strong> to each other before any multi-session or multi-subject analyses can be carried out. Registration inside FEAT uses <code class="docutils literal notranslate"><span class="pre">FLIRT</span></code> and is a two-statge process:</p>
<ol class="arabic simple">
<li><p>An example FMRI low resolution image is registered to an example high resolution image (normally the same subject’s T1-weighted structural). The transformation for this is saved into the FEAT directory. Then the high res image is registered to a standard image (normally a T1-weighted image in standard space, such as the MNI 152 average image).</p></li>
<li><p>The two transformations are combined into a third, which will take the low resolution FMRI images (and the statistic images derived from the first-level analyses) straight into standard space, when applied later, during group analysis.</p></li>
</ol>
<section id="step-1">
<h3>Step 1<a class="headerlink" href="#step-1" title="Link to this heading">#</a></h3>
<p><strong>Corresponding FSL command:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">flirt</span> <span class="o">-</span><span class="ow">in</span> <span class="n">example_func</span> <span class="o">-</span><span class="n">ref</span> <span class="n">standard</span> <span class="o">-</span><span class="n">out</span> <span class="n">example_func2standard</span> <span class="o">-</span><span class="n">omat</span> <span class="n">example_func2standard</span><span class="o">.</span><span class="n">mat</span> <span class="o">-</span><span class="n">cost</span> <span class="n">corratio</span> <span class="o">-</span><span class="n">dof</span> <span class="mi">12</span> <span class="o">-</span><span class="n">searchrx</span> <span class="o">-</span><span class="mi">90</span> <span class="mi">90</span> <span class="o">-</span><span class="n">searchry</span> <span class="o">-</span><span class="mi">90</span> <span class="mi">90</span> <span class="o">-</span><span class="n">searchrz</span> <span class="o">-</span><span class="mi">90</span> <span class="mi">90</span> <span class="o">-</span><span class="n">interp</span> <span class="n">trilinear</span> 

<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">convert_xfm</span> <span class="o">-</span><span class="n">inverse</span> <span class="o">-</span><span class="n">omat</span> <span class="n">standard2example_func</span><span class="o">.</span><span class="n">mat</span> <span class="n">example_func2standard</span><span class="o">.</span><span class="n">mat</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flt</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FLIRT</span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="s1">&#39;corratio&#39;</span><span class="p">,</span> <span class="n">dof</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                                    <span class="n">searchr_x</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="mi">90</span><span class="p">],</span>
                                    <span class="n">searchr_y</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="mi">90</span><span class="p">],</span>
                                    <span class="n">searchr_z</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="mi">90</span><span class="p">],</span>
                                    <span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;trilinear&#39;</span><span class="p">),</span> 
               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;example_func2standard&#39;</span><span class="p">,</span>
               <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">])</span>

<span class="n">flt</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="n">fsl</span><span class="o">.</span><span class="n">Info</span><span class="o">.</span><span class="n">standard_image</span><span class="p">(</span><span class="s1">&#39;MNI152_T1_2mm_brain.nii.gz&#39;</span><span class="p">)</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">extract_ref</span><span class="p">,</span> <span class="s1">&#39;roi_file&#39;</span><span class="p">,</span> <span class="n">flt</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

<span class="n">convertxfm</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ConvertXFM</span><span class="p">(</span><span class="n">invert_xfm</span> <span class="o">=</span> <span class="kc">True</span><span class="p">),</span> 
                         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;convertxfm&#39;</span><span class="p">,</span>
                         <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">])</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">flt</span><span class="p">,</span> <span class="s1">&#39;out_matrix_file&#39;</span><span class="p">,</span> <span class="n">convertxfm</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-2">
<h3>Step 2<a class="headerlink" href="#step-2" title="Link to this heading">#</a></h3>
<p><strong>Corresponding fsl command:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">flirt</span> <span class="o">-</span><span class="n">ref</span> <span class="n">reg</span><span class="o">/</span><span class="n">standard</span> <span class="o">-</span><span class="ow">in</span> <span class="n">stats</span><span class="o">/</span><span class="n">cope1</span> <span class="o">-</span><span class="n">out</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">scratch</span><span class="o">/</span><span class="n">yc</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="n">nipype_fsl_comp</span><span class="o">/</span><span class="n">gui</span><span class="o">/</span><span class="n">sub</span><span class="o">-</span><span class="mi">01</span><span class="o">/</span><span class="n">run1</span><span class="o">.</span><span class="n">feat</span><span class="o">/</span><span class="n">frgrot_chksugax</span> <span class="o">-</span><span class="n">applyxfm</span> <span class="o">-</span><span class="n">init</span> <span class="n">reg</span><span class="o">/</span><span class="n">example_func2standard</span><span class="o">.</span><span class="n">mat</span> <span class="o">-</span><span class="n">interp</span> <span class="n">trilinear</span> <span class="o">-</span><span class="n">datatype</span> <span class="nb">float</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">warp_files</span><span class="p">(</span><span class="n">copes</span><span class="p">,</span> <span class="n">varcopes</span><span class="p">,</span> <span class="n">masks</span><span class="p">,</span> <span class="n">mat</span><span class="p">):</span>
    <span class="c1"># need to reimport here, otherwise errors come out</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">nipype.interfaces.fsl</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">fsl</span> 
    
    <span class="n">out_copes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">out_varcopes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">out_masks</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># register mask, same function, different parameters</span>
    <span class="n">warp_mask</span> <span class="o">=</span> <span class="n">fsl</span><span class="o">.</span><span class="n">FLIRT</span><span class="p">(</span><span class="n">apply_xfm</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                     <span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;nearestneighbour&#39;</span><span class="p">)</span>
    <span class="n">warp_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="n">fsl</span><span class="o">.</span><span class="n">Info</span><span class="o">.</span><span class="n">standard_image</span><span class="p">(</span><span class="s1">&#39;MNI152_T1_2mm_brain.nii.gz&#39;</span><span class="p">)</span>
    <span class="n">warp_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">in_matrix_file</span> <span class="o">=</span> <span class="n">mat</span>
    <span class="n">warp_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">output_type</span> <span class="o">=</span> <span class="s2">&quot;NIFTI_GZ&quot;</span>
    <span class="n">warp_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">in_file</span> <span class="o">=</span> <span class="n">masks</span>
    <span class="n">res_mask</span> <span class="o">=</span> <span class="n">warp_mask</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="n">out_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">res_mask</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">))</span>
    
    <span class="c1"># register copes &amp; varcopes using same function, different parameters</span>
    <span class="n">warp</span> <span class="o">=</span> <span class="n">fsl</span><span class="o">.</span><span class="n">FLIRT</span><span class="p">(</span><span class="n">apply_xfm</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                     <span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;trilinear&#39;</span><span class="p">)</span>
    <span class="n">warp</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="n">fsl</span><span class="o">.</span><span class="n">Info</span><span class="o">.</span><span class="n">standard_image</span><span class="p">(</span><span class="s1">&#39;MNI152_T1_2mm_brain.nii.gz&#39;</span><span class="p">)</span>
    <span class="n">warp</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">in_matrix_file</span> <span class="o">=</span> <span class="n">mat</span>
    <span class="n">warp</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">output_type</span> <span class="o">=</span> <span class="s2">&quot;NIFTI_GZ&quot;</span>
    
    <span class="c1"># register copes</span>
    <span class="k">for</span> <span class="n">cope</span> <span class="ow">in</span> <span class="n">copes</span><span class="p">:</span>
        <span class="n">warp</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">in_file</span> <span class="o">=</span> <span class="n">cope</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">warp</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="n">out_copes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">))</span>
        
     <span class="c1"># register varcopes</span>
    <span class="k">for</span> <span class="n">varcope</span> <span class="ow">in</span> <span class="n">varcopes</span><span class="p">:</span>
        <span class="n">warp</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">in_file</span> <span class="o">=</span> <span class="n">varcope</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">warp</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="n">out_varcopes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">out_copes</span><span class="p">,</span> <span class="n">out_varcopes</span><span class="p">,</span> <span class="n">out_masks</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">warpfunc</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;copes&#39;</span><span class="p">,</span> <span class="s1">&#39;varcopes&#39;</span><span class="p">,</span> <span class="s1">&#39;masks&#39;</span><span class="p">,</span> <span class="s1">&#39;mat&#39;</span><span class="p">],</span>
                                    <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;out_copes&#39;</span><span class="p">,</span> <span class="s1">&#39;out_varcopes&#39;</span><span class="p">,</span> <span class="s1">&#39;out_masks&#39;</span><span class="p">],</span>
                                    <span class="n">function</span><span class="o">=</span><span class="n">warp_files</span><span class="p">),</span>
                      <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;copes&#39;</span><span class="p">,</span> <span class="s1">&#39;varcopes&#39;</span><span class="p">,</span> <span class="s1">&#39;masks&#39;</span><span class="p">,</span><span class="s1">&#39;mat&#39;</span><span class="p">],</span>
                      <span class="n">name</span><span class="o">=</span><span class="s1">&#39;warpfunc&#39;</span><span class="p">)</span>

<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">level1estimate</span><span class="p">,</span> <span class="s1">&#39;copes&#39;</span><span class="p">,</span> <span class="n">warpfunc</span><span class="p">,</span> <span class="s1">&#39;copes&#39;</span><span class="p">)</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">level1estimate</span><span class="p">,</span> <span class="s1">&#39;varcopes&#39;</span><span class="p">,</span> <span class="n">warpfunc</span><span class="p">,</span> <span class="s1">&#39;varcopes&#39;</span><span class="p">)</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dilatemask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">warpfunc</span><span class="p">,</span> <span class="s1">&#39;masks&#39;</span><span class="p">)</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">flt</span><span class="p">,</span> <span class="s1">&#39;out_matrix_file&#39;</span><span class="p">,</span> <span class="n">warpfunc</span><span class="p">,</span> <span class="s1">&#39;mat&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># save all results into single/separate folder for further analysis use</span>
<span class="n">datasink_first</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">nio</span><span class="o">.</span><span class="n">DataSink</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sinker&#39;</span><span class="p">)</span>
<span class="n">datasink_first</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">base_directory</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exp_dir_first</span><span class="p">,</span> <span class="s2">&quot;level1_results&quot;</span><span class="p">)</span>

<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">infosource_first</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">datasink_first</span><span class="p">,</span> <span class="s1">&#39;container&#39;</span><span class="p">)</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">level1estimate</span><span class="p">,</span> <span class="n">datasink_first</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;results_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;results_dir&#39;</span><span class="p">)])])</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">warpfunc</span><span class="p">,</span> <span class="n">datasink_first</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_copes&#39;</span><span class="p">,</span> <span class="s1">&#39;reg_copes&#39;</span><span class="p">)])])</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">warpfunc</span><span class="p">,</span> <span class="n">datasink_first</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_varcopes&#39;</span><span class="p">,</span> <span class="s1">&#39;reg_varcopes&#39;</span><span class="p">)])])</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">warpfunc</span><span class="p">,</span> <span class="n">datasink_first</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_masks&#39;</span><span class="p">,</span> <span class="s1">&#39;reg_masks&#39;</span><span class="p">)])])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create 1st-level analysis output graph</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">write_graph</span><span class="p">(</span><span class="n">graph2use</span><span class="o">=</span><span class="s1">&#39;colored&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">simple_form</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Visualize the graph</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
<span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wf_first</span><span class="o">.</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">wf_first</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;graph.png&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>230622-04:04:13,752 nipype.workflow INFO:
	 Generated workflow graph: /home/jovyan/example-notebooks/functional_imaging/output_level1/level1/graph.png (graph2use=colored, simple_form=True).
</pre></div>
</div>
<img alt="../_images/a062279807265ff39c961ecbe84a428502dcece4ef8ede59a95af6b44c5290a8.png" src="../_images/a062279807265ff39c961ecbe84a428502dcece4ef8ede59a95af6b44c5290a8.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;nipype.workflow&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#set to 1 if nipype output is wanted</span>
<span class="c1"># Run Workflow</span>
<span class="n">wf_first</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">plugin</span><span class="o">=</span><span class="s2">&quot;MultiProc&quot;</span><span class="p">,</span> <span class="n">plugin_args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;n_procs&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;networkx.classes.digraph.DiGraph at 0x7f21f9399810&gt;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="the-first-level-glm">
<h2>The first-level GLM<a class="headerlink" href="#the-first-level-glm" title="Link to this heading">#</a></h2>
<p>Here we randomly choose the four copes from subject-09 run-1</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fsaverage</span> <span class="o">=</span> <span class="n">nilearn</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">fetch_surf_fsaverage</span><span class="p">()</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">show</span><span class="p">()</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nipype_cope1</span> <span class="o">=</span> <span class="s1">&#39;./output_level1/level1_results/09/results_dir/_subject_id_09/_level1estimate0/results/cope1.nii.gz&#39;</span>
<span class="n">nipype_cope2</span> <span class="o">=</span> <span class="s1">&#39;./output_level1/level1_results/09/results_dir/_subject_id_09/_level1estimate0/results/cope2.nii.gz&#39;</span>
<span class="n">nipype_cope3</span> <span class="o">=</span> <span class="s1">&#39;./output_level1/level1_results/09/results_dir/_subject_id_09/_level1estimate0/results/cope3.nii.gz&#39;</span>
<span class="n">nipype_cope4</span> <span class="o">=</span> <span class="s1">&#39;./output_level1/level1_results/09/results_dir/_subject_id_09/_level1estimate0/results/cope4.nii.gz&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_scroll-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plotting</span><span class="o">.</span><span class="n">plot_stat_map</span><span class="p">(</span><span class="n">nipype_cope1</span><span class="p">,</span> <span class="n">bg_img</span><span class="o">=</span><span class="n">nipype_cope1</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Nipype - COPE1&#39;</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">plot_stat_map</span><span class="p">(</span><span class="n">nipype_cope2</span><span class="p">,</span> <span class="n">bg_img</span><span class="o">=</span><span class="n">nipype_cope1</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Nipype - COPE2&#39;</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">plot_stat_map</span><span class="p">(</span><span class="n">nipype_cope3</span><span class="p">,</span> <span class="n">bg_img</span><span class="o">=</span><span class="n">nipype_cope1</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Nipype - COPE3&#39;</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">plot_stat_map</span><span class="p">(</span><span class="n">nipype_cope4</span><span class="p">,</span> <span class="n">bg_img</span><span class="o">=</span><span class="n">nipype_cope1</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Nipype - COPE4&#39;</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/931ab0f4c71eda49ae5e6167a2672dd59539a5e9f6a9fbe1ed2d8c757f724a8e.png" src="../_images/931ab0f4c71eda49ae5e6167a2672dd59539a5e9f6a9fbe1ed2d8c757f724a8e.png" />
<img alt="../_images/ca87416da6220b551ec0094ece084427f186273593d763cba989ddd2a9eec6e3.png" src="../_images/ca87416da6220b551ec0094ece084427f186273593d763cba989ddd2a9eec6e3.png" />
<img alt="../_images/966f776d79bec4829951b87747c9d1785ba05de3fb87b91dd1c897d4e75a6b93.png" src="../_images/966f776d79bec4829951b87747c9d1785ba05de3fb87b91dd1c897d4e75a6b93.png" />
<img alt="../_images/c656f64454b3cf78de946e554d846c9985e937a5333556973768d421a209572e.png" src="../_images/c656f64454b3cf78de946e554d846c9985e937a5333556973768d421a209572e.png" />
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="second-level-glm-using-nipype-fsl">
<h1>Second level GLM using Nipype FSL<a class="headerlink" href="#second-level-glm-using-nipype-fsl" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wf_second</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;level2&#39;</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="n">exp_dir_second</span><span class="p">)</span>
<span class="n">wf_second</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;execution&quot;</span><span class="p">][</span><span class="s2">&quot;crashfile_format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;txt&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>The following two nodes (<code class="docutils literal notranslate"><span class="pre">infosource</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">dg</span></code>) together define all inputs required for the preprocessing workflow</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># we want to group the outcome by contrast not subject</span>
<span class="n">contr_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
<span class="n">infosource_second</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;contr_id&quot;</span><span class="p">]),</span>
                  <span class="n">name</span><span class="o">=</span><span class="s2">&quot;infosource_second&quot;</span><span class="p">)</span>
<span class="n">infosource_second</span><span class="o">.</span><span class="n">iterables</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;contr_id&quot;</span><span class="p">,</span> <span class="n">contr_list</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># here we use SelectFiles, instead of DataGrabber, because the former is more flexible with formatting syntax</span>
<span class="n">templates_second</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;reg_copes&quot;</span><span class="p">:</span><span class="s2">&quot;*/reg_copes/*/*/cope</span><span class="si">{contr_id}</span><span class="s2">_flirt.nii.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;reg_varcopes&quot;</span><span class="p">:</span><span class="s2">&quot;*/reg_varcopes/*/*/varcope</span><span class="si">{contr_id}</span><span class="s2">_flirt.nii.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;reg_masks&quot;</span><span class="p">:</span><span class="s2">&quot;*/reg_masks/*/*/*.nii.gz&quot;</span>
<span class="p">}</span>
<span class="n">dg_second</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">nio</span><span class="o">.</span><span class="n">SelectFiles</span><span class="p">(</span><span class="n">templates_second</span><span class="p">),</span>
             <span class="n">name</span><span class="o">=</span><span class="s2">&quot;selectfiles_second&quot;</span><span class="p">)</span>
<span class="n">dg_second</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">base_directory</span> <span class="o">=</span> <span class="n">data_dir_second</span>

<span class="n">wf_second</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
        <span class="p">(</span><span class="n">infosource_second</span><span class="p">,</span> <span class="n">dg_second</span><span class="p">,</span> <span class="p">[(</span><span class="s2">&quot;contr_id&quot;</span><span class="p">,</span> <span class="s2">&quot;contr_id&quot;</span><span class="p">)])</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<section id="second-level-glm">
<h2>Second-level GLM<a class="headerlink" href="#second-level-glm" title="Link to this heading">#</a></h2>
<p>Combining results from multiple runs of one subject into one</p>
<section id="higher-level-input-files-preparation">
<h3>Higher-level input files preparation<a class="headerlink" href="#higher-level-input-files-preparation" title="Link to this heading">#</a></h3>
<section id="step-1-merge-registered-copes-varcopes-masks">
<h4>Step 1: Merge registered copes &amp; varcopes &amp; masks<a class="headerlink" href="#step-1-merge-registered-copes-varcopes-masks" title="Link to this heading">#</a></h4>
<p><strong>Corresponding FSL command:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fslmerge</span> <span class="o">-</span><span class="n">t</span> <span class="n">mask</span> <span class="p">(</span><span class="n">masks</span> <span class="kn">from</span><span class="w"> </span><span class="nn">all</span> <span class="mi">52</span> <span class="n">inputs</span><span class="p">)</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fslmerge</span> <span class="o">-</span><span class="n">t</span> <span class="n">cope</span> <span class="p">(</span><span class="n">copes</span> <span class="kn">from</span><span class="w"> </span><span class="nn">all</span> <span class="mi">52</span> <span class="n">inputs</span><span class="p">)</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fslmerge</span> <span class="o">-</span><span class="n">t</span> <span class="n">varcop</span> <span class="p">(</span><span class="n">varcopes</span> <span class="kn">from</span><span class="w"> </span><span class="nn">all</span> <span class="mi">52</span> <span class="n">inputs</span><span class="p">)</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">copemerge_second</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_files&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;copemerge_second&quot;</span><span class="p">)</span>

<span class="n">varcopemerge_second</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_files&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;varcopemerge_second&quot;</span><span class="p">)</span>

<span class="n">maskmerge_second</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_files&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;maskmerge_second&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">sort_copes</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
    <span class="n">numelements</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">outfiles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numelements</span><span class="p">):</span>
        <span class="n">outfiles</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">elements</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
            <span class="n">outfiles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">outfiles</span>

<span class="n">wf_second</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dg_second</span><span class="p">,</span> <span class="s1">&#39;reg_varcopes&#39;</span><span class="p">,</span> <span class="n">varcopemerge_second</span><span class="p">,</span> <span class="s1">&#39;in_files&#39;</span><span class="p">)</span>
<span class="n">wf_second</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dg_second</span><span class="p">,</span> <span class="s1">&#39;reg_copes&#39;</span><span class="p">,</span> <span class="n">copemerge_second</span><span class="p">,</span> <span class="s1">&#39;in_files&#39;</span><span class="p">)</span>
<span class="n">wf_second</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dg_second</span><span class="p">,</span> <span class="s1">&#39;reg_masks&#39;</span><span class="p">,</span> <span class="n">maskmerge_second</span><span class="p">,</span> <span class="s1">&#39;in_files&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-2-making-mask">
<h4>Step 2: Making mask<a class="headerlink" href="#step-2-making-mask" title="Link to this heading">#</a></h4>
<p>In FSL, there are many commands about <code class="docutils literal notranslate"><span class="pre">maskunique</span></code>, which is unless for the second level. We can ignore it.</p>
<p><strong>Corresponding FSL command:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fslmaths</span> <span class="n">mask</span> <span class="o">-</span><span class="n">Tmin</span> <span class="n">mask</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">minmask_second</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">op_string</span><span class="o">=</span><span class="s1">&#39;-Tmin&#39;</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;minmask_second&#39;</span><span class="p">)</span>

<span class="n">wf_second</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">maskmerge_second</span><span class="p">,</span> <span class="s1">&#39;merged_file&#39;</span><span class="p">,</span> <span class="n">minmask_second</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-3-masking-copes-varcopes">
<h4>Step 3: Masking copes &amp; varcopes<a class="headerlink" href="#step-3-masking-copes-varcopes" title="Link to this heading">#</a></h4>
<p><strong>Corresponding FSL command:</strong></p>
<p>we have four contrasts so the following commands repeat four times</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fslmaths</span> <span class="n">cope1</span> <span class="o">-</span><span class="n">mas</span> <span class="n">mask</span> <span class="n">cope1</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fslmaths</span> <span class="n">varcope1</span> <span class="o">-</span><span class="n">mas</span> <span class="n">mask</span> <span class="n">varcope1</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">maskcope_second</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">op_string</span><span class="o">=</span><span class="s1">&#39;-mas&#39;</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file2&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;maskcope_second&#39;</span><span class="p">)</span>

<span class="n">maskvarcope_second</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">op_string</span><span class="o">=</span><span class="s1">&#39;-mas&#39;</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file2&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;maskvarcope_second&#39;</span><span class="p">)</span>

<span class="n">wf_second</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">copemerge_second</span><span class="p">,</span> <span class="s1">&#39;merged_file&#39;</span><span class="p">,</span> <span class="n">maskcope_second</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
<span class="n">wf_second</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">minmask_second</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">maskcope_second</span><span class="p">,</span> <span class="s1">&#39;in_file2&#39;</span><span class="p">)</span>
<span class="n">wf_second</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">varcopemerge_second</span><span class="p">,</span> <span class="s1">&#39;merged_file&#39;</span><span class="p">,</span> <span class="n">maskvarcope_second</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
<span class="n">wf_second</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">minmask_second</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">maskvarcope_second</span><span class="p">,</span> <span class="s1">&#39;in_file2&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="set-up-second-level-contrasts-and-fixed-effects">
<h3>Set up second-level contrasts and fixed-effects<a class="headerlink" href="#set-up-second-level-contrasts-and-fixed-effects" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_contrasts_l2</span><span class="p">(</span><span class="n">in_files</span><span class="p">):</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
    <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_files</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">in_files</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
    <span class="n">n_sub</span> <span class="o">=</span> <span class="mi">9</span>  
    <span class="c1"># n_sub = 26</span>
    <span class="n">ev_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ev&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n_sub</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">weight_mtx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_sub</span><span class="p">,</span><span class="n">n_sub</span><span class="p">))</span>
    <span class="n">weight_mtx</span> <span class="o">=</span> <span class="n">weight_mtx</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">weight_mtx</span><span class="p">,</span><span class="mf">1.</span><span class="p">)</span>
    <span class="c1">#contr = [&#39;&#39;,&#39;T&#39;,ev_list,list(weight_mtx[0])] --&gt; original paper</span>
    <span class="n">contr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">ev_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">weight_mtx</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span> <span class="c1">#adaptation so the construction of the array works</span>
    <span class="n">contr_lst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">contr</span><span class="p">,</span> <span class="p">(</span><span class="n">n_sub</span><span class="p">,</span><span class="n">n_sub</span><span class="p">))</span>
    <span class="n">contr_lst</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">contr_lst</span><span class="p">]</span> 
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_sub</span><span class="p">):</span>
        <span class="c1"># Instead of trying to change the tuple, create a new tuple with the changed value.</span>
        <span class="n">contr_lst</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">contr_lst</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">contr_lst</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">contr_lst</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">weight_mtx</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="n">reg_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="kc">None</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ev_list</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">reg_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">start_lst</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">total</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">ev_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">start_idx</span> <span class="o">=</span> <span class="n">idx</span><span class="o">*</span><span class="mi">2</span>
        <span class="n">end_idx</span> <span class="o">=</span> <span class="n">idx</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">start_lst</span><span class="p">[</span><span class="n">start_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">start_lst</span><span class="p">[</span><span class="n">end_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">reg_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_lst</span>    
    <span class="k">return</span> <span class="n">contr_lst</span><span class="p">,</span> <span class="n">reg_dict</span>

<span class="n">contrastgen_l2</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_files&#39;</span><span class="p">],</span>
                                    <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;contr_lst&#39;</span><span class="p">,</span> <span class="s1">&#39;reg_dict&#39;</span><span class="p">],</span>
                                    <span class="n">function</span><span class="o">=</span><span class="n">get_contrasts_l2</span><span class="p">),</span>
                      <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_files&#39;</span><span class="p">],</span>
                      <span class="n">name</span><span class="o">=</span><span class="s1">&#39;contrastgen_l2&#39;</span><span class="p">)</span>

<span class="n">wf_second</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dg_second</span><span class="p">,</span><span class="s1">&#39;reg_copes&#39;</span><span class="p">,</span> <span class="n">contrastgen_l2</span><span class="p">,</span> <span class="s1">&#39;in_files&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Nipype recommends using <a class="reference external" href="https://nipype.readthedocs.io/en/latest/api/generated/nipype.interfaces.fsl.model.html#l2model">L2Model</a>, which only works for the single subject. It takes the number of runs (copes at the first level) as input and does estimations for subject one by one.
Instead, we use <a class="reference external" href="https://nipype.readthedocs.io/en/latest/api/generated/nipype.interfaces.fsl.model.html#multipleregressdesign">MultipleRegressDesign</a>. As it’s name indicates, this one can deal with multiple predictors (subjects) at the same time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">level2model</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">MultipleRegressDesign</span><span class="p">(),</span>
                      <span class="n">name</span><span class="o">=</span><span class="s1">&#39;l2model&#39;</span><span class="p">)</span>

<span class="n">wf_second</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">contrastgen_l2</span><span class="p">,</span> <span class="n">level2model</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;contr_lst&#39;</span><span class="p">,</span><span class="s1">&#39;contrasts&#39;</span><span class="p">),</span>
                                        <span class="p">(</span><span class="s1">&#39;reg_dict&#39;</span><span class="p">,</span><span class="s1">&#39;regressors&#39;</span><span class="p">)])])</span>

<span class="n">level2estimate</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FLAMEO</span><span class="p">(</span><span class="n">run_mode</span><span class="o">=</span><span class="s1">&#39;fe&#39;</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;level2estimate&quot;</span><span class="p">,</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cope_file&#39;</span><span class="p">,</span> <span class="s1">&#39;var_cope_file&#39;</span><span class="p">])</span>

<span class="n">wf_second</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
    <span class="p">(</span><span class="n">maskcope_second</span><span class="p">,</span> <span class="n">level2estimate</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;cope_file&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">maskvarcope_second</span><span class="p">,</span> <span class="n">level2estimate</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;var_cope_file&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">minmask_second</span><span class="p">,</span> <span class="n">level2estimate</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;mask_file&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">level2model</span><span class="p">,</span> <span class="n">level2estimate</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;design_mat&#39;</span><span class="p">,</span> <span class="s1">&#39;design_file&#39;</span><span class="p">),</span>
                                   <span class="p">(</span><span class="s1">&#39;design_con&#39;</span><span class="p">,</span> <span class="s1">&#39;t_con_file&#39;</span><span class="p">),</span> 
                                   <span class="p">(</span><span class="s1">&#39;design_grp&#39;</span><span class="p">,</span> <span class="s1">&#39;cov_split_file&#39;</span><span class="p">)]),</span>
<span class="p">])</span>

<span class="n">datasink_second</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">nio</span><span class="o">.</span><span class="n">DataSink</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sinker&#39;</span><span class="p">)</span>
<span class="n">datasink_second</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">base_directory</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exp_dir_second</span><span class="p">,</span> <span class="s2">&quot;level2_results&quot;</span><span class="p">)</span>

<span class="n">int2string</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;contrast_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    
<span class="n">wf_second</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">infosource_second</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;contr_id&#39;</span><span class="p">,</span><span class="n">int2string</span><span class="p">),</span> <span class="n">datasink_second</span><span class="p">,</span> <span class="s1">&#39;container&#39;</span><span class="p">)</span>
<span class="n">wf_second</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">level2estimate</span><span class="p">,</span> <span class="n">datasink_second</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;stats_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;stats_dir&#39;</span><span class="p">)])])</span>

<span class="c1"># Create 1st-level analysis output graph</span>
<span class="n">wf_second</span><span class="o">.</span><span class="n">write_graph</span><span class="p">(</span><span class="n">graph2use</span><span class="o">=</span><span class="s1">&#39;colored&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">simple_form</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Visualize the graph</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
<span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wf_second</span><span class="o">.</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">wf_second</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;graph.png&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/31f70591725b61c51f29bfe0b898025ee6fe0b079f5a48028dcbed27f371e8c8.png" src="../_images/31f70591725b61c51f29bfe0b898025ee6fe0b079f5a48028dcbed27f371e8c8.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run Workflow</span>
<span class="n">wf_second</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">plugin</span><span class="o">=</span><span class="s2">&quot;MultiProc&quot;</span><span class="p">,</span> <span class="n">plugin_args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;n_procs&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;networkx.classes.digraph.DiGraph at 0x7f21dd61b130&gt;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="the-second-level-glm">
<h2>The second-level GLM<a class="headerlink" href="#the-second-level-glm" title="Link to this heading">#</a></h2>
<p>Here we choose the four copes from subject-01</p>
<section id="regapply">
<h3>Regapply<a class="headerlink" href="#regapply" title="Link to this heading">#</a></h3>
<p>This happens before the second-level GLM, all results from the first level are needed to be registered into the standard space</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nipype_cope1</span> <span class="o">=</span> <span class="s1">&#39;./output_level1/level1_results/01/reg_copes/_subject_id_01/_warpfunc1/cope1_flirt.nii.gz&#39;</span>
<span class="n">nipype_cope2</span> <span class="o">=</span> <span class="s1">&#39;./output_level1/level1_results/01/reg_copes/_subject_id_01/_warpfunc1/cope2_flirt.nii.gz&#39;</span>
<span class="n">nipype_cope3</span> <span class="o">=</span> <span class="s1">&#39;./output_level1/level1_results/01/reg_copes/_subject_id_01/_warpfunc1/cope3_flirt.nii.gz&#39;</span>
<span class="n">nipype_cope4</span> <span class="o">=</span> <span class="s1">&#39;./output_level1/level1_results/01/reg_copes/_subject_id_01/_warpfunc1/cope4_flirt.nii.gz&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_scroll-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plotting</span><span class="o">.</span><span class="n">plot_stat_map</span><span class="p">(</span><span class="n">nipype_cope1</span><span class="p">,</span> <span class="n">bg_img</span><span class="o">=</span><span class="n">nipype_cope1</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Nipype - COPE1&#39;</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">plot_stat_map</span><span class="p">(</span><span class="n">nipype_cope2</span><span class="p">,</span> <span class="n">bg_img</span><span class="o">=</span><span class="n">nipype_cope2</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Nipype - COPE2&#39;</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">plot_stat_map</span><span class="p">(</span><span class="n">nipype_cope3</span><span class="p">,</span> <span class="n">bg_img</span><span class="o">=</span><span class="n">nipype_cope3</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Nipype - COPE3&#39;</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">plot_stat_map</span><span class="p">(</span><span class="n">nipype_cope4</span><span class="p">,</span> <span class="n">bg_img</span><span class="o">=</span><span class="n">nipype_cope4</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Nipype - COPE4&#39;</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/15240f937ff62d363ff0d2f0038aebf84d60e8551bf63e704cde17ba82e39145.png" src="../_images/15240f937ff62d363ff0d2f0038aebf84d60e8551bf63e704cde17ba82e39145.png" />
<img alt="../_images/dbf4b2ce846953767b9826a8f70fc6fe013b94f24c97cb33dffad322ba2d75e8.png" src="../_images/dbf4b2ce846953767b9826a8f70fc6fe013b94f24c97cb33dffad322ba2d75e8.png" />
<img alt="../_images/9bec52a10b3f6b83cf56f5cc5110b80ce1c4eb00ecb3abc21af7b7387a179654.png" src="../_images/9bec52a10b3f6b83cf56f5cc5110b80ce1c4eb00ecb3abc21af7b7387a179654.png" />
<img alt="../_images/d79995b6da6a54db5754d771c5f1a34a7f5d228ba507343c6a124d0650231715.png" src="../_images/d79995b6da6a54db5754d771c5f1a34a7f5d228ba507343c6a124d0650231715.png" />
</div>
</div>
</section>
<section id="copes-from-the-second-level-glm">
<h3>Copes from the second-level GLM<a class="headerlink" href="#copes-from-the-second-level-glm" title="Link to this heading">#</a></h3>
<p>Copes from subject-01:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nipype_cope1</span> <span class="o">=</span> <span class="s1">&#39;./output_level2/level2_results/contrast_1/stats_dir/_contr_id_1/stats/cope1.nii.gz&#39;</span>
<span class="n">nipype_cope2</span> <span class="o">=</span> <span class="s1">&#39;./output_level2/level2_results/contrast_2/stats_dir/_contr_id_2/stats/cope1.nii.gz&#39;</span>
<span class="n">nipype_cope3</span> <span class="o">=</span> <span class="s1">&#39;./output_level2/level2_results/contrast_3/stats_dir/_contr_id_3/stats/cope1.nii.gz&#39;</span>
<span class="n">nipype_cope4</span> <span class="o">=</span> <span class="s1">&#39;./output_level2/level2_results/contrast_4/stats_dir/_contr_id_4/stats/cope1.nii.gz&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_scroll-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plotting</span><span class="o">.</span><span class="n">plot_glass_brain</span><span class="p">(</span><span class="n">nipype_cope1</span><span class="p">,</span> <span class="n">bg_img</span><span class="o">=</span><span class="n">nipype_cope1</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Nipype - COPE1&#39;</span><span class="p">)</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">plot_glass_brain</span><span class="p">(</span><span class="n">nipype_cope2</span><span class="p">,</span> <span class="n">bg_img</span><span class="o">=</span><span class="n">nipype_cope2</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Nipype - COPE2&#39;</span><span class="p">)</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">plot_glass_brain</span><span class="p">(</span><span class="n">nipype_cope3</span><span class="p">,</span> <span class="n">bg_img</span><span class="o">=</span><span class="n">nipype_cope3</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Nipype - COPE3&#39;</span><span class="p">)</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">plot_glass_brain</span><span class="p">(</span><span class="n">nipype_cope4</span><span class="p">,</span> <span class="n">bg_img</span><span class="o">=</span><span class="n">nipype_cope4</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Nipype - COPE4&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c2cc4b07dd32b076d70696f9bd3f5176241f60e653777dcb51941e7fea47b06e.png" src="../_images/c2cc4b07dd32b076d70696f9bd3f5176241f60e653777dcb51941e7fea47b06e.png" />
<img alt="../_images/428afe70713871101005cdeececcdbbe7db8120a6ea622ec7a52fca1359f1cea.png" src="../_images/428afe70713871101005cdeececcdbbe7db8120a6ea622ec7a52fca1359f1cea.png" />
<img alt="../_images/5223962992efee919878975c9a19ed881113629466f73bee5b4231c671aa0e2b.png" src="../_images/5223962992efee919878975c9a19ed881113629466f73bee5b4231c671aa0e2b.png" />
<img alt="../_images/1113b0104e03314bf24b341821e092f139d046be77d7aba255734292741b66b2.png" src="../_images/1113b0104e03314bf24b341821e092f139d046be77d7aba255734292741b66b2.png" />
</div>
</div>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="third-level-glm-using-nipype-fsl">
<h1>Third-level GLM using Nipype FSL<a class="headerlink" href="#third-level-glm-using-nipype-fsl" title="Link to this heading">#</a></h1>
<p>Start the workflow</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wf_third</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;level3&#39;</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="n">exp_dir_third</span><span class="p">)</span>
<span class="n">wf_third</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;execution&quot;</span><span class="p">][</span><span class="s2">&quot;crashfile_format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;txt&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>The following two nodes (<code class="docutils literal notranslate"><span class="pre">infosource</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">dg</span></code>) together define all inputs required for the preprocessing workflow</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># we want to group the outcome by contrast not subject</span>
<span class="n">contr_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
<span class="n">infosource_third</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;contr_id&quot;</span><span class="p">]),</span>
                  <span class="n">name</span><span class="o">=</span><span class="s2">&quot;infosource_third&quot;</span><span class="p">)</span>
<span class="n">infosource_third</span><span class="o">.</span><span class="n">iterables</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;contr_id&quot;</span><span class="p">,</span> <span class="n">contr_list</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># here we use SelectFiles, instead of DataGrabber, because the former is more flexible with formatting syntax</span>
<span class="n">templates_third</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;copes&quot;</span><span class="p">:</span><span class="s2">&quot;contrast_</span><span class="si">{contr_id}</span><span class="s2">/*/_contr_id_</span><span class="si">{contr_id}</span><span class="s2">/*/cope*.nii.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;varcopes&quot;</span><span class="p">:</span><span class="s2">&quot;contrast_</span><span class="si">{contr_id}</span><span class="s2">/*/_contr_id_</span><span class="si">{contr_id}</span><span class="s2">/*/varcope*.nii.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;masks&quot;</span><span class="p">:</span><span class="s2">&quot;contrast_</span><span class="si">{contr_id}</span><span class="s2">/*/_contr_id_</span><span class="si">{contr_id}</span><span class="s2">/*/mask.nii.gz&quot;</span>
<span class="p">}</span>
<span class="n">templates</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;reg_copes&quot;</span><span class="p">:</span><span class="s2">&quot;*/reg_copes/*/*/cope</span><span class="si">{contr_id}</span><span class="s2">_flirt.nii.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;reg_varcopes&quot;</span><span class="p">:</span><span class="s2">&quot;*/reg_varcopes/*/*/varcope</span><span class="si">{contr_id}</span><span class="s2">_flirt.nii.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;reg_masks&quot;</span><span class="p">:</span><span class="s2">&quot;*/reg_masks/*/*/*.nii.gz&quot;</span>
<span class="p">}</span>

<span class="n">dg_third</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">nio</span><span class="o">.</span><span class="n">SelectFiles</span><span class="p">(</span><span class="n">templates_third</span><span class="p">),</span>
             <span class="n">name</span><span class="o">=</span><span class="s2">&quot;selectfiles_third&quot;</span><span class="p">)</span>
<span class="n">dg_third</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">base_directory</span> <span class="o">=</span> <span class="n">data_dir_third</span>

<span class="n">wf_third</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
        <span class="p">(</span><span class="n">infosource_third</span><span class="p">,</span> <span class="n">dg_third</span><span class="p">,</span> <span class="p">[(</span><span class="s2">&quot;contr_id&quot;</span><span class="p">,</span> <span class="s2">&quot;contr_id&quot;</span><span class="p">)])</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<section id="third-level-glm">
<h2>Third-level GLM<a class="headerlink" href="#third-level-glm" title="Link to this heading">#</a></h2>
<p>Combining results from multiple runs of one subject into one</p>
<section id="id1">
<h3>Higher-level input files preparation<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<section id="id2">
<h4>Step 1: Merge registered copes &amp; varcopes &amp; masks<a class="headerlink" href="#id2" title="Link to this heading">#</a></h4>
<p><strong>Corresponding FSL command:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fslmerge</span> <span class="o">-</span><span class="n">t</span> <span class="n">mask</span> <span class="p">(</span><span class="n">masks</span> <span class="kn">from</span><span class="w"> </span><span class="nn">all</span> <span class="mi">26</span> <span class="n">inputs</span><span class="p">)</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fslmerge</span> <span class="o">-</span><span class="n">t</span> <span class="n">cope</span> <span class="p">(</span><span class="n">copes</span> <span class="kn">from</span><span class="w"> </span><span class="nn">all</span> <span class="mi">26</span> <span class="n">inputs</span><span class="p">)</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fslmerge</span> <span class="o">-</span><span class="n">t</span> <span class="n">varcop</span> <span class="p">(</span><span class="n">varcopes</span> <span class="kn">from</span><span class="w"> </span><span class="nn">all</span> <span class="mi">26</span> <span class="n">inputs</span><span class="p">)</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">copemerge_third</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_files&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;copemerge_third&quot;</span><span class="p">)</span>

<span class="n">varcopemerge_third</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_files&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;varcopemerge_third&quot;</span><span class="p">)</span>

<span class="n">maskmerge_third</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_files&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;maskmerge_third&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">repeat_mask</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
    <span class="c1"># n_sub = len(glob.glob(os.path.join(os.getcwd(), &#39;ds000102&#39;)+&quot;/sub-0*&quot;))    </span>
    <span class="n">n_sub</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="n">mask_lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span><span class="p">]</span>
    <span class="n">repeated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">mask_lst</span><span class="p">,</span><span class="n">n_sub</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">repeated</span><span class="p">)</span>

<span class="n">wf_third</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dg_third</span><span class="p">,</span> <span class="s1">&#39;copes&#39;</span><span class="p">,</span> <span class="n">copemerge_third</span><span class="p">,</span> <span class="s1">&#39;in_files&#39;</span><span class="p">)</span>
<span class="n">wf_third</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dg_third</span><span class="p">,</span> <span class="s1">&#39;varcopes&#39;</span><span class="p">,</span> <span class="n">varcopemerge_third</span><span class="p">,</span> <span class="s1">&#39;in_files&#39;</span><span class="p">)</span>
<span class="n">wf_third</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dg_third</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;masks&#39;</span><span class="p">,</span> <span class="n">repeat_mask</span><span class="p">),</span> <span class="n">maskmerge_third</span><span class="p">,</span> <span class="s1">&#39;in_files&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id3">
<h4>Step 2: Making mask<a class="headerlink" href="#id3" title="Link to this heading">#</a></h4>
<p>In FSL, there are many commands about <code class="docutils literal notranslate"><span class="pre">maskunique</span></code>, which is unless for the second level. We can ignore it.</p>
<p><strong>Corresponding FSL command:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fslmaths</span> <span class="n">mask</span> <span class="o">-</span><span class="n">Tmin</span> <span class="n">mask</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># /usr/local/fsl/bin/fslmaths mask -Tmin mask</span>
<span class="n">minmask_third</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">op_string</span><span class="o">=</span><span class="s1">&#39;-Tmin&#39;</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;minmask_third&#39;</span><span class="p">)</span>

<span class="n">wf_third</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">maskmerge_third</span><span class="p">,</span> <span class="s1">&#39;merged_file&#39;</span><span class="p">,</span> <span class="n">minmask_third</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id4">
<h4>Step 3: Masking copes &amp; varcopes<a class="headerlink" href="#id4" title="Link to this heading">#</a></h4>
<p><strong>Corresponding FSL command:</strong></p>
<p>we have four contrasts so the following commands repeat four times</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fslmaths</span> <span class="n">cope1</span> <span class="o">-</span><span class="n">mas</span> <span class="n">mask</span> <span class="n">cope1</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fslmaths</span> <span class="n">varcope1</span> <span class="o">-</span><span class="n">mas</span> <span class="n">mask</span> <span class="n">varcope1</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">maskcope_third</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">op_string</span><span class="o">=</span><span class="s1">&#39;-mas&#39;</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file2&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;maskcope_third&#39;</span><span class="p">)</span>

<span class="n">maskvarcope_third</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">op_string</span><span class="o">=</span><span class="s1">&#39;-mas&#39;</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file2&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;maskvarcope_third&#39;</span><span class="p">)</span>

<span class="n">wf_third</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">copemerge_third</span><span class="p">,</span> <span class="s1">&#39;merged_file&#39;</span><span class="p">,</span> <span class="n">maskcope_third</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
<span class="n">wf_third</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">minmask_third</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">maskcope_third</span><span class="p">,</span> <span class="s1">&#39;in_file2&#39;</span><span class="p">)</span>
<span class="n">wf_third</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">varcopemerge_third</span><span class="p">,</span> <span class="s1">&#39;merged_file&#39;</span><span class="p">,</span> <span class="n">maskvarcope_third</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
<span class="n">wf_third</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">minmask_third</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">maskvarcope_third</span><span class="p">,</span> <span class="s1">&#39;in_file2&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="set-up-third-level-contrasts">
<h3>Set up third-level contrasts<a class="headerlink" href="#set-up-third-level-contrasts" title="Link to this heading">#</a></h3>
<p>Since we only have a single-group set-up, we can actually use <a class="reference external" href="https://nipype.readthedocs.io/en/latest/api/generated/nipype.interfaces.fsl.model.html#l2model">L2Model</a>.
If we have an ANOVA-like design, using <a class="reference external" href="https://nipype.readthedocs.io/en/latest/api/generated/nipype.interfaces.fsl.model.html#multipleregressdesign">MultipleRegressDesign</a> would be a better option.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">num_copes</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

<span class="n">level3model</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">L2Model</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;l3model&#39;</span><span class="p">)</span>
<span class="n">wf_third</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dg_third</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;copes&#39;</span><span class="p">,</span><span class="n">num_copes</span><span class="p">),</span> <span class="n">level3model</span><span class="p">,</span> <span class="s1">&#39;num_copes&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">level3estimate</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FLAMEO</span><span class="p">(</span><span class="n">run_mode</span><span class="o">=</span><span class="s1">&#39;flame1&#39;</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;level3estimate&quot;</span><span class="p">,</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cope_file&#39;</span><span class="p">,</span> <span class="s1">&#39;var_cope_file&#39;</span><span class="p">])</span>

<span class="n">wf_third</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
    <span class="p">(</span><span class="n">maskcope_third</span><span class="p">,</span> <span class="n">level3estimate</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;cope_file&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">maskvarcope_third</span><span class="p">,</span> <span class="n">level3estimate</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;var_cope_file&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">minmask_third</span><span class="p">,</span> <span class="n">level3estimate</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;mask_file&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">level3model</span><span class="p">,</span> <span class="n">level3estimate</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;design_mat&#39;</span><span class="p">,</span> <span class="s1">&#39;design_file&#39;</span><span class="p">),</span>
                                   <span class="p">(</span><span class="s1">&#39;design_con&#39;</span><span class="p">,</span> <span class="s1">&#39;t_con_file&#39;</span><span class="p">),</span> 
                                   <span class="p">(</span><span class="s1">&#39;design_grp&#39;</span><span class="p">,</span> <span class="s1">&#39;cov_split_file&#39;</span><span class="p">)]),</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="post-stats">
<h3>Post-Stats<a class="headerlink" href="#post-stats" title="Link to this heading">#</a></h3>
<section id="smoothness-estimation">
<h4>Smoothness estimation<a class="headerlink" href="#smoothness-estimation" title="Link to this heading">#</a></h4>
<p>to get <code class="docutils literal notranslate"><span class="pre">dlh</span></code> and <code class="docutils literal notranslate"><span class="pre">volume</span></code> for thresholding
<strong>Corresponding FSL command:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">smoothest</span> <span class="o">-</span><span class="n">d</span> <span class="mi">25</span> <span class="o">-</span><span class="n">m</span> <span class="n">mask</span> <span class="o">-</span><span class="n">r</span> <span class="n">stats</span><span class="o">/</span><span class="n">res4d</span> <span class="o">&gt;</span> <span class="n">stats</span><span class="o">/</span><span class="n">smoothness</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">smoothest</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">SmoothEstimate</span><span class="p">(</span><span class="n">dof</span><span class="o">=</span><span class="mi">25</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;smoothest&quot;</span><span class="p">,</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;residual_fit_file&#39;</span><span class="p">,</span> <span class="s1">&#39;mask_file&#39;</span><span class="p">])</span>

<span class="n">wf_third</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">minmask_third</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">smoothest</span><span class="p">,</span> <span class="s1">&#39;mask_file&#39;</span><span class="p">)</span>
<span class="n">wf_third</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">level3estimate</span><span class="p">,</span> <span class="s1">&#39;res4d&#39;</span><span class="p">,</span> <span class="n">smoothest</span><span class="p">,</span> <span class="s1">&#39;residual_fit_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="mask-zstats-file">
<h4>Mask zstats file<a class="headerlink" href="#mask-zstats-file" title="Link to this heading">#</a></h4>
<p>preparation for thresholding</p>
<p><strong>Corresponding FSL command:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fslmaths</span> <span class="n">stats</span><span class="o">/</span><span class="n">zstat1</span> <span class="o">-</span><span class="n">mas</span> <span class="n">mask</span> <span class="n">thresh_zstat1</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">level3mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">op_string</span><span class="o">=</span><span class="s1">&#39;-mas&#39;</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">,</span><span class="s1">&#39;in_file2&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;level3mask&#39;</span><span class="p">)</span>

<span class="n">wf_third</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
    <span class="p">(</span><span class="n">level3estimate</span><span class="p">,</span><span class="n">level3mask</span><span class="p">,[(</span><span class="s1">&#39;zstats&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">minmask_third</span><span class="p">,</span> <span class="n">level3mask</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file2&#39;</span><span class="p">)]),</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="cluster-wise-thresholding">
<h4>Cluster-wise thresholding<a class="headerlink" href="#cluster-wise-thresholding" title="Link to this heading">#</a></h4>
<p><strong>Corresponding FSL command:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">cluster</span> <span class="o">-</span><span class="n">i</span> <span class="n">thresh_zstat1</span> <span class="o">-</span><span class="n">t</span> <span class="mf">3.1</span> <span class="o">--</span><span class="n">othresh</span><span class="o">=</span><span class="n">thresh_zstat1</span> <span class="o">-</span><span class="n">o</span> <span class="n">cluster_mask_zstat1</span> <span class="o">--</span><span class="n">connectivity</span><span class="o">=</span><span class="mi">26</span> <span class="o">--</span><span class="n">mm</span> <span class="o">--</span><span class="n">olmax</span><span class="o">=</span><span class="n">lmax_zstat1_std</span><span class="o">.</span><span class="n">txt</span> <span class="o">--</span><span class="n">scalarname</span><span class="o">=</span><span class="n">Z</span> <span class="o">-</span><span class="n">p</span> <span class="mf">0.05</span> <span class="o">-</span><span class="n">d</span> <span class="mf">0.0595781</span> <span class="o">--</span><span class="n">volume</span><span class="o">=</span><span class="mi">254734</span> <span class="o">-</span><span class="n">c</span> <span class="n">stats</span><span class="o">/</span><span class="n">cope1</span> <span class="o">&gt;</span> <span class="n">cluster_zstat1_std</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">level3threshold</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">Cluster</span><span class="p">(</span><span class="n">threshold</span> <span class="o">=</span> <span class="mf">3.1</span><span class="p">,</span>
                              <span class="n">pthreshold</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
                              <span class="n">use_mm</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                              <span class="n">out_threshold_file</span> <span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">out_index_file</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                              <span class="n">out_localmax_txt_file</span> <span class="o">=</span> <span class="kc">True</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">,</span><span class="s1">&#39;cope_file&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;level3threshold&#39;</span><span class="p">)</span>

<span class="n">wf_third</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
    <span class="p">(</span><span class="n">level3mask</span><span class="p">,</span> <span class="n">level3threshold</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">level3estimate</span><span class="p">,</span> <span class="n">level3threshold</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;copes&#39;</span><span class="p">,</span> <span class="s1">&#39;cope_file&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">smoothest</span><span class="p">,</span> <span class="n">level3threshold</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;dlh&#39;</span><span class="p">,</span> <span class="s1">&#39;dlh&#39;</span><span class="p">),</span>
                                   <span class="p">(</span><span class="s1">&#39;volume&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">)]),</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="save-the-output">
<h2>Save the output<a class="headerlink" href="#save-the-output" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">datasink_third</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">nio</span><span class="o">.</span><span class="n">DataSink</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sinker&#39;</span><span class="p">)</span>
<span class="n">datasink_third</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">base_directory</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exp_dir_third</span><span class="p">,</span> <span class="s2">&quot;level3_results&quot;</span><span class="p">)</span>

<span class="n">int2string</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;contrast_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    
<span class="n">wf_third</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">infosource_third</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;contr_id&#39;</span><span class="p">,</span><span class="n">int2string</span><span class="p">),</span> <span class="n">datasink_third</span><span class="p">,</span> <span class="s1">&#39;container&#39;</span><span class="p">)</span>
<span class="n">wf_third</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
    <span class="p">(</span><span class="n">level3estimate</span><span class="p">,</span> <span class="n">datasink_third</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;stats_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;stats_dir&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">level3threshold</span><span class="p">,</span> <span class="n">datasink_third</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;threshold_file&#39;</span><span class="p">,</span> <span class="s1">&#39;thresholded&#39;</span><span class="p">),</span>
                                <span class="p">(</span><span class="s1">&#39;localmax_txt_file&#39;</span><span class="p">,</span> <span class="s1">&#39;localmax_txt&#39;</span><span class="p">),</span>
                                <span class="p">(</span><span class="s1">&#39;index_file&#39;</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">)]),</span>
           <span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create 1st-level analysis output graph</span>
<span class="n">wf_third</span><span class="o">.</span><span class="n">write_graph</span><span class="p">(</span><span class="n">graph2use</span><span class="o">=</span><span class="s1">&#39;colored&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">simple_form</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Visualize the graph</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
<span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wf_third</span><span class="o">.</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">wf_third</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;graph.png&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f6d933650d8d90cff1ad80495d24bee603aaad2d482c8980c12a08ab8c126985.png" src="../_images/f6d933650d8d90cff1ad80495d24bee603aaad2d482c8980c12a08ab8c126985.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>
<span class="c1"># Run Workflow</span>
<span class="n">wf_third</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">plugin</span><span class="o">=</span><span class="s2">&quot;MultiProc&quot;</span><span class="p">,</span> <span class="n">plugin_args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;n_procs&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="unthresholded-copes">
<h2>Unthresholded COPEs<a class="headerlink" href="#unthresholded-copes" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nipype_cope1</span> <span class="o">=</span> <span class="s1">&#39;./output_level3/level3_results/contrast_1/stats_dir/_contr_id_1/stats/cope1.nii.gz&#39;</span>
<span class="n">nipype_cope2</span> <span class="o">=</span> <span class="s1">&#39;./output_level3/level3_results/contrast_2/stats_dir/_contr_id_2/stats/cope1.nii.gz&#39;</span>
<span class="n">nipype_cope3</span> <span class="o">=</span> <span class="s1">&#39;./output_level3/level3_results/contrast_3/stats_dir/_contr_id_3/stats/cope1.nii.gz&#39;</span>
<span class="n">nipype_cope4</span> <span class="o">=</span> <span class="s1">&#39;./output_level3/level3_results/contrast_4/stats_dir/_contr_id_4/stats/cope1.nii.gz&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_scroll-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t_nipype_cope1</span> <span class="o">=</span> <span class="n">surface</span><span class="o">.</span><span class="n">vol_to_surf</span><span class="p">(</span><span class="n">nipype_cope1</span><span class="p">,</span> <span class="n">fsaverage</span><span class="o">.</span><span class="n">pial_right</span><span class="p">)</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">plot_surf_stat_map</span><span class="p">(</span>
        <span class="n">fsaverage</span><span class="o">.</span><span class="n">infl_right</span><span class="p">,</span> <span class="n">t_nipype_cope1</span><span class="p">,</span> <span class="n">hemi</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Nipype - COPE1&quot;</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">bg_map</span><span class="o">=</span><span class="n">fsaverage</span><span class="o">.</span><span class="n">sulc_right</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="n">t_nipype_cope2</span> <span class="o">=</span> <span class="n">surface</span><span class="o">.</span><span class="n">vol_to_surf</span><span class="p">(</span><span class="n">nipype_cope2</span><span class="p">,</span> <span class="n">fsaverage</span><span class="o">.</span><span class="n">pial_right</span><span class="p">)</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">plot_surf_stat_map</span><span class="p">(</span>
        <span class="n">fsaverage</span><span class="o">.</span><span class="n">infl_right</span><span class="p">,</span> <span class="n">t_nipype_cope2</span><span class="p">,</span> <span class="n">hemi</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Nipype - COPE2&quot;</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">bg_map</span><span class="o">=</span><span class="n">fsaverage</span><span class="o">.</span><span class="n">sulc_right</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="n">t_nipype_cope3</span> <span class="o">=</span> <span class="n">surface</span><span class="o">.</span><span class="n">vol_to_surf</span><span class="p">(</span><span class="n">nipype_cope3</span><span class="p">,</span> <span class="n">fsaverage</span><span class="o">.</span><span class="n">pial_right</span><span class="p">)</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">plot_surf_stat_map</span><span class="p">(</span>
        <span class="n">fsaverage</span><span class="o">.</span><span class="n">infl_right</span><span class="p">,</span> <span class="n">t_nipype_cope3</span><span class="p">,</span> <span class="n">hemi</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Nipype - COPE3&quot;</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">bg_map</span><span class="o">=</span><span class="n">fsaverage</span><span class="o">.</span><span class="n">sulc_right</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="n">t_nipype_cope4</span> <span class="o">=</span> <span class="n">surface</span><span class="o">.</span><span class="n">vol_to_surf</span><span class="p">(</span><span class="n">nipype_cope4</span><span class="p">,</span> <span class="n">fsaverage</span><span class="o">.</span><span class="n">pial_right</span><span class="p">)</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">plot_surf_stat_map</span><span class="p">(</span>
        <span class="n">fsaverage</span><span class="o">.</span><span class="n">infl_right</span><span class="p">,</span> <span class="n">t_nipype_cope4</span><span class="p">,</span> <span class="n">hemi</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Nipype - COPE4&quot;</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">bg_map</span><span class="o">=</span><span class="n">fsaverage</span><span class="o">.</span><span class="n">sulc_right</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/9d99f0e9955b0dd05bd8d559317160c66a6de377e9359720f72c5bb4f4097918.png" src="../_images/9d99f0e9955b0dd05bd8d559317160c66a6de377e9359720f72c5bb4f4097918.png" />
<img alt="../_images/d7597b8a3c27323bc61b31d52aa0de87050572be410b321db85b3bd4b3bcd6c7.png" src="../_images/d7597b8a3c27323bc61b31d52aa0de87050572be410b321db85b3bd4b3bcd6c7.png" />
<img alt="../_images/adddb5a70e683d8dd2c61d0019fe2562e1f6ac10cae42a4e3c8ad20c8b975a20.png" src="../_images/adddb5a70e683d8dd2c61d0019fe2562e1f6ac10cae42a4e3c8ad20c8b975a20.png" />
<img alt="../_images/5651903fdea6b4f5ffdf0559b002e441a00e392a76b731d15f48b84997347ba8.png" src="../_images/5651903fdea6b4f5ffdf0559b002e441a00e392a76b731d15f48b84997347ba8.png" />
</div>
</div>
<section id="thresholded-p-0-05-zstats">
<h3>Thresholded (p &lt; 0.05) zstats<a class="headerlink" href="#thresholded-p-0-05-zstats" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nipype_cope1</span> <span class="o">=</span> <span class="s1">&#39;./output_level3/level3_results/contrast_1/thresholded/_contr_id_1/zstat1_maths_threshold.nii.gz&#39;</span>
<span class="n">nipype_cope2</span> <span class="o">=</span> <span class="s1">&#39;./output_level3/level3_results/contrast_2/thresholded/_contr_id_2/zstat1_maths_threshold.nii.gz&#39;</span>
<span class="n">nipype_cope3</span> <span class="o">=</span> <span class="s1">&#39;./output_level3/level3_results/contrast_3/thresholded/_contr_id_3/zstat1_maths_threshold.nii.gz&#39;</span>
<span class="n">nipype_cope4</span> <span class="o">=</span> <span class="s1">&#39;./output_level3/level3_results/contrast_4/thresholded/_contr_id_4/zstat1_maths_threshold.nii.gz&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_scroll-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plotting</span><span class="o">.</span><span class="n">plot_img_on_surf</span><span class="p">(</span><span class="n">nipype_cope1</span><span class="p">,</span>
                          <span class="n">views</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lateral&#39;</span><span class="p">],</span>
                          <span class="n">hemispheres</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">],</span>
                          <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Nipype - Thresholded-zstats1&quot;</span><span class="p">,</span>
                          <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;hot&#39;</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plotting</span><span class="o">.</span><span class="n">plot_img_on_surf</span><span class="p">(</span><span class="n">nipype_cope2</span><span class="p">,</span>
                          <span class="n">views</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lateral&#39;</span><span class="p">],</span>
                          <span class="n">hemispheres</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">],</span>
                          <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Nipype - Thresholded-zstats2&quot;</span><span class="p">,</span>
                          <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;hot&#39;</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plotting</span><span class="o">.</span><span class="n">plot_img_on_surf</span><span class="p">(</span><span class="n">nipype_cope3</span><span class="p">,</span>
                          <span class="n">views</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lateral&#39;</span><span class="p">],</span>
                          <span class="n">hemispheres</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">],</span>
                          <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Nipype - Thresholded-zstats3&quot;</span><span class="p">,</span>
                          <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;hot&#39;</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plotting</span><span class="o">.</span><span class="n">plot_img_on_surf</span><span class="p">(</span><span class="n">nipype_cope4</span><span class="p">,</span>
                          <span class="n">views</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lateral&#39;</span><span class="p">],</span>
                          <span class="n">hemispheres</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">],</span>
                          <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Nipype - Thresholded-zstats4&quot;</span><span class="p">,</span>
                          <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;hot&#39;</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/fb44e1fce4b4aab248a9c23a766496b0ae3d3a104c9054a833deabfe36ca12fb.png" src="../_images/fb44e1fce4b4aab248a9c23a766496b0ae3d3a104c9054a833deabfe36ca12fb.png" />
<img alt="../_images/8bf8c54cf56c7f18bb0a200f880e178dee70af1d7c477399c23b256b93613fe2.png" src="../_images/8bf8c54cf56c7f18bb0a200f880e178dee70af1d7c477399c23b256b93613fe2.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/conda/lib/python3.10/site-packages/nilearn/plotting/surf_plotting.py:508: RuntimeWarning: invalid value encountered in divide
  data_copy /= (vmax - vmin)
/opt/conda/lib/python3.10/site-packages/nilearn/plotting/surf_plotting.py:508: RuntimeWarning: invalid value encountered in divide
  data_copy /= (vmax - vmin)
</pre></div>
</div>
<img alt="../_images/4aadca3f2e660e46196def100e021dc4db585c30a8b4e71524abd670845dfda0.png" src="../_images/4aadca3f2e660e46196def100e021dc4db585c30a8b4e71524abd670845dfda0.png" />
<img alt="../_images/9d70c80cfc750d580eb4474d3170e9b10a99cba2169c59df8bfa05f407a61f98.png" src="../_images/9d70c80cfc750d580eb4474d3170e9b10a99cba2169c59df8bfa05f407a61f98.png" />
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./functional_imaging"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="intro_to_preprocessing.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Introduction to Preprocessing</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">FSL’s fMRI Data Analysis via Nipype</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#setup-neurodesk">Setup Neurodesk</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#first-level-glm-using-nipype-fsl">First-level GLM using Nipype FSL</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preparation">Preparation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up-data-path">Set up data path</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#start-the-workflow">Start the workflow</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#initialisation">Initialisation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preprocessing">Preprocessing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#motion-correction">Motion Correction</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#functionally-masking">Functionally Masking</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#grand-mean-scaling">Grand Mean Scaling</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#susan-noise-reduction">SUSAN Noise Reduction</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#temporal-filtering">Temporal Filtering</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#first-level-glm">First-Level GLM</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#get-events">Get events</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up-contrasts">Set-up contrasts</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#registration">Registration</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1">Step 1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2">Step 2</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-first-level-glm">The first-level GLM</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#second-level-glm-using-nipype-fsl">Second level GLM using Nipype FSL</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#second-level-glm">Second-level GLM</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#higher-level-input-files-preparation">Higher-level input files preparation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-merge-registered-copes-varcopes-masks">Step 1: Merge registered copes &amp; varcopes &amp; masks</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-making-mask">Step 2: Making mask</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-masking-copes-varcopes">Step 3: Masking copes &amp; varcopes</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up-second-level-contrasts-and-fixed-effects">Set up second-level contrasts and fixed-effects</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-second-level-glm">The second-level GLM</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#regapply">Regapply</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#copes-from-the-second-level-glm">Copes from the second-level GLM</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#third-level-glm-using-nipype-fsl">Third-level GLM using Nipype FSL</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#third-level-glm">Third-level GLM</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Higher-level input files preparation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Step 1: Merge registered copes &amp; varcopes &amp; masks</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Step 2: Making mask</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Step 3: Masking copes &amp; varcopes</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up-third-level-contrasts">Set up third-level contrasts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#post-stats">Post-Stats</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#smoothness-estimation">Smoothness estimation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#mask-zstats-file">Mask zstats file</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cluster-wise-thresholding">Cluster-wise thresholding</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#save-the-output">Save the output</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#unthresholded-copes">Unthresholded COPEs</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#thresholded-p-0-05-zstats">Thresholded (p &lt; 0.05) zstats</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Neurodesk Team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>