

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>MRtrix3Tissue &#8212; Neurodesk</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-4Z9774J59Y"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-4Z9774J59Y');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'mrtrix3tissue';</script>
    <link rel="canonical" href="https://neurodesk.github.io/example-notebooks/intro.html/mrtrix3tissue.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="#">
  
  
  
  
  
  
    <p class="title logo__title">Neurodesk</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1 current active">
                <a class="reference internal" href="#">
                    MRtrix3Tissue
                </a>
            </li>
        </ul>
        
    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/NeuroDesk/example-notebooks/blob/main/books/mrtrix3tissue.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/NeuroDesk/example-notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/NeuroDesk/example-notebooks/edit/main/books/mrtrix3tissue.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/NeuroDesk/example-notebooks/issues/new?title=Issue%20on%20page%20%2Fmrtrix3tissue.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/mrtrix3tissue.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>MRtrix3Tissue</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup-neurodesk">Setup Neurodesk</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-preparation">Data preparation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#convert-to-mif-file">Convert to .mif file</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preprocessing">Preprocessing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#denoising-and-gibbs-ringing-removal-unringing">Denoising and Gibbs ringing removal (“unringing”)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#motion-and-distortion-correction">Motion and distortion correction</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#bias-field-correction">Bias field correction</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#brain-mask-estimation">Brain mask estimation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#decomposition">Decomposition</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tissue-response-function-estimation">3-tissue response function estimation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#upsampling">Upsampling</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tissue-csd-modelling">3-tissue CSD modelling</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tissue-bias-field-and-intensity-normalisation">3-tissue bias field and intensity normalisation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#temperature-computation">Temperature computation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#get-csf-mask">Get CSF mask</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-diffusion-coefficient-in-csf">Calculate diffusion coefficient in CSF</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#temperature-estimation">Temperature estimation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualization">Visualization</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <p><a href="https://colab.research.google.com/github/NeuroDesk/example-notebooks/blob/main/diffusion_imaging/mrtrix3tissue.ipynb" target="_parent"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg" />   </a></p>
<section id="mrtrix3tissue">
<h1>MRtrix3Tissue<a class="headerlink" href="#mrtrix3tissue" title="Permalink to this heading">#</a></h1>
<p>Author: Thuy Dao</p>
<p>Citation: 3tissue.github.io/about.html</p>
<section id="setup-neurodesk">
<h2>Setup Neurodesk<a class="headerlink" href="#setup-neurodesk" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%capture
import os
import sys
IN_COLAB = &#39;google.colab&#39; in sys.modules

if IN_COLAB:
  os.environ[&quot;LD_PRELOAD&quot;] = &quot;&quot;;
  os.environ[&quot;APPTAINER_BINDPATH&quot;] = &quot;/content,/tmp,/cvmfs&quot;
  os.environ[&quot;MPLCONFIGDIR&quot;] = &quot;/content/matplotlib-mpldir&quot;
  os.environ[&quot;LMOD_CMD&quot;] = &quot;/usr/share/lmod/lmod/libexec/lmod&quot;

  !curl -J -O https://raw.githubusercontent.com/NeuroDesk/neurocommand/main/googlecolab_setup.sh
  !chmod +x googlecolab_setup.sh
  !./googlecolab_setup.sh

  os.environ[&quot;MODULEPATH&quot;] = &#39;:&#39;.join(map(str, list(map(lambda x: os.path.join(os.path.abspath(&#39;/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/&#39;), x),os.listdir(&#39;/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/&#39;)))))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Output CPU information:</span>
<span class="o">!</span>cat /proc/cpuinfo <span class="p">|</span> grep <span class="s1">&#39;vendor&#39;</span> <span class="p">|</span> uniq
<span class="o">!</span>cat /proc/cpuinfo <span class="p">|</span> grep <span class="s1">&#39;model name&#39;</span> <span class="p">|</span> uniq
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>vendor_id	: AuthenticAMD
model name	: AMD EPYC-Rome Processor
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load fmriprep</span>
<span class="kn">import</span> <span class="nn">lmod</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="k">await</span> <span class="n">lmod</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;mrtrix3tissue/5.2.8&#39;</span><span class="p">)</span>
<span class="k">await</span> <span class="n">lmod</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;Lmod&#39;,
 &#39;Warning:&#39;,
 &#39;The&#39;,
 &#39;environment&#39;,
 &#39;MODULEPATH&#39;,
 &#39;has&#39;,
 &#39;been&#39;,
 &#39;changed&#39;,
 &#39;in&#39;,
 &#39;unexpected&#39;,
 &#39;ways.&#39;,
 &#39;Lmod&#39;,
 &#39;is&#39;,
 &#39;unable&#39;,
 &#39;to&#39;,
 &#39;use&#39;,
 &#39;given&#39;,
 &#39;MODULEPATH.&#39;,
 &#39;It&#39;,
 &#39;is&#39;,
 &#39;using:&#39;,
 &#39;&quot;/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/functional_imaging:/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/rodent_imaging:/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/image_registration:/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/structural_imaging:/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/image_segmentation:/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/quantitative_imaging:/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/workflows:/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/hippocampus:/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/image_reconstruction:/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/data_organisation:/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/electrophysiology:/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/phase_processing:/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/programming:/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/machine_learning:/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/diffusion_imaging:/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/body:/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/visualization:/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/spectroscopy:/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/quality_control:/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/statistics:/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/shape_analysis:/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/spine:/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/molecular_biology:/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/bids_apps:/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/cryo_EM::&quot;.&#39;,
 &#39;Please&#39;,
 &#39;use&#39;,
 &#39;&quot;module&#39;,
 &#39;use&#39;,
 &#39;to&#39;,
 &#39;change&#39;,
 &#39;MODULEPATH&#39;,
 &#39;instead.&#39;,
 &#39;mrtrix3tissue/5.2.8&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="data-preparation">
<h2>Data preparation<a class="headerlink" href="#data-preparation" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># download data</span>
<span class="o">!</span>datalad install https://github.com/OpenNeuroDatasets/ds002080.git
<span class="o">!</span><span class="nb">cd</span> ds002080 <span class="o">&amp;&amp;</span> datalad get sub-CON02
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Clone attempt:   0%|              | 0.00/2.00 [00:00&lt;?, ? Candidate locations/s]
Enumerating: 0.00 Objects [00:00, ? Objects/s]
                                              
Counting:   0%|                              | 0.00/20.6k [00:00&lt;?, ? Objects/s]
                                                                                
Compressing:   0%|                           | 0.00/12.7k [00:00&lt;?, ? Objects/s]
                                                                                
Receiving:   0%|                             | 0.00/22.6k [00:00&lt;?, ? Objects/s]
Receiving:  36%|███████▏            | 8.12k/22.6k [00:00&lt;00:00, 80.6k Objects/s]
Receiving:  72%|██████████████▍     | 16.2k/22.6k [00:00&lt;00:00, 78.4k Objects/s]
                                                                                
Resolving:   0%|                              | 0.00/5.65k [00:00&lt;?, ? Deltas/s]
[INFO   ] scanning for unlocked files (this may take some time) 
[INFO   ] Remote origin not usable by git-annex; setting annex-ignore 
<span class=" -Color -Color-Bold">install</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): /storage/tmp/tmpufcuvdir/ds002080 (<span class=" -Color -Color-Bold -Color-Bold-Magenta">dataset</span>)
Total:   0%|                                   | 0.00/97.7M [00:00&lt;?, ? Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:   0%|            | 0.00/8.06M [00:00&lt;?, ? Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:   1%|    | 50.7k/8.06M [00:00&lt;00:35, 226k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:   1%|     | 103k/8.06M [00:00&lt;00:34, 228k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:   3%|▏    | 225k/8.06M [00:00&lt;00:21, 370k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:   6%|▎    | 451k/8.06M [00:00&lt;00:11, 644k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:  11%|▍   | 904k/8.06M [00:01&lt;00:06, 1.15M Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:  22%|▋  | 1.81M/8.06M [00:01&lt;00:02, 2.13M Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:  36%|█  | 2.94M/8.06M [00:01&lt;00:01, 3.77M Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:  45%|█▎ | 3.62M/8.06M [00:01&lt;00:01, 4.17M Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:  61%|█▊ | 4.92M/8.06M [00:01&lt;00:00, 6.05M Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:  73%|██▏| 5.85M/8.06M [00:01&lt;00:00, 6.45M Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:  90%|██▋| 7.28M/8.06M [00:01&lt;00:00, 8.31M Bytes/s]
Total:   8%|██▏                       | 8.06M/97.7M [00:05&lt;01:03, 1.42M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:   0%|            | 0.00/48.5M [00:00&lt;?, ? Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:   5%|▏  | 2.60M/48.5M [00:00&lt;00:03, 13.0M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:   8%|▏  | 4.03M/48.5M [00:00&lt;00:03, 13.5M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  13%|▍  | 6.07M/48.5M [00:00&lt;00:03, 11.7M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  17%|▌  | 8.23M/48.5M [00:00&lt;00:03, 11.2M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  22%|▋  | 10.7M/48.5M [00:00&lt;00:03, 11.0M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  27%|▊  | 13.2M/48.5M [00:01&lt;00:03, 11.0M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  32%|▉  | 15.6M/48.5M [00:01&lt;00:03, 10.9M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  37%|█  | 17.9M/48.5M [00:01&lt;00:02, 10.7M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  39%|█▏ | 19.0M/48.5M [00:01&lt;00:02, 10.2M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  42%|█▎ | 20.4M/48.5M [00:01&lt;00:02, 11.0M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  47%|█▍ | 22.8M/48.5M [00:02&lt;00:02, 10.8M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  52%|█▌ | 25.3M/48.5M [00:02&lt;00:02, 10.8M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  57%|█▋ | 27.6M/48.5M [00:02&lt;00:01, 10.7M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  62%|█▊ | 30.1M/48.5M [00:02&lt;00:01, 10.7M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  67%|██ | 32.5M/48.5M [00:02&lt;00:01, 10.6M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  72%|██▏| 34.8M/48.5M [00:03&lt;00:01, 10.5M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  77%|██▎| 37.2M/48.5M [00:03&lt;00:01, 10.6M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  82%|██▍| 39.6M/48.5M [00:03&lt;00:00, 10.5M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  87%|██▌| 41.9M/48.5M [00:03&lt;00:00, 10.5M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  92%|██▋| 44.4M/48.5M [00:04&lt;00:00, 10.5M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  97%|██▉| 46.8M/48.5M [00:04&lt;00:00, 10.6M Bytes/s]
Total:  58%|███████████████           | 56.5M/97.7M [00:11&lt;00:08, 5.13M Bytes/s]
Get sub-CON0 .. A_dwi.nii.gz:   0%|            | 0.00/1.18M [00:00&lt;?, ? Bytes/s]
Get sub-CON0 .. A_dwi.nii.gz:  51%|██  | 608k/1.18M [00:00&lt;00:00, 2.71M Bytes/s]
                                                                                
Get sub-CON0 .. _bold.nii.gz:   0%|            | 0.00/40.0M [00:00&lt;?, ? Bytes/s]
Get sub-CON0 .. _bold.nii.gz:   6%|▏  | 2.26M/40.0M [00:00&lt;00:03, 11.3M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:   9%|▎  | 3.51M/40.0M [00:00&lt;00:03, 11.8M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  14%|▍  | 5.52M/40.0M [00:00&lt;00:03, 9.52M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  18%|▌  | 7.21M/40.0M [00:00&lt;00:03, 8.53M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  21%|▌  | 8.31M/40.0M [00:00&lt;00:03, 8.66M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  23%|▋  | 9.24M/40.0M [00:01&lt;00:03, 8.78M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  29%|▊  | 11.6M/40.0M [00:01&lt;00:02, 9.48M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  35%|█  | 13.8M/40.0M [00:01&lt;00:02, 9.59M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  38%|█▏ | 15.3M/40.0M [00:01&lt;00:03, 7.09M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  42%|█▏ | 16.7M/40.0M [00:01&lt;00:02, 8.09M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  45%|█▎ | 17.8M/40.0M [00:02&lt;00:02, 8.35M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  48%|█▍ | 19.4M/40.0M [00:02&lt;00:02, 9.67M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  52%|█▌ | 20.9M/40.0M [00:02&lt;00:02, 8.63M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  58%|█▋ | 23.2M/40.0M [00:02&lt;00:01, 9.00M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  64%|█▉ | 25.5M/40.0M [00:03&lt;00:02, 7.09M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  67%|█▉ | 26.6M/40.0M [00:03&lt;00:01, 7.40M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  70%|██ | 28.1M/40.0M [00:03&lt;00:01, 8.45M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  74%|██▏| 29.7M/40.0M [00:03&lt;00:01, 8.04M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  79%|██▎| 31.4M/40.0M [00:03&lt;00:01, 7.89M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  82%|██▍| 33.0M/40.0M [00:03&lt;00:00, 7.61M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  87%|██▌| 35.0M/40.0M [00:04&lt;00:00, 7.94M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  92%|██▊| 36.7M/40.0M [00:04&lt;00:00, 7.90M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  96%|██▉| 38.5M/40.0M [00:04&lt;00:00, 7.92M Bytes/s]
<span class=" -Color -Color-Bold">get</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): sub-CON02/ses-postop/anat/sub-CON02_ses-postop_T1w.nii.gz (<span class=" -Color -Color-Bold -Color-Bold-Magenta">file</span>)
<span class=" -Color -Color-Bold">get</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): sub-CON02/ses-postop/dwi/sub-CON02_ses-postop_acq-AP_dwi.nii.gz (<span class=" -Color -Color-Bold -Color-Bold-Magenta">file</span>)
<span class=" -Color -Color-Bold">get</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): sub-CON02/ses-postop/dwi/sub-CON02_ses-postop_acq-PA_dwi.nii.gz (<span class=" -Color -Color-Bold -Color-Bold-Magenta">file</span>)
<span class=" -Color -Color-Bold">get</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): sub-CON02/ses-postop/func/sub-CON02_ses-postop_task-rest_bold.nii.gz (<span class=" -Color -Color-Bold -Color-Bold-Magenta">file</span>)
<span class=" -Color -Color-Bold">get</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): sub-CON02 (<span class=" -Color -Color-Bold -Color-Bold-Magenta">directory</span>)
action summary:
  get (ok: 5)

</pre></div>
</div>
</div>
</div>
<section id="convert-to-mif-file">
<h3>Convert to .mif file<a class="headerlink" href="#convert-to-mif-file" title="Permalink to this heading">#</a></h3>
<p>Once data is downloaded, it is recommended to import and store it as .mif file(s), the so-called “MRtrix Image Format”.</p>
<p><code class="docutils literal notranslate"><span class="pre">mrconvert</span></code> is the tool to convert between all sorts of image formats (or extract parts of images or change properties) and enables you to read from e.g. DICOM folders or NIfTI (.nii) images and store an image as a .mif file.</p>
<p>If your diffusion MRI data comes as a NIfTI (.nii) image instead, the gradient orientations and b-values will typically be stored in 2 separate files (a “bvecs” and “bvals” file).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>mrconvert ds002080/sub-CON02/ses-postop/dwi/sub-CON02_ses-postop_acq-AP_dwi.nii.gz AP.mif -fslgrad ds002080/sub-CON02/ses-postop/dwi/sub-CON02_ses-postop_acq-AP_dwi.bvec ds002080/sub-CON02/ses-postop/dwi/sub-CON02_ses-postop_acq-AP_dwi.bval
<span class="o">!</span>mrconvert ds002080/sub-CON02/ses-postop/dwi/sub-CON02_ses-postop_acq-PA_dwi.nii.gz PA.mif
<span class="o">!</span>mrconvert PA.mif -fslgrad ds002080/sub-CON02/ses-postop/dwi/sub-CON02_ses-postop_acq-PA_dwi.bvec ds002080/sub-CON02/ses-postop/dwi/sub-CON02_ses-postop_acq-PA_dwi.bval - <span class="p">|</span> mrmath - mean mean_b0_PA.mif -axis <span class="m">3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mrconvert: [100%] uncompressing image &quot;ds002080/sub-CON02/ses-postop/dwi/sub-CON02_ses-postop_acq-AP_dwi.nii.gz&quot;
mrconvert: [100%] copying from &quot;ds002080/s...es-postop_acq-AP_dwi.nii.gz&quot; to &quot;AP.mif&quot;
mrconvert: [100%] uncompressing image &quot;ds002080/sub-CON02/ses-postop/dwi/sub-CON02_ses-postop_acq-PA_dwi.nii.gz&quot;
mrconvert: [100%] copying from &quot;ds002080/s...es-postop_acq-PA_dwi.nii.gz&quot; to &quot;PA.mif&quot;
mrconvert: [100%] copying from &quot;PA.mif&quot; to &quot;/tmp/mrtrix-tmp-plszfT.mif&quot;
mrmath: [100%] preloading data for &quot;/tmp/mrtrix-tmp-plszfT.mif&quot;
mrmath: [100%] computing mean along axis 3...
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="preprocessing">
<h2>Preprocessing<a class="headerlink" href="#preprocessing" title="Permalink to this heading">#</a></h2>
<p>The following are common preprocessing steps done with MRtrix.</p>
<section id="denoising-and-gibbs-ringing-removal-unringing">
<h3>Denoising and Gibbs ringing removal (“unringing”)<a class="headerlink" href="#denoising-and-gibbs-ringing-removal-unringing" title="Permalink to this heading">#</a></h3>
<p>The first preprocessing step is denoise the data by using <code class="docutils literal notranslate"><span class="pre">dwidenoise</span></code> command. This requires an input and an output argument, and you also have the option to output the noise map with the <code class="docutils literal notranslate"><span class="pre">-noise</span></code> option.</p>
<p>The next step is to run <code class="docutils literal notranslate"><span class="pre">mrdegibbs</span></code>, which removes Gibbs’ ringing artifacts from the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>dwidenoise AP.mif dwi_denoised.mif -noise noise.mif
<span class="o">!</span>mrdegibbs dwi_denoised.mif dwi_denoised_unringed.mif
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dwidenoise: [100%] preloading data for &quot;AP.mif&quot;
dwidenoise: [100%] running MP-PCA denoising
mrdegibbs: [100%] performing Gibbs ringing removal
</pre></div>
</div>
</div>
</div>
<p>Next, we extract the b-values from the primary phase-encoded image using <code class="docutils literal notranslate"><span class="pre">dwiextract</span></code>.</p>
<p>If you have also scanned a pair of reverse phase-encoded b=0 images, you can correct for susceptibility-induced EPI distortions by concatenating the reverse phase-encoded b=0 images using <code class="docutils literal notranslate"><span class="pre">mrcat</span></code> to create a new image <code class="docutils literal notranslate"><span class="pre">b0_pair.mif</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>dwiextract dwi_denoised.mif - -bzero <span class="p">|</span> mrmath - mean mean_b0_AP.mif -axis <span class="m">3</span>
<span class="o">!</span>mrcat mean_b0_AP.mif mean_b0_PA.mif -axis <span class="m">3</span> b0_pair.mif
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dwiextract: [100%] extracting volumes
mrmath: [100%] preloading data for &quot;/tmp/mrtrix-tmp-jOO9hc.mif&quot;
mrmath: [100%] computing mean along axis 3...
mrcat: [100%] concatenating &quot;mean_b0_AP.mif&quot;
mrcat: [100%] concatenating &quot;mean_b0_PA.mif&quot;
</pre></div>
</div>
</div>
</div>
</section>
<section id="motion-and-distortion-correction">
<h3>Motion and distortion correction<a class="headerlink" href="#motion-and-distortion-correction" title="Permalink to this heading">#</a></h3>
<p>Motion and distortion correction are performed by the <code class="docutils literal notranslate"><span class="pre">dwifslpreproc</span></code> command, most of the heavy lifting is done automatically by FSL’s <code class="docutils literal notranslate"><span class="pre">topup</span></code> and <code class="docutils literal notranslate"><span class="pre">eddy</span></code> tools.</p>
<p><code class="docutils literal notranslate"><span class="pre">-pe_dir</span></code> option is used to tell dwifslpreproc the phase-encoding direction of the scan.</p>
<p><code class="docutils literal notranslate"> <span class="pre">-se_epi</span></code> is an additional image series consisting of spin-echo EPI images used by <code class="docutils literal notranslate"><span class="pre">topup</span></code> for estimating the inhomogeneity field</p>
<p><code class="docutils literal notranslate"><span class="pre">-eddy_options</span></code> is an additional command-line options to the <code class="docutils literal notranslate"><span class="pre">eddy</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>dwifslpreproc dwi_denoised_unringed.mif dwi_denoised_unringed_preproc.mif -pe_dir AP -rpe_pair -se_epi b0_pair.mif  -eddy_options <span class="s2">&quot; --slm=linear --data_is_shelled&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dwifslpreproc: 
dwifslpreproc: <span class=" -Color -Color-Green">Note that this script makes use of commands / algorithms that have relevant articles for citation; INCLUDING FROM EXTERNAL SOFTWARE PACKAGES. Please consult the help page (-help option) for more information.</span>
dwifslpreproc: 
dwifslpreproc: <span class=" -Color -Color-Green">Generated scratch directory: /storage/tmp/tmpufcuvdir/dwifslpreproc-tmp-SFYCZI/</span>
<span class=" -Color -Color-Cyan">Command:</span>  mrconvert /storage/tmp/tmpufcuvdir/dwi_denoised_unringed.mif /storage/tmp/tmpufcuvdir/dwifslpreproc-tmp-SFYCZI/dwi.mif -json_export /storage/tmp/tmpufcuvdir/dwifslpreproc-tmp-SFYCZI/dwi.json
<span class=" -Color -Color-Cyan">Command:</span>  mrconvert /storage/tmp/tmpufcuvdir/b0_pair.mif /storage/tmp/tmpufcuvdir/dwifslpreproc-tmp-SFYCZI/se_epi.mif
dwifslpreproc: <span class=" -Color -Color-Green">Changing to scratch directory (/storage/tmp/tmpufcuvdir/dwifslpreproc-tmp-SFYCZI/)</span>
dwifslpreproc: <span class=" -Color -Color-Green">Total readout time not provided at command-line; assuming sane default of 0.1</span>
<span class=" -Color -Color-Cyan">Command:</span>  mrinfo dwi.mif -export_grad_mrtrix grad.b
<span class=" -Color -Color-Cyan">Command:</span>  mrconvert se_epi.mif topup_in.nii -import_pe_table se_epi_manual_pe_scheme.txt -strides -1,+2,+3,+4 -export_pe_table topup_datain.txt
<span class=" -Color -Color-Cyan">Command:</span>  topup --imain=topup_in.nii --datain=topup_datain.txt --out=field --fout=field_map.nii.gz --config=/opt/fsl-6.0.3/etc/flirtsch/b02b0.cnf --verbose
<span class=" -Color -Color-Cyan">Command:</span>  mrconvert dwi.mif -import_pe_table dwi_manual_pe_scheme.txt - | mrinfo - -export_pe_eddy applytopup_config.txt applytopup_indices.txt
<span class=" -Color -Color-Cyan">Command:</span>  dwiextract dwi.mif -import_pe_table dwi_manual_pe_scheme.txt -pe 0.0,-1.0,0.0,0.1 - | mrconvert - dwi_pe_1.nii -json_export dwi_pe_1.json
<span class=" -Color -Color-Cyan">Command:</span>  applytopup --imain=dwi_pe_1.nii --datain=applytopup_config.txt --inindex=1 --topup=field --out=dwi_pe_1_applytopup.nii --method=jac
<span class=" -Color -Color-Cyan">Command:</span>  mrconvert dwi_pe_1_applytopup.nii.gz dwi_pe_1_applytopup.mif -json_import dwi_pe_1.json
<span class=" -Color -Color-Cyan">Command:</span>  dwi2mask dwi_pe_1_applytopup.mif - | maskfilter - dilate - | mrconvert - eddy_mask.nii -datatype float32 -strides -1,+2,+3
<span class=" -Color -Color-Cyan">Command:</span>  mrconvert dwi.mif -import_pe_table dwi_manual_pe_scheme.txt eddy_in.nii -strides -1,+2,+3,+4 -export_grad_fsl bvecs bvals -export_pe_eddy eddy_config.txt eddy_indices.txt
<span class=" -Color -Color-Cyan">Command:</span>  eddy_cuda9.1 --imain=eddy_in.nii --mask=eddy_mask.nii --acqp=eddy_config.txt --index=eddy_indices.txt --bvecs=bvecs --bvals=bvals --topup=field --slm=linear --data_is_shelled --out=dwi_post_eddy --verbose
dwifslpreproc: <span class=" -Color -Color-Green">CUDA version of &#39;eddy&#39; was not successful; attempting OpenMP version</span>
<span class=" -Color -Color-Cyan">Command:</span>  eddy_openmp --imain=eddy_in.nii --mask=eddy_mask.nii --acqp=eddy_config.txt --index=eddy_indices.txt --bvecs=bvecs --bvals=bvals --topup=field --slm=linear --data_is_shelled --out=dwi_post_eddy --verbose
<span class=" -Color -Color-Cyan">Command:</span>  mrconvert dwi_post_eddy.nii.gz result.mif -strides -1,2,3,4 -fslgrad dwi_post_eddy.eddy_rotated_bvecs bvals
<span class=" -Color -Color-Cyan">Command:</span>  mrconvert result.mif /storage/tmp/tmpufcuvdir/dwi_denoised_unringed_preproc.mif
dwifslpreproc: <span class=" -Color -Color-Green">Changing back to original directory (/storage/tmp/tmpufcuvdir)</span>
dwifslpreproc: <span class=" -Color -Color-Green">Deleting scratch directory (/storage/tmp/tmpufcuvdir/dwifslpreproc-tmp-SFYCZI/)</span>
</pre></div>
</div>
</div>
</div>
<section id="bias-field-correction">
<h4>Bias field correction<a class="headerlink" href="#bias-field-correction" title="Permalink to this heading">#</a></h4>
<p>You can correct for bias fields at this point in the pipeline with the <code class="docutils literal notranslate"><span class="pre">dwibiascorrect</span> <span class="pre">ants</span></code> command</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>dwibiascorrect ants dwi_denoised_unringed_preproc.mif dwi_denoised_unringed_preproc_unbiased.mif
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dwibiascorrect: 
dwibiascorrect: <span class=" -Color -Color-Green">Note that this script makes use of commands / algorithms that have relevant articles for citation; INCLUDING FROM EXTERNAL SOFTWARE PACKAGES. Please consult the help page (-help option) for more information.</span>
dwibiascorrect: 
dwibiascorrect: <span class=" -Color -Color-Green">Generated scratch directory: /storage/tmp/tmpufcuvdir/dwibiascorrect-tmp-JO3Z19/</span>
<span class=" -Color -Color-Cyan">Command:</span>  mrconvert /storage/tmp/tmpufcuvdir/dwi_denoised_unringed_preproc.mif /storage/tmp/tmpufcuvdir/dwibiascorrect-tmp-JO3Z19/in.mif
dwibiascorrect: <span class=" -Color -Color-Green">Changing to scratch directory (/storage/tmp/tmpufcuvdir/dwibiascorrect-tmp-JO3Z19/)</span>
<span class=" -Color -Color-Cyan">Command:</span>  dwi2mask in.mif mask.mif
<span class=" -Color -Color-Cyan">Command:</span>  dwiextract in.mif - -bzero | mrmath - mean mean_bzero.mif -axis 3
<span class=" -Color -Color-Cyan">Command:</span>  mrconvert mean_bzero.mif mean_bzero.nii -strides +1,+2,+3
<span class=" -Color -Color-Cyan">Command:</span>  mrconvert mask.mif mask.nii -strides +1,+2,+3
<span class=" -Color -Color-Cyan">Command:</span>  N4BiasFieldCorrection -d 3 -i mean_bzero.nii -w mask.nii -o [corrected.nii,init_bias.nii] -s 4 -b [100,3] -c [1000,0.0]
<span class=" -Color -Color-Cyan">Command:</span>  mrcalc mean_bzero.mif mask.mif -mult - | mrmath - sum - -axis 0 | mrmath - sum - -axis 1 | mrmath - sum - -axis 2 | mrdump -
<span class=" -Color -Color-Cyan">Command:</span>  mrcalc corrected.nii mask.mif -mult - | mrmath - sum - -axis 0 | mrmath - sum - -axis 1 | mrmath - sum - -axis 2 | mrdump -
<span class=" -Color -Color-Cyan">Command:</span>  mrcalc init_bias.nii 0.563258981198 -mult bias.mif
<span class=" -Color -Color-Cyan">Command:</span>  mrcalc in.mif bias.mif -div result.mif
<span class=" -Color -Color-Cyan">Command:</span>  mrconvert result.mif /storage/tmp/tmpufcuvdir/dwi_denoised_unringed_preproc_unbiased.mif
dwibiascorrect: <span class=" -Color -Color-Green">Changing back to original directory (/storage/tmp/tmpufcuvdir)</span>
dwibiascorrect: <span class=" -Color -Color-Green">Deleting scratch directory (/storage/tmp/tmpufcuvdir/dwibiascorrect-tmp-JO3Z19/)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="brain-mask-estimation">
<h3>Brain mask estimation<a class="headerlink" href="#brain-mask-estimation" title="Permalink to this heading">#</a></h3>
<p>A brain mask can be estimated automatically from the diffusion MRI data using <code class="docutils literal notranslate"><span class="pre">dwi2mask</span></code> as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>dwi2mask dwi_denoised_unringed_preproc_unbiased.mif dwi_mask.mif
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dwi2mask: [100%] preloading data for &quot;dwi_denoised_unringed_preproc_unbiased.mif&quot;
dwi2mask: [100%] finding min/max of &quot;mean b=0 image&quot;
dwi2mask: [done] optimising threshold
dwi2mask: [100%] thresholding
dwi2mask: [100%] finding min/max of &quot;mean b=700 image&quot;
dwi2mask: [done] optimising threshold
dwi2mask: [100%] thresholding
dwi2mask: [100%] finding min/max of &quot;mean b=1200 image&quot;
dwi2mask: [done] optimising threshold
dwi2mask: [100%] thresholding
dwi2mask: [100%] finding min/max of &quot;mean b=2800 image&quot;
dwi2mask: [done] optimising threshold
dwi2mask: [100%] thresholding
dwi2mask: [done] computing dwi brain mask
dwi2mask: [done] applying mask cleaning filter
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="decomposition">
<h2>Decomposition<a class="headerlink" href="#decomposition" title="Permalink to this heading">#</a></h2>
<section id="tissue-response-function-estimation">
<h3>3-tissue response function estimation<a class="headerlink" href="#tissue-response-function-estimation" title="Permalink to this heading">#</a></h3>
<p>An method to obtain 3-tissue response functions representing single-fibre white matter (WM), grey matter (GM) and CSF from the data itself, is available as the so-called <code class="docutils literal notranslate"><span class="pre">dwi2response</span> <span class="pre">dhollander</span></code> command from <code class="docutils literal notranslate"><span class="pre">MRtrix3Tissue</span></code> package.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>dwi2response dhollander dwi_denoised_unringed_preproc_unbiased.mif response_wm.txt response_gm.txt response_csf.txt
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dwi2response: 
dwi2response: <span class=" -Color -Color-Green">Note that this script makes use of commands / algorithms that have relevant articles for citation. Please consult the help page (-help option) for more information.</span>
dwi2response: 
dwi2response: <span class=" -Color -Color-Green">Generated scratch directory: /storage/tmp/tmpufcuvdir/dwi2response-tmp-08EMSA/</span>
dwi2response: <span class=" -Color -Color-Green">Importing DWI data (/storage/tmp/tmpufcuvdir/dwi_denoised_unringed_preproc_unbiased.mif)...</span>
dwi2response: <span class=" -Color -Color-Green">Changing to scratch directory (/storage/tmp/tmpufcuvdir/dwi2response-tmp-08EMSA/)</span>
dwi2response: <span class=" -Color -Color-Green">Computing brain mask (dwi2mask)...</span>
dwi2response: <span class=" -Color -Color-Green">-------</span>
dwi2response: <span class=" -Color -Color-Green">4 unique b-value(s) detected: 0,700,1200,2800 with 6,16,30,50 volumes</span>
dwi2response: <span class=" -Color -Color-Green">-------</span>
dwi2response: <span class=" -Color -Color-Green">Preparation:</span>
dwi2response: <span class=" -Color -Color-Green">* Eroding brain mask by 3 pass(es)...</span>
dwi2response: <span class=" -Color -Color-Green">  [ mask: 96503 -&gt; 69383 ]</span>
dwi2response: <span class=" -Color -Color-Green">* Computing signal decay metric (SDM):</span>
dwi2response: <span class=" -Color -Color-Green"> * b=0...</span>
dwi2response: <span class=" -Color -Color-Green"> * b=700...</span>
dwi2response: <span class=" -Color -Color-Green"> * b=1200...</span>
dwi2response: <span class=" -Color -Color-Green"> * b=2800...</span>
dwi2response: <span class=" -Color -Color-Green">* Removing erroneous voxels from mask and correcting SDM...</span>
dwi2response: <span class=" -Color -Color-Green">  [ mask: 69383 -&gt; 69383 ]</span>
dwi2response: <span class=" -Color -Color-Green">-------</span>
dwi2response: <span class=" -Color -Color-Green">Crude segmentation:</span>
dwi2response: <span class=" -Color -Color-Green">* Crude WM versus GM-CSF separation (at FA=0.2)...</span>
dwi2response: <span class=" -Color -Color-Green">  [ 69383 -&gt; 37142 (WM) &amp; 32241 (GM-CSF) ]</span>
dwi2response: <span class=" -Color -Color-Green">* Crude GM versus CSF separation...</span>
dwi2response: <span class=" -Color -Color-Green">  [ 32241 -&gt; 21484 (GM) &amp; 10757 (CSF) ]</span>
dwi2response: <span class=" -Color -Color-Green">-------</span>
dwi2response: <span class=" -Color -Color-Green">Refined segmentation:</span>
dwi2response: <span class=" -Color -Color-Green">* Refining WM...</span>
dwi2response: <span class=" -Color -Color-Green">  [ WM: 37142 -&gt; 33619 ]</span>
dwi2response: <span class=" -Color -Color-Green">* Refining GM...</span>
dwi2response: <span class=" -Color -Color-Green">  [ GM: 21484 -&gt; 12004 ]</span>
dwi2response: <span class=" -Color -Color-Green">* Refining CSF...</span>
dwi2response: <span class=" -Color -Color-Green">  [ CSF: 10757 -&gt; 5368 ]</span>
dwi2response: <span class=" -Color -Color-Green">-------</span>
dwi2response: <span class=" -Color -Color-Green">Final voxel selection and response function estimation:</span>
dwi2response: <span class=" -Color -Color-Green">* CSF:</span>
dwi2response: <span class=" -Color -Color-Green"> * Selecting final voxels (10.0% of refined CSF)...</span>
dwi2response: <span class=" -Color -Color-Green">   [ CSF: 5368 -&gt; 537 ]</span>
dwi2response: <span class=" -Color -Color-Green"> * Estimating response function...</span>
dwi2response: <span class=" -Color -Color-Green">* GM:</span>
dwi2response: <span class=" -Color -Color-Green"> * Selecting final voxels (2.0% of refined GM)...</span>
dwi2response: <span class=" -Color -Color-Green">   [ GM: 12004 -&gt; 240 ]</span>
dwi2response: <span class=" -Color -Color-Green"> * Estimating response function...</span>
dwi2response: <span class=" -Color -Color-Green">* single-fibre WM:</span>
dwi2response: <span class=" -Color -Color-Green"> * Selecting final voxels (0.5% of refined WM)...</span>
dwi2response: <span class=" -Color -Color-Green">   [ WM: 33619 -&gt; 168 (single-fibre) ]</span>
dwi2response: <span class=" -Color -Color-Green"> * Estimating response function...</span>
dwi2response: <span class=" -Color -Color-Green">-------</span>
dwi2response: <span class=" -Color -Color-Green">Generating outputs...</span>
dwi2response: <span class=" -Color -Color-Green">-------</span>
dwi2response: <span class=" -Color -Color-Green">Changing back to original directory (/storage/tmp/tmpufcuvdir)</span>
dwi2response: <span class=" -Color -Color-Green">Deleting scratch directory (/storage/tmp/tmpufcuvdir/dwi2response-tmp-08EMSA/)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="upsampling">
<h3>Upsampling<a class="headerlink" href="#upsampling" title="Permalink to this heading">#</a></h3>
<p>Upsampling your preprocessed diffusion MRI data before the 3-tissue constrained spherical deconvolution (3-tissue CSD) step to get a higher quality result. Upsampling is useful if you’re after a higher quality visualisation, which reveals finer details using <code class="docutils literal notranslate"><span class="pre">mrgrid</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>mrgrid dwi_denoised_unringed_preproc_unbiased.mif regrid dwi_denoised_unringed_preproc_unbiased_upsampled.mif -voxel <span class="m">1</span>.5
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mrgrid: [100%] reslicing &quot;dwi_denoised_unringed_preproc_unbiased.mif&quot;
</pre></div>
</div>
</div>
</div>
<p>After upsampling the image, you need to regrid the brain mask to the exact same voxel grid as the image via the <code class="docutils literal notranslate"><span class="pre">-template</span></code> option to <code class="docutils literal notranslate"><span class="pre">mrgrid</span></code>. If the regridding is effectively upsampling, you can avoid jagged edges around masks by performing linear interpolation <code class="docutils literal notranslate"><span class="pre">-interp</span> <span class="pre">linear</span></code>. Then a median filter the result using the <code class="docutils literal notranslate"><span class="pre">maskfilter</span></code> command. To perform all of this at once (without storing an intermediate image), you an directly “pipe” the output of mrgrid into the input of maskfilter, by replacing the output in the one command and the input in the other command by a dash (“-”), and typing a “pipe” (“|”) between both commands.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>mrgrid dwi_mask.mif regrid - -template dwi_denoised_unringed_preproc_unbiased_upsampled.mif -interp linear -datatype bit <span class="p">|</span> maskfilter - median dwi_mask_upsampled.mif
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mrgrid: [100%] reslicing &quot;dwi_mask.mif&quot;
maskfilter: [100%] applying median filter to image -
</pre></div>
</div>
</div>
</div>
</section>
<section id="tissue-csd-modelling">
<h3>3-tissue CSD modelling<a class="headerlink" href="#tissue-csd-modelling" title="Permalink to this heading">#</a></h3>
<p>Your data is now ready for 3-tissue CSD modelling with the previously obtained 3-tissue response functions, which will result in modelling the diffusion MRI data using WM-like (FOD), GM-like and CSF-like compartments. There are 2 different methods (or algorithms) available to perform 3-tissue CSD. The choice between both depends on what (part of your) data you intend to perform 3-tissue CSD modelling for.</p>
<p>If you want to perform 3-tissue CSD modelling for multi-shell data, this can be achieved using the multi-shell multi-tissue CSD (MSMT-CSD) method or algorithm, as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>dwi2fod msmt_csd dwi_denoised_unringed_preproc_unbiased_upsampled.mif response_wm.txt wmfod.mif response_gm.txt gm.mif response_csf.txt csf.mif -mask dwi_mask_upsampled.mif
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dwi2fod: [100%] preloading data for &quot;dwi_denoised_unringed_preproc_unbiased_upsampled.mif&quot;
dwi2fod: [100%] performing multi-shell, multi-tissue CSD
</pre></div>
</div>
</div>
</div>
</section>
<section id="tissue-bias-field-and-intensity-normalisation">
<h3>3-tissue bias field and intensity normalisation<a class="headerlink" href="#tissue-bias-field-and-intensity-normalisation" title="Permalink to this heading">#</a></h3>
<p>Bias field correction and global intensity normalisation can be performed using the <code class="docutils literal notranslate"><span class="pre">mtnormalise</span></code> command, as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>mtnormalise wmfod.mif wmfod_norm.mif gm.mif gm_norm.mif csf.mif csf_norm.mif -mask dwi_mask_upsampled.mif
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mtnormalise: [done] loading input images
mtnormalise: [100%] performing log-domain intensity normalisation
mtnormalise: [done] writing output images
mtnormalise: [100%] performing log-domain intensity normalisation
mtnormalise: [done] loading input images
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="temperature-computation">
<h2>Temperature computation<a class="headerlink" href="#temperature-computation" title="Permalink to this heading">#</a></h2>
<section id="get-csf-mask">
<h3>Get CSF mask<a class="headerlink" href="#get-csf-mask" title="Permalink to this heading">#</a></h3>
<p>You first need to get 2 CSF masks from 2 criteria:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">csf_mask1.mif</span></code> from CSF spherical harmonic coefficients applying the first criteria (aka the csf.mif file)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">csf_mask2.mif</span></code> from second criteria (note: 0.141047 might be half of max response function)</p></li>
</ul>
<p>Then find the overlap of both masks resulting in the final mask <code class="docutils literal notranslate"><span class="pre">csf_maskcombined.mif</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>mrconvert wmfod_norm.mif -coord <span class="m">3</span> <span class="m">0</span> -axes <span class="m">0</span>,1,2 - <span class="p">|</span> mrcalc csf_norm.mif gm_norm.mif - -add <span class="m">5</span> -mult -gt csf_mask1.mif -datatype bit
<span class="o">!</span>mrthreshold csf_norm.mif csf_mask2.mif -abs <span class="m">0</span>.141047
<span class="o">!</span>mrcalc csf_mask1.mif csf_mask2.mif -mult csf_maskcombined.mif -datatype bit
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mrconvert: [100%] copying from &quot;wmfod_norm.mif&quot; to &quot;/tmp/mrtrix-tmp-iN5KTw.mif&quot;
mrcalc: [100%] computing: (csf_norm.mif &gt; ((gm_norm.mif + /tmp/mrtrix-tmp-iN5KTw.mif) * 5))
mrthreshold: [100%] Determining and applying per-volume thresholds
mrcalc: [100%] computing: (csf_mask1.mif * csf_mask2.mif)
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculate-diffusion-coefficient-in-csf">
<h3>Calculate diffusion coefficient in CSF<a class="headerlink" href="#calculate-diffusion-coefficient-in-csf" title="Permalink to this heading">#</a></h3>
<p>First, we filter the processed image to exclude b-values over 1000 into a new image <code class="docutils literal notranslate"><span class="pre">reduced.mif</span></code>.</p>
<p>Next, estimate the Apparent Diffusion Coefficient (ADC) using <code class="docutils literal notranslate"><span class="pre">dwi2adc</span></code>.</p>
<p>Then we extract the coefficient from the second array in <code class="docutils literal notranslate"><span class="pre">dwi_adc.mif</span></code> to get D values.</p>
<p>Finally, we filter the D values within CSF using generated mask.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the index of b-values &lt; 1000 from table and write to txt file for next step</span>
<span class="n">bvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s2">&quot;ds002080/sub-CON02/ses-postop/dwi/sub-CON02_ses-postop_acq-AP_dwi.bval&quot;</span><span class="p">)</span>
<span class="n">bvals_filtered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bvals</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;bval_less_1000.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">txt_file</span><span class="p">:</span>
    <span class="n">txt_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bvals_filtered</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>mrconvert dwi_denoised_unringed_preproc_unbiased_upsampled.mif reduced.mif -coord <span class="m">3</span> <span class="k">$(</span>cat bval_less_1000.txt<span class="k">)</span>
<span class="o">!</span>dwi2adc reduced.mif dwi_adc.mif
<span class="o">!</span>mrconvert dwi_adc.mif extracted_adc.mif -coord <span class="m">3</span> <span class="m">1</span>
<span class="o">!!</span>mrcalc extracted_adc.mif csf_maskcombined.mif -mult masked_adc.mif
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mrconvert: [100%] copying from &quot;dwi_denois...proc_unbiased_upsampled.mif&quot; to &quot;reduced.mif&quot;
dwi2adc: [100%] computing ADC values
mrconvert: [100%] copying from &quot;dwi_adc.mif&quot; to &quot;extracted_adc.mif&quot;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;\x1b[?7l&#39;,
 &#39;mrcalc: [ 29%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 30%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 30%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 30%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 30%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 31%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 31%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 31%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 32%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 32%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 32%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 32%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 32%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 32%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 32%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 32%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 32%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 32%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 32%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 32%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 33%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 35%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 35%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 35%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 39%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 40%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 40%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 40%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 40%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 41%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 45%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 47%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 48%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 49%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 51%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 53%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 53%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 53%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 53%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 53%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 54%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 55%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 55%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 55%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 55%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 55%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 55%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 55%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 55%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 56%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 56%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 56%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 57%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 57%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 57%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 57%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 57%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 58%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 58%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 58%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 58%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 58%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 59%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 59%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 59%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 60%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 60%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 60%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 60%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 60%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 60%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 61%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 61%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 61%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 61%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 61%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 61%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 61%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 62%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 62%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 62%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 62%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 62%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 62%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 62%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 62%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 63%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 63%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 64%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 65%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 65%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 65%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 65%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 65%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 66%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 67%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 67%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 67%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 67%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 68%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 68%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 68%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 69%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 70%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 71%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 73%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 73%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 74%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 74%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 75%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 76%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 78%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 79%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 79%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 79%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 80%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 80%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 81%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 81%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 81%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 82%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 82%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 83%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 83%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 83%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 83%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 83%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 83%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 83%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 83%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 83%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 84%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 85%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 86%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 87%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 87%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 88%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 88%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 88%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 88%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 88%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 88%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 88%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 88%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 88%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 88%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 88%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 88%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 88%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 88%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 89%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 89%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 89%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 89%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 89%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 89%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 89%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 89%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 89%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 90%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 90%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 92%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 93%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 96%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 97%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 98%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 98%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [ 98%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h\x1b[?7l&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)... \x1b[0K\x1b[?7h&#39;,
 &#39;mrcalc: [100%] computing: (extracted_adc.mif * csf_maskcombined.mif)\x1b[0K&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="temperature-estimation">
<h3>Temperature estimation<a class="headerlink" href="#temperature-estimation" title="Permalink to this heading">#</a></h3>
<p>We calculate the temperature of cerebrospinal ﬂuid (CSF) using the following equation from <a class="reference external" href="https://analyticalsciencejournals.onlinelibrary.wiley.com/doi/10.1002/nbm.1656">this study</a>:</p>
<p>\begin{gather*}
T = \frac{2256.74}{\ln\left(\frac{4.39221}{D}\right)} - 273
\end{gather*}</p>
<p>where D is the diffusion constant.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>mrcalc <span class="m">2256</span>.74 <span class="m">4</span>.39221 masked_adc.mif -divide -log -divide <span class="m">273</span>.15 -subtract masked_temperature.mif
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mrcalc: [100%] computing: ((2256.74 / log ((4.39221 / masked_adc.mif))) - 273.15)
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="visualization">
<h2>Visualization<a class="headerlink" href="#visualization" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># File paths for both images</span>
<span class="n">mif_file_path1</span> <span class="o">=</span> <span class="s1">&#39;dwi_denoised_unringed_preproc_unbiased_upsampled.mif&#39;</span>  
<span class="n">mif_file_path2</span> <span class="o">=</span> <span class="s1">&#39;masked_temperature.mif&#39;</span>          

<span class="c1"># Convert both .mif files to temporary .nii.gz files with -force flag</span>
<span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.nii.gz&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_file1</span><span class="p">,</span> \
     <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.nii.gz&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_file2</span><span class="p">:</span>
         
    <span class="c1"># Convert main image</span>
    <span class="n">result1</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;mrconvert&quot;</span><span class="p">,</span> <span class="n">mif_file_path1</span><span class="p">,</span> <span class="n">temp_file1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;-force&quot;</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result1</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in mrconvert for preprocessed image: </span><span class="si">{</span><span class="n">result1</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">exit</span><span class="p">()</span>
    
    <span class="c1"># Convert overlay image</span>
    <span class="n">result2</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;mrconvert&quot;</span><span class="p">,</span> <span class="n">mif_file_path2</span><span class="p">,</span> <span class="n">temp_file2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;-force&quot;</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result2</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in mrconvert for original image: </span><span class="si">{</span><span class="n">result2</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">exit</span><span class="p">()</span>
         
    <span class="c1"># Load the converted images</span>
    <span class="n">nii_image1</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">temp_file1</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">nii_image2</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">temp_file2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="n">data1</span> <span class="o">=</span> <span class="n">nii_image1</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
    <span class="n">data2</span> <span class="o">=</span> <span class="n">nii_image2</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>

    <span class="c1"># Select middle slice </span>
    <span class="n">slice_index</span> <span class="o">=</span> <span class="n">data1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">//</span> <span class="mi">3</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

    <span class="c1"># Plot original diffusion data as overlay</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">data1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">slice_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greys_r&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span> 
    <span class="n">overlay</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">data2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">slice_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;hot&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">10</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span> 
    <span class="n">axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Preprocessed data with original diffusion data as overlay&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/09e50474e79daf20ad95ef552630402687e08a87ab5745b830ee3c398ea8fca1.png" src="_images/09e50474e79daf20ad95ef552630402687e08a87ab5745b830ee3c398ea8fca1.png" />
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup-neurodesk">Setup Neurodesk</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-preparation">Data preparation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#convert-to-mif-file">Convert to .mif file</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preprocessing">Preprocessing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#denoising-and-gibbs-ringing-removal-unringing">Denoising and Gibbs ringing removal (“unringing”)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#motion-and-distortion-correction">Motion and distortion correction</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#bias-field-correction">Bias field correction</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#brain-mask-estimation">Brain mask estimation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#decomposition">Decomposition</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tissue-response-function-estimation">3-tissue response function estimation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#upsampling">Upsampling</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tissue-csd-modelling">3-tissue CSD modelling</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tissue-bias-field-and-intensity-normalisation">3-tissue bias field and intensity normalisation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#temperature-computation">Temperature computation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#get-csf-mask">Get CSF mask</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-diffusion-coefficient-in-csf">Calculate diffusion coefficient in CSF</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#temperature-estimation">Temperature estimation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualization">Visualization</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Neurodesk Team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>