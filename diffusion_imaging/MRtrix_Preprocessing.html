
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Diffusion Analysis with MRtrix: Part 1 - Preprocessing &#8212; Neurodesk</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/algolia.css?v=353b52f6" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-4Z9774J59Y"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-4Z9774J59Y');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-4Z9774J59Y');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'diffusion_imaging/MRtrix_Preprocessing';</script>
    <script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3.3.3/dist/umd/index.js"></script>
    <script src="../_static/algolia.js?v=b553005c"></script>
    <link rel="canonical" href="https://neurodesk.github.io/example-notebooks/intro.html/diffusion_imaging/MRtrix_Preprocessing.html" />
    <link rel="icon" href="../_static/neurodesk_logo.svg"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="MRtrix3Tissue" href="mrtrix3tissue.html" />
    <link rel="prev" title="Diffusion Analysis with MRtrix: Part 2 - Constrained Spherical Deconvolution and Tissue estimation" href="MRtrix_CSD.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/neurodesk_logo.svg" class="logo__image only-light" alt="Neurodesk - Home"/>
    <script>document.write(`<img src="../_static/neurodesk_logo.svg" class="logo__image only-dark" alt="Neurodesk - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Neurodesk environment
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Workflows</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../workflows/MRIQC.html">MRIQC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../workflows/PyBIDS.html">PyBIDS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../workflows/RISE_slideshow.html">RISE Slideshow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../workflows/bids_conversion.html">BIDS conversion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../workflows/nipype_full.html">Nipype on Neurodesk</a></li>
<li class="toctree-l1"><a class="reference internal" href="../workflows/nipype_short.html">Basic Nipype</a></li>


</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Structural Imaging</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../structural_imaging/brain_extraction_different_tools.html">Different Brain Extraction Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../structural_imaging/freesurfer.html">Freesurfer</a></li>



<li class="toctree-l1"><a class="reference internal" href="../structural_imaging/qsmxt.html">QSMxT</a></li>








<li class="toctree-l1"><a class="reference internal" href="../structural_imaging/sct_toolbox.html">SCT Toolbox</a></li>


</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Diffusion Imaging</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="MRtrix_1.html">MRtrix: Part 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="MRtrix_3.html">MRtrix: Part 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="MRtrix_CSD.html">Diffusion Analysis with MRtrix: Part 2 - Constrained Spherical Deconvolution and Tissue estimation</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Diffusion Analysis with MRtrix: Part 1 - Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="mrtrix3tissue.html">MRtrix3Tissue</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Functional Imaging</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../functional_imaging/AFNI_preprocessing_and_glm.html">AFNI Preprocessing and GLM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functional_imaging/AFNI_preprocessing_only.html">AFNI Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functional_imaging/FSL_preproc_glm.html">FSL Preprocessing and GLM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functional_imaging/aslprep.html">ASLprep</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functional_imaging/deepretinotopy.html">DeepRetinotopy</a></li>



<li class="toctree-l1"><a class="reference internal" href="../functional_imaging/first_and_second_level_spm.html">First and Second Level fMRI Analysis with SPM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functional_imaging/fmriprep.html">fMRIprep</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functional_imaging/intro_to_preprocessing.html">Introduction to Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functional_imaging/nipype_fsl_all_levels_flanker.html">FSL’s fMRI Data Analysis via Nipype</a></li>




</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/NeuroDesk/example-notebooks/blob/main/books/diffusion_imaging/MRtrix_Preprocessing.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/NeuroDesk/example-notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/NeuroDesk/example-notebooks/edit/main/books/diffusion_imaging/MRtrix_Preprocessing.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/NeuroDesk/example-notebooks/issues/new?title=Issue%20on%20page%20%2Fdiffusion_imaging/MRtrix_Preprocessing.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/diffusion_imaging/MRtrix_Preprocessing.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Diffusion Analysis with MRtrix: Part 1 - Preprocessing</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#citation">Citation:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup-neurodesk">Setup Neurodesk</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#import-python-modules">Import Python Modules</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-packages">Load packages</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-the-dataset">Downloading the Dataset</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1"></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#looking-at-the-data">Looking at the Data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bvals-and-bvecs"><strong>Bvals and Bvecs</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualization"><strong>Visualization</strong></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preprocessing">Preprocessing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dwi-denoise">dwi_denoise</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mri-degibbs">mri_degibbs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dwipreproc">dwipreproc</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2"></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3"></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id4"></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-for-corrupt-slices">Checking for Corrupt Slices</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-a-mask">Generating a Mask</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <p><a href="https://colab.research.google.com/github/NeuroDesk/example-notebooks/blob/main/books/diffusion_imaging/MRtrix_Preprocessing.ipynb" target="_parent"><img alt="Open In Google Colab" src="https://colab.research.google.com/assets/colab-badge.svg" />   </a></p>
<section class="tex2jax_ignore mathjax_ignore" id="diffusion-analysis-with-mrtrix-part-1-preprocessing">
<h1>Diffusion Analysis with MRtrix: Part 1 - Preprocessing<a class="headerlink" href="#diffusion-analysis-with-mrtrix-part-1-preprocessing" title="Link to this heading">#</a></h1>
<p>This notebook is the first in a series on Diffusion Analysis using MRtrix. In this part, we will focus on loading, viewing and preprocessing steps essential for preparing diffusion MRI data for further analysis. Subsequent parts will cover additional topics, including Constrained Spherical Deconvolution (CSD) methods and tissue estimation and then finally registration and streamline fitting.</p>
<p><strong>Author:</strong> Monika Doerig</p>
<section id="citation">
<h2>Citation:<a class="headerlink" href="#citation" title="Link to this heading">#</a></h2>
<p><strong>Andy’s Brain Book:</strong></p>
<ul class="simple">
<li><p>This MRtrix example is based on the <a class="reference external" href="https://andysbrainbook.readthedocs.io/en/latest/MRtrix/MRtrix_Introduction.html#">Diffusion Analysis with MRtrix</a> chapter from Andy’s Brain Book (Jahn, 2022. <a class="reference external" href="https://zenodo.org/records/5879294">doi:10.5281/zenodo.5879293</a>)</p></li>
</ul>
<p><strong>Opensource Data from OpenNeuro:</strong></p>
<ul class="simple">
<li><p>Hannelore Aerts and Daniele Marinazzo (2018). BTC_preop. <a class="reference external" href="https://openneuro.org/datasets/ds001226/versions/00001">OpenNeuro Dataset ds001226</a></p></li>
</ul>
<p><strong>MRtrix3:</strong></p>
<ul class="simple">
<li><p>Tournier, J.-D.; Smith, R. E.; Raffelt, D.; Tabbara, R.; Dhollander, T.; Pietsch, M.; Christiaens, D.; Jeurissen, B.; Yeh, C.-H. &amp; Connelly, A. MRtrix3: A fast, flexible and open software framework for medical image processing and visualisation. NeuroImage, 2019, 202, 116137. https://doi.org/10.1016/j.neuroimage.2019.116137</p></li>
<li><p>For more details: https://www.mrtrix.org/</p></li>
</ul>
</section>
<section id="setup-neurodesk">
<h2>Setup Neurodesk<a class="headerlink" href="#setup-neurodesk" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="n">IN_COLAB</span> <span class="o">=</span> <span class="s1">&#39;google.colab&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span>

<span class="k">if</span> <span class="n">IN_COLAB</span><span class="p">:</span>
  <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;LD_PRELOAD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;APPTAINER_BINDPATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;/content,/tmp,/cvmfs&quot;</span>
  <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MPLCONFIGDIR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;/content/matplotlib-mpldir&quot;</span>
  <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;LMOD_CMD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;/usr/share/lmod/lmod/libexec/lmod&quot;</span>

  <span class="err">!</span><span class="n">curl</span> <span class="o">-</span><span class="n">J</span> <span class="o">-</span><span class="n">O</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">NeuroDesk</span><span class="o">/</span><span class="n">neurocommand</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">googlecolab_setup</span><span class="o">.</span><span class="n">sh</span>
  <span class="err">!</span><span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="n">googlecolab_setup</span><span class="o">.</span><span class="n">sh</span>
  <span class="err">!</span><span class="o">./</span><span class="n">googlecolab_setup</span><span class="o">.</span><span class="n">sh</span>

  <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MODULEPATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/&#39;</span><span class="p">),</span> <span class="n">x</span><span class="p">),</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;/cvmfs/neurodesk.ardc.edu.au/neurodesk-modules/&#39;</span><span class="p">)))))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Output CPU information:</span>
<span class="o">!</span>cat<span class="w"> </span>/proc/cpuinfo<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">&#39;vendor&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>uniq
<span class="o">!</span>cat<span class="w"> </span>/proc/cpuinfo<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">&#39;model name&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>uniq
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>vendor_id	: GenuineIntel
model name	: Intel(R) Xeon(R) Gold 6126 CPU @ 2.60GHz
</pre></div>
</div>
</div>
</div>
<section id="import-python-modules">
<h3>Import Python Modules<a class="headerlink" href="#import-python-modules" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>
<span class="err">!</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">nibabel</span> <span class="n">matplotlib</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">nibabel</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ipyniivue</span><span class="w"> </span><span class="kn">import</span> <span class="n">AnyNiivue</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">Markdown</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ipywidgets</span><span class="w"> </span><span class="kn">import</span> <span class="n">RadioButtons</span><span class="p">,</span> <span class="n">VBox</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>MRtrix is a software package for analyzing diffusion data. One of the notable advantages of MRtrix over tensor-fitting techniques is their method of constrained spherical deconvolution, or CSD; this method deconvolves the diffusion signal in each voxel into a series of overlapping fiber bundles. This reduces the problem of crossing fibers that can be a confound when fitting a tensor.</p>
<p>In addition to a library of commands created by the MRtrix team, the software also has wrappers for commands used with FSL: in particular, the commands <code class="docutils literal notranslate"><span class="pre">topup</span></code> and <code class="docutils literal notranslate"><span class="pre">eddy</span></code>. Therefore, we will load the MRtrix and the fMRI software package FSL.</p>
<div style="background-color: #f0f8ff; padding: 10px; border-radius: 5px;">
    <div style="background-color: #add8e6; padding: 5px; border-radius: 5px; font-weight: bold;">
        <span style="font-size: 15px; color: #add8e6; background-color: white; border-radius: 50%; width: 20px; height: 20px; display: inline-block; text-align: center; line-height: 20px;">
            !
        </span> <span style="color: white;">Note:</span>
    </div>
    <p style="margin: 10px 0;">
        Andy's tutorial is based on the steps outlined in the <a href="https://mrtrix.readthedocs.io/en/latest/index.html" style="color: #007bff; text-decoration: none;">MRtrix documentation</a>, especially the “DWI Pre-Processing” and “Constrained Spherical Deconvolution” chapters. Several of the steps and explanations are derived from Marlene Tahedl’s excellent <a href="https://osf.io/ht7zv" style="color: #007bff; text-decoration: none;">BATMAN</a> tutorial, and in many places her file notation is used.
    </p>
    For an introduction to diffusion-weighted MRI, please ensure you read Andy's comprehensive <a href="https://andysbrainbook.readthedocs.io/en/latest/MRtrix/MRtrix_Course/MRtrix_00_Diffusion_Overview.html" style="color: #007bff; text-decoration: none;">MRtrix Introduction</a>.
</div><section id="load-packages">
<h3>Load packages<a class="headerlink" href="#load-packages" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">lmod</span>
<span class="k">await</span> <span class="n">lmod</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;mrtrix3/3.0.4&#39;</span><span class="p">)</span>
<span class="k">await</span> <span class="n">lmod</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;fsl/6.0.7.4&#39;</span><span class="p">)</span>
<span class="k">await</span> <span class="n">lmod</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;mrtrix3/3.0.4&#39;, &#39;fsl/6.0.7.4&#39;]
</pre></div>
</div>
</div>
</div>
<p>Try typing one of the commands from the library, such as <code class="docutils literal notranslate"><span class="pre">mrconvert</span></code>. If MRtrix has been installed correctly, you should see the help page printed by default when no arguments are passed to the command:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span><span class="w"> </span>mrconvert<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">18</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MRtrix 3.0.4                        mrconvert                        Mar 20 2024

     mrconvert: part of the MRtrix3 package

SYNOPSIS

     Perform conversion between different file types and optionally extract a
     subset of the input image

USAGE

     mrconvert [ options ] input output

        input        the input image.

        output       the output image.
</pre></div>
</div>
</div>
</div>
<p>If this works without any errors, you are ready to begin downloading diffusion data.</p>
</section>
</section>
<section id="downloading-the-dataset">
<h2>Downloading the Dataset<a class="headerlink" href="#downloading-the-dataset" title="Link to this heading">#</a></h2>
<p>For this example, we will be preprocessing a dataset from openneuro.org called <a class="reference external" href="https://openneuro.org/datasets/ds001226/versions/00001">BTC preop</a>. It includes data from patients with gliomas, patients with meningiomas, and a group of control subjects.</p>
<p>To download the data of one subject, excute the next cell:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PATTERN</span> <span class="o">=</span> <span class="s2">&quot;sub-CON02&quot;</span>
<span class="o">!</span><span class="w"> </span>datalad<span class="w"> </span>install<span class="w"> </span>https://github.com/OpenNeuroDatasets/ds001226.git

<span class="o">!</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>ds001226<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>datalad<span class="w"> </span>get<span class="w"> </span><span class="nv">$PATTERN</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cloning:   0%|                             | 0.00/2.00 [00:00&lt;?, ? candidates/s]
Enumerating: 0.00 Objects [00:00, ? Objects/s]
                                              
Counting:   0%|                              | 0.00/25.9k [00:00&lt;?, ? Objects/s]
                                                                                
Compressing:   0%|                           | 0.00/18.7k [00:00&lt;?, ? Objects/s]
                                                                                
Receiving:   0%|                             | 0.00/25.9k [00:00&lt;?, ? Objects/s]
Receiving:   6%|█▏                  | 1.56k/25.9k [00:00&lt;00:01, 15.3k Objects/s]
Receiving:  14%|██▊                 | 3.63k/25.9k [00:00&lt;00:01, 18.0k Objects/s]
Receiving:  25%|█████               | 6.49k/25.9k [00:00&lt;00:00, 22.7k Objects/s]
Receiving:  34%|██████▊             | 8.82k/25.9k [00:00&lt;00:00, 21.6k Objects/s]
Receiving:  53%|██████████▌         | 13.8k/25.9k [00:00&lt;00:00, 31.0k Objects/s]
Receiving:  77%|███████████████▍    | 20.0k/25.9k [00:00&lt;00:00, 40.9k Objects/s]
Receiving:  93%|██████████████████▌ | 24.1k/25.9k [00:00&lt;00:00, 39.2k Objects/s]
                                                                                
Resolving:   0%|                              | 0.00/4.30k [00:00&lt;?, ? Deltas/s]
Resolving:  36%|███████▌             | 1.55k/4.30k [00:00&lt;00:00, 15.4k Deltas/s]
Resolving:  79%|████████████████▌    | 3.39k/4.30k [00:00&lt;00:00, 17.2k Deltas/s]
[INFO   ] scanning for unlocked files (this may take some time)                 
[INFO   ] Remote origin not usable by git-annex; setting annex-ignore 
[INFO   ] access to 1 dataset sibling s3-PRIVATE not auto-enabled, enable with:
| 		datalad siblings -d &quot;/data/books/diffusion_imaging/ds001226&quot; enable -s s3-PRIVATE 
<span class=" -Color -Color-Bold">install</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): /data/books/diffusion_imaging/ds001226 (<span class=" -Color -Color-Bold -Color-Bold-Magenta">dataset</span>)
Total:   0%|                                   | 0.00/95.7M [00:00&lt;?, ? Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:   0%|            | 0.00/8.31M [00:00&lt;?, ? Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:   0%|   | 33.3k/8.31M [00:00&lt;02:01, 68.0k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:   1%|   | 50.7k/8.31M [00:00&lt;01:48, 76.3k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:   1%|   | 68.2k/8.31M [00:01&lt;02:26, 56.3k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:   1%|   | 85.6k/8.31M [00:01&lt;02:15, 60.9k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:   1%|    | 103k/8.31M [00:01&lt;02:04, 65.8k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:   1%|    | 120k/8.31M [00:01&lt;01:59, 68.5k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:   2%|    | 138k/8.31M [00:02&lt;01:55, 71.0k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:   2%|    | 173k/8.31M [00:02&lt;01:50, 73.7k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:   2%|    | 190k/8.31M [00:02&lt;01:48, 74.6k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:   2%|    | 207k/8.31M [00:02&lt;01:47, 75.2k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:   3%|    | 225k/8.31M [00:03&lt;01:45, 76.4k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:   3%|    | 260k/8.31M [00:03&lt;01:22, 97.8k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:   4%|▏    | 294k/8.31M [00:03&lt;01:11, 112k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:   4%|▏    | 329k/8.31M [00:03&lt;01:03, 126k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:   5%|▏    | 381k/8.31M [00:04&lt;00:50, 157k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:   5%|▎    | 434k/8.31M [00:04&lt;00:44, 179k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:   6%|▎    | 486k/8.31M [00:04&lt;00:40, 194k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:   7%|▎    | 556k/8.31M [00:04&lt;00:34, 227k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:   8%|▍    | 643k/8.31M [00:04&lt;00:28, 272k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:   9%|▍    | 730k/8.31M [00:05&lt;00:24, 304k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:  10%|▍    | 817k/8.31M [00:05&lt;00:22, 332k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:  11%|▌    | 939k/8.31M [00:05&lt;00:19, 388k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:  13%|▌   | 1.06M/8.31M [00:05&lt;00:16, 434k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:  14%|▌   | 1.18M/8.31M [00:06&lt;00:15, 468k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:  16%|▋   | 1.34M/8.31M [00:06&lt;00:13, 529k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:  18%|▋   | 1.50M/8.31M [00:06&lt;00:11, 581k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:  20%|▊   | 1.69M/8.31M [00:06&lt;00:10, 657k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:  23%|▉   | 1.88M/8.31M [00:07&lt;00:09, 714k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:  25%|█   | 2.10M/8.31M [00:07&lt;00:07, 799k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:  28%|█▏  | 2.35M/8.31M [00:07&lt;00:06, 871k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:  31%|█▎  | 2.61M/8.31M [00:07&lt;00:05, 956k Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:  35%|█  | 2.89M/8.31M [00:07&lt;00:05, 1.05M Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:  39%|█▏ | 3.20M/8.31M [00:08&lt;00:04, 1.14M Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:  43%|█▎ | 3.53M/8.31M [00:08&lt;00:03, 1.22M Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:  47%|█▍ | 3.90M/8.31M [00:08&lt;00:03, 1.35M Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:  52%|█▌ | 4.28M/8.31M [00:08&lt;00:02, 1.46M Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:  57%|█▋ | 4.70M/8.31M [00:09&lt;00:02, 1.57M Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:  62%|█▊ | 5.15M/8.31M [00:09&lt;00:01, 1.70M Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:  68%|██ | 5.64M/8.31M [00:09&lt;00:01, 1.83M Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:  74%|██▏| 6.16M/8.31M [00:09&lt;00:01, 1.98M Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:  81%|██▍| 6.72M/8.31M [00:09&lt;00:00, 2.12M Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:  88%|██▋| 7.32M/8.31M [00:10&lt;00:00, 2.26M Bytes/s]
Get sub-CON0 .. p_T1w.nii.gz:  96%|██▊| 7.96M/8.31M [00:10&lt;00:00, 2.44M Bytes/s]
Total:   9%|██▎                        | 8.31M/95.7M [00:16&lt;02:48, 518k Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:   0%|            | 0.00/47.5M [00:00&lt;?, ? Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:   2%|    | 721k/47.5M [00:00&lt;00:17, 2.74M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:   3%|   | 1.45M/47.5M [00:00&lt;00:10, 4.32M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:   5%|▏  | 2.23M/47.5M [00:00&lt;00:11, 4.08M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:   6%|▏  | 2.79M/47.5M [00:00&lt;00:13, 3.38M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:   7%|▏  | 3.49M/47.5M [00:01&lt;00:13, 3.27M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:   8%|▏  | 3.95M/47.5M [00:01&lt;00:12, 3.40M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  10%|▎  | 4.88M/47.5M [00:01&lt;00:11, 3.66M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  12%|▎  | 5.87M/47.5M [00:01&lt;00:10, 3.97M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  14%|▍  | 6.57M/47.5M [00:01&lt;00:09, 4.53M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  16%|▍  | 7.54M/47.5M [00:01&lt;00:09, 4.40M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  18%|▌  | 8.55M/47.5M [00:02&lt;00:08, 4.44M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  19%|▌  | 9.16M/47.5M [00:02&lt;00:08, 4.55M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  21%|▋  | 10.0M/47.5M [00:02&lt;00:07, 5.30M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  23%|▋  | 11.1M/47.5M [00:02&lt;00:07, 5.09M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  25%|▋  | 11.7M/47.5M [00:02&lt;00:07, 4.95M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  26%|▊  | 12.4M/47.5M [00:02&lt;00:06, 5.49M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  27%|▊  | 13.0M/47.5M [00:02&lt;00:06, 5.32M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  29%|▉  | 13.9M/47.5M [00:03&lt;00:05, 6.06M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  32%|▉  | 15.1M/47.5M [00:03&lt;00:05, 5.76M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  34%|█  | 16.0M/47.5M [00:03&lt;00:05, 6.01M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  37%|█  | 17.5M/47.5M [00:03&lt;00:04, 6.66M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  38%|█▏ | 18.3M/47.5M [00:03&lt;00:04, 6.79M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  40%|█▏ | 19.2M/47.5M [00:03&lt;00:03, 7.29M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  43%|█▎ | 20.4M/47.5M [00:04&lt;00:03, 6.87M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  45%|█▎ | 21.2M/47.5M [00:04&lt;00:03, 6.98M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  47%|█▍ | 22.1M/47.5M [00:04&lt;00:03, 7.50M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  50%|█▍ | 23.7M/47.5M [00:04&lt;00:03, 7.55M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  52%|█▌ | 24.5M/47.5M [00:04&lt;00:02, 7.71M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  53%|█▌ | 25.3M/47.5M [00:04&lt;00:02, 7.83M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  55%|█▋ | 26.2M/47.5M [00:04&lt;00:02, 8.03M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  58%|█▋ | 27.7M/47.5M [00:04&lt;00:02, 7.73M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  61%|█▊ | 29.1M/47.5M [00:05&lt;00:02, 7.40M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  64%|█▉ | 30.6M/47.5M [00:05&lt;00:02, 7.44M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  68%|██ | 32.1M/47.5M [00:05&lt;00:02, 7.42M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  69%|██ | 32.9M/47.5M [00:05&lt;00:01, 7.47M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  72%|██▏| 34.2M/47.5M [00:05&lt;00:01, 8.58M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  74%|██▏| 35.4M/47.5M [00:05&lt;00:01, 9.43M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  77%|██▎| 36.7M/47.5M [00:06&lt;00:01, 6.83M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  79%|██▍| 37.6M/47.5M [00:06&lt;00:01, 5.98M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  81%|██▍| 38.5M/47.5M [00:06&lt;00:01, 6.40M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  83%|██▍| 39.4M/47.5M [00:06&lt;00:01, 6.99M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  86%|██▌| 40.8M/47.5M [00:06&lt;00:00, 6.97M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  89%|██▋| 42.5M/47.5M [00:07&lt;00:00, 6.02M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  91%|██▋| 43.3M/47.5M [00:07&lt;00:00, 6.41M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  94%|██▊| 44.8M/47.5M [00:07&lt;00:00, 6.71M Bytes/s]
Get sub-CON0 .. P_dwi.nii.gz:  97%|██▉| 46.1M/47.5M [00:07&lt;00:00, 6.66M Bytes/s]
Total:  58%|███████████████▏          | 55.8M/95.7M [00:24&lt;00:17, 2.24M Bytes/s]
Get sub-CON0 .. A_dwi.nii.gz:   0%|            | 0.00/1.16M [00:00&lt;?, ? Bytes/s]
Get sub-CON0 .. A_dwi.nii.gz:  27%|█   | 313k/1.16M [00:00&lt;00:00, 3.07M Bytes/s]
Get sub-CON0 .. A_dwi.nii.gz:  63%|██▌ | 732k/1.16M [00:00&lt;00:00, 3.69M Bytes/s]
                                                                                
Get sub-CON0 .. _bold.nii.gz:   0%|            | 0.00/38.7M [00:00&lt;?, ? Bytes/s]
Get sub-CON0 .. _bold.nii.gz:   4%|   | 1.56M/38.7M [00:00&lt;00:05, 7.04M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:   7%|▏  | 2.80M/38.7M [00:00&lt;00:05, 6.55M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:   9%|▎  | 3.52M/38.7M [00:00&lt;00:05, 6.74M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  11%|▎  | 4.39M/38.7M [00:00&lt;00:04, 7.32M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  16%|▍  | 6.06M/38.7M [00:00&lt;00:04, 7.74M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  18%|▌  | 7.10M/38.7M [00:01&lt;00:04, 6.71M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  21%|▌  | 8.01M/38.7M [00:01&lt;00:04, 7.22M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  23%|▋  | 8.90M/38.7M [00:01&lt;00:03, 7.60M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  25%|▊  | 9.77M/38.7M [00:01&lt;00:03, 7.34M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  30%|▉  | 11.5M/38.7M [00:01&lt;00:03, 7.36M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  33%|█  | 12.9M/38.7M [00:01&lt;00:03, 7.29M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  36%|█  | 13.8M/38.7M [00:01&lt;00:03, 7.58M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  38%|█▏ | 14.7M/38.7M [00:01&lt;00:03, 7.87M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  42%|█▎ | 16.2M/38.7M [00:02&lt;00:02, 7.60M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  45%|█▎ | 17.4M/38.7M [00:02&lt;00:02, 7.12M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  47%|█▍ | 18.3M/38.7M [00:02&lt;00:02, 7.40M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  49%|█▍ | 19.1M/38.7M [00:02&lt;00:02, 7.49M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  52%|█▌ | 19.9M/38.7M [00:02&lt;00:02, 7.66M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  54%|█▌ | 20.8M/38.7M [00:02&lt;00:02, 7.83M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  58%|█▋ | 22.4M/38.7M [00:03&lt;00:02, 7.95M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  62%|█▊ | 24.1M/38.7M [00:03&lt;00:01, 8.05M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  64%|█▉ | 24.9M/38.7M [00:03&lt;00:01, 8.10M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  66%|█▉ | 25.7M/38.7M [00:03&lt;00:01, 8.10M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  69%|██ | 26.6M/38.7M [00:03&lt;00:01, 8.13M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  71%|██▏| 27.4M/38.7M [00:03&lt;00:01, 8.13M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  75%|██▎| 29.0M/38.7M [00:03&lt;00:01, 8.12M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  77%|██▎| 29.9M/38.7M [00:03&lt;00:01, 8.14M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  80%|██▍| 30.8M/38.7M [00:04&lt;00:00, 8.38M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  82%|██▍| 31.7M/38.7M [00:04&lt;00:00, 8.53M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  84%|██▌| 32.6M/38.7M [00:04&lt;00:00, 8.57M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  88%|██▋| 34.1M/38.7M [00:04&lt;00:00, 8.10M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  90%|██▋| 34.9M/38.7M [00:04&lt;00:00, 8.17M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  94%|██▊| 36.5M/38.7M [00:04&lt;00:00, 7.99M Bytes/s]
Get sub-CON0 .. _bold.nii.gz:  98%|██▉| 38.0M/38.7M [00:04&lt;00:00, 7.80M Bytes/s]
<span class=" -Color -Color-Bold">get</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): sub-CON02/ses-preop/anat/sub-CON02_ses-preop_T1w.nii.gz (<span class=" -Color -Color-Bold -Color-Bold-Magenta">file</span>)
<span class=" -Color -Color-Bold">get</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): sub-CON02/ses-preop/dwi/sub-CON02_ses-preop_acq-AP_dwi.nii.gz (<span class=" -Color -Color-Bold -Color-Bold-Magenta">file</span>)
<span class=" -Color -Color-Bold">get</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): sub-CON02/ses-preop/dwi/sub-CON02_ses-preop_acq-PA_dwi.nii.gz (<span class=" -Color -Color-Bold -Color-Bold-Magenta">file</span>)
<span class=" -Color -Color-Bold">get</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): sub-CON02/ses-preop/func/sub-CON02_ses-preop_task-rest_bold.nii.gz (<span class=" -Color -Color-Bold -Color-Bold-Magenta">file</span>)
<span class=" -Color -Color-Bold">get</span>(<span class=" -Color -Color-Bold -Color-Bold-Green">ok</span>): sub-CON02 (<span class=" -Color -Color-Bold -Color-Bold-Magenta">directory</span>)
action summary:
  get (ok: 5)

</pre></div>
</div>
</div>
</div>
<section id="id1">
<h3><a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<p>If you want to download more subjects, here is an example how to get 4 controls and 4 patients:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>PATTERN_CONTROLS=&quot;sub-CON0[1-4]&quot;
PATTERN_PATIENTS=&quot;sub-PAT0[1-4]&quot;

! datalad install https://github.com/OpenNeuroDatasets/ds001226.git

! cd ds001226 &amp;&amp; datalad get $PATTERN_CONTROLS $PATTERN_PATIENTS
</pre></div>
</div>
</section>
</section>
<section id="looking-at-the-data">
<h2>Looking at the Data<a class="headerlink" href="#looking-at-the-data" title="Link to this heading">#</a></h2>
<p>MRtrix uses its own format for storing and displaying imaging data. MRtrix is also able to read raw data in NIFTI format, but will output its files in MRtrix format, labeled with a <code class="docutils literal notranslate"><span class="pre">.mif</span></code> extension.</p>
<p>To see how this works, navigate to the folder sub-CON02/ses-preop/dwi, which contains the diffusion data. One of the first steps for preprocessing your data is converting the diffusion data to a format that MRtrix understands; we will use the command <code class="docutils literal notranslate"><span class="pre">mrconvert</span></code> to combine the raw diffusion data with its corresponding <code class="docutils literal notranslate"><span class="pre">.bval</span></code> and <code class="docutils literal notranslate"><span class="pre">.bvec</span> <span class="pre">files</span></code>, so that we can use the combined file for future preprocessing steps:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span><span class="w"> </span>mrconvert<span class="w"> </span>ds001226/sub-CON02/ses-preop/dwi/sub-CON02_ses-preop_acq-AP_dwi.nii.gz<span class="w"> </span>sub-02_dwi.mif<span class="w"> </span>-fslgrad<span class="w"> </span>ds001226/sub-CON02/ses-preop/dwi/sub-CON02_ses-preop_acq-AP_dwi.bvec<span class="w"> </span>ds001226/sub-CON02/ses-preop/dwi/sub-CON02_ses-preop_acq-AP_dwi.bval
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mrconvert: [100%] uncompressing image &quot;ds001226/sub-CON02/ses-preop/dwi/sub-CON02_ses-preop_acq-AP_dwi.nii.gz&quot;[0K?7h?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l
mrconvert: [100%] copying from &quot;ds001226/s...ses-preop_acq-AP_dwi.nii.gz&quot; to &quot;sub-02_dwi.mif&quot;[0K?7h?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l
</pre></div>
</div>
</div>
</div>
<p>This command requires three arguments: The input, which is the raw DWI file in the AP directory; an output file, which we will call sub-02_dwi.mif to make it more compact and easier to read; and <code class="docutils literal notranslate"><span class="pre">-fslgrad</span></code>, which requires the corresponding .bvec and .bval files (in that order).</p>
<div style="background-color: #f0f8ff; padding: 10px; border-radius: 5px;">
    <div style="background-color: #add8e6; padding: 5px; border-radius: 5px; font-weight: bold;">
        <span style="font-size: 15px; color: #add8e6; background-color: white; border-radius: 50%; width: 20px; height: 20px; display: inline-block; text-align: center; line-height: 20px;">
            !
        </span> <span style="color: white;">Note:</span>
    </div>
    <p style="margin: 10px 0;">
To make the rest of the example easier to read as well, use the <code>mv</code> command to rename the .bval and .bvec files:
    </p>
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span><span class="w"> </span>mv<span class="w"> </span>ds001226/sub-CON02/ses-preop/dwi/sub-CON02_ses-preop_acq-AP_dwi.bvec<span class="w"> </span>sub-02_AP.bvec
<span class="o">!</span><span class="w"> </span>mv<span class="w"> </span>ds001226/sub-CON02/ses-preop/dwi/sub-CON02_ses-preop_acq-AP_dwi.bval<span class="w"> </span>sub-02_AP.bval
<span class="o">!</span><span class="w"> </span>mv<span class="w"> </span>ds001226/sub-CON02/ses-preop/dwi/sub-CON02_ses-preop_acq-PA_dwi.bvec<span class="w"> </span>sub-02_PA.bvec
<span class="o">!</span><span class="w"> </span>mv<span class="w"> </span>ds001226/sub-CON02/ses-preop/dwi/sub-CON02_ses-preop_acq-PA_dwi.bval<span class="w"> </span>sub-02_PA.bval
</pre></div>
</div>
</div>
</div>
<p>The output image, sub-02_dwi.mif, can be checked with the command <code class="docutils literal notranslate"><span class="pre">mrinfo</span></code>. The output contains several pieces of information, such as the dimensions of the dataset and the voxel size, along with the commands that were used to generate the current file:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span><span class="w"> </span>mrinfo<span class="w"> </span>sub-02_dwi.mif
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>************************************************
Image name:          &quot;sub-02_dwi.mif&quot;
************************************************
  Dimensions:        96 x 96 x 60 x 102
  Voxel size:        2.5 x 2.5 x 2.5 x 8.7
  Data strides:      [ -1 2 3 4 ]
  Format:            MRtrix
  Data type:         signed 16 bit integer (little endian)
  Intensity scaling: offset = 0, multiplier = 1
  Transform:               0.9988    -0.01395     0.04747        -111
                          0.02082      0.9888     -0.1476      -85.88
                         -0.04488      0.1484      0.9879      -56.76
  command_history:   /opt/mrtrix3-3.0.4/bin/mrconvert ds001226/sub-CON02/ses-preop/dwi/sub-CON02_ses-preop_acq-AP_dwi.nii.gz sub-02_dwi.mif -fslgrad ds001226/sub-CON02/ses-preop/dwi/sub-CON02_ses-preop_acq-AP_dwi.bvec ds001226/sub-CON02/ses-preop/dwi/sub-CON02_ses-preop_acq-AP_dwi.bval  (version=3.0.4)
  comments:          TE=1.1e+02;Time=125448.950;phase=1;dwell=0.380
  dw_scheme:         0,0,0,0
  [102 entries]      0,0,0,0
                     ...
                     0.9082055818,0.3669468842,-0.201277434,2800
                     0,0,0,0
  mrtrix_version:    3.0.4
</pre></div>
</div>
</div>
</div>
<p>Note that, since this is a 4-dimensional dataset, the last dimension is time; in other words, this file contains 102 volumes, each one with dimensions of 96 x 96 x 60 voxels. The last dimension of the <em>Voxel size</em> field - which in this case has a value of 8.7 - indicates the time it took to acquire each volume, the repetition time, or TR.</p>
<section id="bvals-and-bvecs">
<h3><strong>Bvals and Bvecs</strong><a class="headerlink" href="#bvals-and-bvecs" title="Link to this heading">#</a></h3>
<p>The other files we need to check are the <code class="docutils literal notranslate"><span class="pre">bvals</span></code> and <code class="docutils literal notranslate"><span class="pre">bvecs</span> <span class="pre">files</span></code>. Briefly, the bvals contain a single number per volume that indicates how large of a diffusion gradient was applied to the data; and the bvecs file contains a triplet of numbers per volume that shows in what directions the gradients were applied. In general, volumes with larger b-values will be more sensitive to diffusion changes, but the images will also be more susceptible to motion and physiological artifacts.</p>
<p>The most important check is to ensure that the number of bvals and the number of bvecs are the same as the number of volumes in the dataset. For example, we can find the number of volumes in the sub-02_dwi.mif dataset by typing:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span><span class="w"> </span>mrinfo<span class="w"> </span>-size<span class="w"> </span>sub-02_dwi.mif<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $4}&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>102
</pre></div>
</div>
</div>
</div>
<p>Which returns a value of 102, the number in the 4th field of the dimensions header that corresponds to the number of time-points, or volumes, in the dataset. We then compare this with the number of bvals and bvecs by using <code class="docutils literal notranslate"><span class="pre">awk</span></code> to count the number of columns in each text file:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print NF; exit}&#39;</span><span class="w"> </span>sub-02_AP.bvec
<span class="o">!</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print NF; exit}&#39;</span><span class="w"> </span>sub-02_AP.bval
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>102
102
</pre></div>
</div>
</div>
</div>
<div style="background-color: #f0f8ff; padding: 10px; border-radius: 5px;">
    <div style="background-color: #add8e6; padding: 5px; border-radius: 5px; font-weight: bold;">
        <span style="font-size: 15px; color: #add8e6; background-color: white; border-radius: 50%; width: 20px; height: 20px; display: inline-block; text-align: center; line-height: 20px;">
            !
        </span> <span style="color: white;">Note:</span>
    </div>
    <p style="margin: 10px 0;">
If the number of volumes in your dataset and the number of bvals and bvecs do not match, you should check with your scan technician about the discrepancy; the files may not have been properly uploaded to the server, or maybe the diffusion-weighted image wasn’t acquired correctly.
    </p>
</div></section>
<section id="visualization">
<h3><strong>Visualization</strong><a class="headerlink" href="#visualization" title="Link to this heading">#</a></h3>
<p>MRtrix, like the other imaging software packages has its own imaging viewer, called <strong>mrview</strong>. For example, you can view the image that we created above by typing:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">mrview</span><span class="w"> </span><span class="nx">sub</span><span class="o">-</span><span class="mo">02</span><span class="nx">_dwi</span><span class="p">.</span><span class="nx">mif</span>
</pre></div>
</div>
<p>Detailed instructions on how to use the mrtrix viewer can be found in <a class="reference external" href="https://andysbrainbook.readthedocs.io/en/latest/MRtrix/MRtrix_Course/MRtrix_03_DataFormats.html#looking-at-the-data-with-mrview">Andy’s Tutorial</a>.</p>
<p>We will use AnyNiivue for the interactive visualization of 3 different volumes, which can be selected using radio buttons:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the .mif file and choose different volumes</span>
<span class="n">mif_file_path</span> <span class="o">=</span> <span class="s2">&quot;sub-02_dwi.mif&quot;</span>
<span class="n">volume_indices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">output_files</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Extract frames/volumes with mrconvert into temporary files</span>
<span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">volume_indices</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.mif&quot;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_file</span><span class="p">:</span>
        <span class="n">temp_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Close the temp file so subprocess can overwrite it</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">temp_file</span><span class="o">.</span><span class="n">name</span>
        <span class="n">output_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;mrconvert&quot;</span><span class="p">,</span> <span class="n">mif_file_path</span><span class="p">,</span> <span class="s2">&quot;-coord&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span> <span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;-force&quot;</span><span class="p">,</span> <span class="s2">&quot;-quiet&quot;</span><span class="p">])</span>

<span class="c1"># Initialize the Niivue viewer</span>
<span class="n">nv</span> <span class="o">=</span> <span class="n">AnyNiivue</span><span class="p">()</span>

<span class="c1"># Define the volumes with opacity set to 0 initially for all but the default layer 0 (opacity = 1.0)</span>
<span class="n">volumes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">output_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;colormap&quot;</span><span class="p">:</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="s2">&quot;opacity&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">output_files</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;colormap&quot;</span><span class="p">:</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="s2">&quot;opacity&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">output_files</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;colormap&quot;</span><span class="p">:</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="s2">&quot;opacity&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">},</span>
<span class="p">]</span>

<span class="c1"># Load all the volumes into the viewer</span>
<span class="n">nv</span><span class="o">.</span><span class="n">load_volumes</span><span class="p">(</span><span class="n">volumes</span><span class="p">)</span>

<span class="c1"># Function to update the opacity of the layers based on selection</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update_layer</span><span class="p">(</span><span class="n">change</span><span class="p">):</span>
    <span class="n">selected_index</span> <span class="o">=</span> <span class="n">change</span><span class="o">.</span><span class="n">new</span>

    <span class="c1"># Set opacity to 0 for all volumes</span>
    <span class="k">for</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">nv</span><span class="o">.</span><span class="n">volumes</span><span class="p">:</span>
        <span class="n">volume</span><span class="o">.</span><span class="n">opacity</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># Set opacity to 1 for the selected volume</span>
    <span class="n">nv</span><span class="o">.</span><span class="n">volumes</span><span class="p">[</span><span class="n">selected_index</span><span class="p">]</span><span class="o">.</span><span class="n">opacity</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="c1"># Create RadioButtons widget for selecting the active layer</span>
<span class="n">layer_selector</span> <span class="o">=</span> <span class="n">RadioButtons</span><span class="p">(</span>
    <span class="n">options</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;Volume 0&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;Volume 2&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;Volume 3&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Select Volume:&#39;</span><span class="p">,</span>
    <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;description_width&#39;</span><span class="p">:</span> <span class="s1">&#39;initial&#39;</span><span class="p">}</span>
<span class="p">)</span>

<span class="c1"># Observe changes in the RadioButtons widget</span>
<span class="n">layer_selector</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">update_layer</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>

<span class="c1"># Display the RadioButtons and the AnyNiivue viewer</span>
<span class="n">display</span><span class="p">(</span><span class="n">VBox</span><span class="p">([</span><span class="n">layer_selector</span><span class="p">,</span> <span class="n">nv</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "18fc6e49502e45908f1f7ad9d20e0b69", "version_major": 2, "version_minor": 0}</script></div>
</div>
<p>The first volume that is displayed, which has a time-series index of 0 (i.e., 0 indicates the first volumes in the time-series, 1 indicates the second volume, and so on), looks like a typical T2-weighted functional image. We can verify this by comparing it with the b-value for the first volume in the time-series.</p>
<p>If you look at the bval file, note the intensity differences and how they correspond to their respective b-values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span><span class="w"> </span>cat<span class="w"> </span>sub-02_AP.bval
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 0 700 2800 1200 2800 1200 2800 2800 1200 700 2800 2800 1200 2800 700 1200 2800 2800 1200 2800 700 2800 1200 2800 1200 0 2800 700 2800 1200 2800 2800 1200 700 2800 1200 2800 2800 1200 2800 700 2800 1200 2800 1200 2800 700 2800 1200 2800 0 700 2800 1200 2800 1200 2800 2800 1200 700 2800 2800 1200 2800 700 1200 2800 2800 1200 2800 700 2800 1200 2800 1200 0 2800 700 2800 1200 2800 2800 1200 700 2800 1200 2800 2800 1200 2800 700 2800 1200 2800 1200 2800 700 2800 1200 2800 0
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="preprocessing">
<h2>Preprocessing<a class="headerlink" href="#preprocessing" title="Link to this heading">#</a></h2>
<p>Diffusion data in particular is susceptible to warping artifacts as a result of the phase-encoding direction: In general, the predominant encoding direction - such as Anterior to Posterior, or AP - will make the anterior part of the brain look more “squished”, as though a strong headwind is blowing from the Anterior direction. The opposite is true of the Posterior to Anterior, or PA, phase-encoding direction. Sometimes these distortions are very subtle, but other times they are conspicuous.</p>
<p>The following are common preprocessing steps done with MRtrix. If you have used the software package FSL to analyze diffusion data, note that some of the FSL commands - such as eddy and topup - are used in some of the MRtrix libraries.</p>
<section id="dwi-denoise">
<h3>dwi_denoise<a class="headerlink" href="#dwi-denoise" title="Link to this heading">#</a></h3>
<p>The first preprocessing step we will do is denoise the data by using MRtrix’s <code class="docutils literal notranslate"><span class="pre">dwidenoise</span></code> command. This requires an input and an output argument, and you also have the option to output the noise map with the <em>-noise</em> option. For example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span><span class="w"> </span>dwidenoise<span class="w"> </span>sub-02_dwi.mif<span class="w"> </span>sub-02_den.mif<span class="w"> </span>-noise<span class="w"> </span>noise.mif
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dwidenoise: [100%] preloading data for &quot;sub-02_dwi.mif&quot;[0K?7h?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l
dwidenoise: [100%] running MP-PCA denoising[0K?7h?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l
</pre></div>
</div>
</div>
</div>
<p>One quality check is to see whether the residuals load onto any part of the anatomy. If they do, that may indicate that the brain region is disproportionately affected by some kind of artifact or distortion. To calculate this residual, we will use another MRtrix command called <code class="docutils literal notranslate"><span class="pre">mrcalc</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span><span class="w"> </span>mrcalc<span class="w"> </span>sub-02_dwi.mif<span class="w"> </span>sub-02_den.mif<span class="w"> </span>-subtract<span class="w"> </span>residual.mif
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mrcalc: [100%] computing: (sub-02_dwi.mif - sub-02_den.mif)[0K?7h?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mif_file_path</span> <span class="o">=</span> <span class="s1">&#39;residual.mif&#39;</span>

<span class="c1"># Convert the .mif file to a temporary .nii.gz file with -force flag</span>
<span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.nii.gz&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_file</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;mrconvert&quot;</span><span class="p">,</span> <span class="n">mif_file_path</span><span class="p">,</span> <span class="n">temp_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;-force&quot;</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Check for errors in the conversion process</span>
    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in mrconvert: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Load the temporary NIfTI file</span>
        <span class="n">nii_image</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">temp_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">nii_image</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>

        <span class="c1"># Define volume and slice indices</span>
        <span class="n">vol_idx</span> <span class="o">=</span> <span class="mi">0</span>  
        <span class="n">slice_index</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span> 

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="c1"># Extract the middle slice from the selected volume and rotate it 90°</span>
        <span class="n">rotated_slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">slice_index</span><span class="p">,</span> <span class="n">vol_idx</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rotated_slice</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Residual Map&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/7a6bd715ea92c21c3657b4ba84b35ba3ec29eea386f1a1021fe0914f9eb23037.png" src="../_images/7a6bd715ea92c21c3657b4ba84b35ba3ec29eea386f1a1021fe0914f9eb23037.png" />
</div>
</div>
<p>It is common to see a grey outline of the brain, as in the figure above. However, everything within the grey matter and white matter should be relatively uniform and blurry; if you see any clear anatomical landmarks, such as individual gyri or sulci, that may indicate that those parts of the brain have been corrupted by noise. If that happens, you can increase the extent of the denoising filter from the default of 5 to a larger number, such as 7; e.g.,</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="o">!</span><span class="w"> </span><span class="nx">dwidenoise</span><span class="w"> </span><span class="nx">your_data</span><span class="p">.</span><span class="nx">mif</span><span class="w"> </span><span class="nx">your_data_denoised_7extent</span><span class="p">.</span><span class="nx">mif</span><span class="w"> </span><span class="o">-</span><span class="nx">extent</span><span class="w"> </span><span class="mf">7</span><span class="w"> </span><span class="o">-</span><span class="nx">noise</span><span class="w"> </span><span class="nx">noise</span><span class="p">.</span><span class="nx">mif</span>
</pre></div>
</div>
</section>
<section id="mri-degibbs">
<h3>mri_degibbs<a class="headerlink" href="#mri-degibbs" title="Link to this heading">#</a></h3>
<p>An optional preprocessing step is to run <code class="docutils literal notranslate"><span class="pre">mri_degibbs</span></code>, which removes Gibbs’ ringing artifacts from the data. These artifacts look like ripples in a pond, and are most conspicuous in the images that have a b-value of 0. Look at your diffusion data first, and determine whether there are any Gibbs artifacts; if there are, then you can run mrdegibbs by specifying both an input file and output file, e.g.:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="o">!</span><span class="w"> </span><span class="nx">mrdegibbs</span><span class="w"> </span><span class="nx">sub</span><span class="o">-</span><span class="mo">02</span><span class="nx">_den</span><span class="p">.</span><span class="nx">mif</span><span class="w"> </span><span class="nx">sub</span><span class="o">-</span><span class="mo">02</span><span class="nx">_den_unr</span><span class="p">.</span><span class="nx">mif</span>
</pre></div>
</div>
<p>As always, inspect the data both before and after with mrview to determine whether the preprocessing step made the data better, worse, or had no effect.</p>
<p>If you don’t see any Gibbs artifacts in your data, then I would recommend omitting this step; we won’t be using it for the rest of the tutorial.</p>
</section>
<section id="dwipreproc">
<h3>dwipreproc<a class="headerlink" href="#dwipreproc" title="Link to this heading">#</a></h3>
<p>Most diffusion datasets are composed of two separate imaging files: One that is acquired with a primary phase-encoding direction, and one that is acquired with a reverse phase-encoding direction. The primary phase-encoding direction is used to acquire the majority of the diffusion images at different b-values. The reverse-phase encoded file, on the other hand, is used to unwarp any of the distortions that are present in the primary phase-encoded file.</p>
<p>Our first step is to convert the reverse phase-encoded NIFTI file into .mif format. We will also add its b-values and b-vectors into the header:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span><span class="w"> </span>mrconvert<span class="w"> </span>ds001226/sub-CON02/ses-preop/dwi/sub-CON02_ses-preop_acq-PA_dwi.nii.gz<span class="w"> </span>PA.mif
<span class="o">!</span><span class="w"> </span>mrconvert<span class="w"> </span>PA.mif<span class="w"> </span>-fslgrad<span class="w"> </span>sub-02_PA.bvec<span class="w"> </span>sub-02_PA.bval<span class="w"> </span>-<span class="w"> </span><span class="p">|</span><span class="w"> </span>mrmath<span class="w"> </span>-<span class="w"> </span>mean<span class="w"> </span>mean_b0_PA.mif<span class="w"> </span>-axis<span class="w"> </span><span class="m">3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mrconvert: [100%] uncompressing image &quot;ds001226/sub-CON02/ses-preop/dwi/sub-CON02_ses-preop_acq-PA_dwi.nii.gz&quot;[0K?7h?7l?7l
mrconvert: [100%] copying from &quot;ds001226/s...ses-preop_acq-PA_dwi.nii.gz&quot; to &quot;PA.mif&quot;[0K?7h?7l
mrconvert: [100%] copying from &quot;PA.mif&quot; to &quot;/tmp/mrtrix-tmp-XPdyxb.mif&quot;[0K?7h?7l
mrmath: [100%] preloading data for &quot;/tmp/mrtrix-tmp-XPdyxb.mif&quot;[0K?7h?7l?7l
mrmath: [100%] computing mean along axis 3...[0K?7h?7l?7l
</pre></div>
</div>
</div>
</div>
<p>Next, we extract the b-values from the primary phase-encoded image, and then combine the two with <code class="docutils literal notranslate"><span class="pre">mrcat</span></code>. This will create a new image, “b0_pair.mif”, which contains both of the average b=0 images for both phase-encoded images.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span><span class="w"> </span>dwiextract<span class="w"> </span>sub-02_den.mif<span class="w"> </span>-<span class="w"> </span>-bzero<span class="w"> </span><span class="p">|</span><span class="w"> </span>mrmath<span class="w"> </span>-<span class="w"> </span>mean<span class="w"> </span>mean_b0_AP.mif<span class="w"> </span>-axis<span class="w"> </span><span class="m">3</span>
<span class="o">!</span><span class="w"> </span>mrcat<span class="w"> </span>mean_b0_AP.mif<span class="w"> </span>mean_b0_PA.mif<span class="w"> </span>-axis<span class="w"> </span><span class="m">3</span><span class="w"> </span>b0_pair.mif
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dwiextract: [100%] extracting volumes[0K?7h?7l?7l?7l?7l?7l?7l?7l
mrmath: [100%] preloading data for &quot;/tmp/mrtrix-tmp-e0ckYi.mif&quot;[0K?7h?7l
mrmath: [100%] computing mean along axis 3...[0K?7h?7l?7l?7l
mrcat: [100%] concatenating &quot;mean_b0_AP.mif&quot;[0K?7h?7l?7l?7l?7l
mrcat: [100%] concatenating &quot;mean_b0_PA.mif&quot;[0K?7h?7l?7l?7l
</pre></div>
</div>
</div>
</div>
<section id="id2">
<h4><a class="headerlink" href="#id2" title="Link to this heading">#</a></h4>
<p>We now have everything we need to run the main preprocessing step, which is called by <code class="docutils literal notranslate"><span class="pre">dwipreproc</span></code>. For the most part, this command is a wrapper that uses FSL commands such as <code class="docutils literal notranslate"><span class="pre">topup</span></code> and <code class="docutils literal notranslate"><span class="pre">eddy</span></code> to unwarp the data and remove eddy currents.</p>
<p>The first arguments are the input and output; the second option, <em>-nocleanup</em>, will keep the temporary processing folder which contains a few files we will examine later. <em>-pe_dir AP</em> signalizes that the primary phase-encoding direction is anterior-to-posterior, and <em>-rpe_pair</em> combined with the <em>-se_epi</em> options indicates that the following input file (i.e., “b0_pair.mif”) is a pair of spin-echo images that were acquired with reverse phase-encoding directions.</p>
<p>Lastly, <em>-eddy_options</em> specifies options that are specific to the FSL command <code class="docutils literal notranslate"><span class="pre">eddy</span></code>. You can visit the eddy user guide for more options and details about what they do. For now, we will only use the options <em>–slm=linear</em> (which can be useful for data that was acquired with less than 60 directions) and <em>–data_is_shelled</em> (which indicates that the diffusion data was acquired with multiple b-values).</p>
</section>
<section id="id3">
<h4><a class="headerlink" href="#id3" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span><span class="w"> </span>dwifslpreproc<span class="w"> </span>sub-02_den.mif<span class="w"> </span>sub-02_den_preproc.mif<span class="w"> </span>-nocleanup<span class="w"> </span>-pe_dir<span class="w"> </span>AP<span class="w"> </span>-rpe_pair<span class="w"> </span>-se_epi<span class="w"> </span>b0_pair.mif<span class="w"> </span>-eddy_options<span class="w"> </span><span class="s2">&quot; --slm=linear --data_is_shelled&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dwifslpreproc: 
dwifslpreproc: <span class=" -Color -Color-Green">Note that this script makes use of commands / algorithms that have relevant articles for citation; INCLUDING FROM EXTERNAL SOFTWARE PACKAGES. Please consult the help page (-help option) for more information.</span>
dwifslpreproc: 
dwifslpreproc: <span class=" -Color -Color-Green">Generated scratch directory: /data/books/diffusion_imaging/dwifslpreproc-tmp-ILH2V4/</span>
<span class=" -Color -Color-Cyan">Command:</span>  mrconvert /data/books/diffusion_imaging/sub-02_den.mif /data/books/diffusion_imaging/dwifslpreproc-tmp-ILH2V4/dwi.mif -json_export /data/books/diffusion_imaging/dwifslpreproc-tmp-ILH2V4/dwi.json
<span class=" -Color -Color-Cyan">Command:</span>  mrconvert /data/books/diffusion_imaging/b0_pair.mif /data/books/diffusion_imaging/dwifslpreproc-tmp-ILH2V4/se_epi.mif
dwifslpreproc: <span class=" -Color -Color-Green">Changing to scratch directory (/data/books/diffusion_imaging/dwifslpreproc-tmp-ILH2V4/)</span>
dwifslpreproc: <span class=" -Color -Color-Green">Total readout time not provided at command-line; assuming sane default of 0.1</span>
<span class=" -Color -Color-Cyan">Command:</span>  mrinfo dwi.mif -export_grad_mrtrix grad.b
<span class=" -Color -Color-Cyan">Command:</span>  mrconvert se_epi.mif topup_in.nii -import_pe_table se_epi_manual_pe_scheme.txt -strides -1,+2,+3,+4 -export_pe_table topup_datain.txt
<span class=" -Color -Color-Cyan">Command:</span>  topup --imain=topup_in.nii --datain=topup_datain.txt --out=field --fout=field_map.nii.gz --config=/opt/fsl-6.0.5.1/etc/flirtsch/b02b0.cnf --verbose
<span class=" -Color -Color-Cyan">Command:</span>  mrconvert dwi.mif -import_pe_table dwi_manual_pe_scheme.txt - | mrinfo - -export_pe_eddy applytopup_config.txt applytopup_indices.txt
<span class=" -Color -Color-Cyan">Command:</span>  mrconvert dwi.mif dwi_pe_0.nii -coord 3 0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101 -strides -1,+2,+3,+4 -json_export dwi_pe_0.json
<span class=" -Color -Color-Cyan">Command:</span>  applytopup --imain=dwi_pe_0.nii --datain=applytopup_config.txt --inindex=1 --topup=field --out=dwi_pe_0_applytopup.nii --method=jac
<span class=" -Color -Color-Cyan">Command:</span>  mrconvert dwi_pe_0_applytopup.nii.gz dwi_pe_0_applytopup.mif -json_import dwi_pe_0.json
<span class=" -Color -Color-Cyan">Command:</span>  dwi2mask dwi_pe_0_applytopup.mif - | maskfilter - dilate - | mrconvert - eddy_mask.nii -datatype float32 -strides -1,+2,+3
<span class=" -Color -Color-Cyan">Command:</span>  mrconvert dwi.mif -import_pe_table dwi_manual_pe_scheme.txt eddy_in.nii -strides -1,+2,+3,+4 -export_grad_fsl bvecs bvals -export_pe_eddy eddy_config.txt eddy_indices.txt
<span class=" -Color -Color-Cyan">Command:</span>  eddy_cuda --imain=eddy_in.nii --mask=eddy_mask.nii --acqp=eddy_config.txt --index=eddy_indices.txt --bvecs=bvecs --bvals=bvals --topup=field --slm=linear --data_is_shelled --out=dwi_post_eddy --verbose
dwifslpreproc: <span class=" -Color -Color-Green">CUDA version of &#39;eddy&#39; was not successful; attempting OpenMP version</span>
<span class=" -Color -Color-Cyan">Command:</span>  eddy_openmp --imain=eddy_in.nii --mask=eddy_mask.nii --acqp=eddy_config.txt --index=eddy_indices.txt --bvecs=bvecs --bvals=bvals --topup=field --slm=linear --data_is_shelled --out=dwi_post_eddy --verbose
<span class=" -Color -Color-Cyan">Command:</span>  mrconvert dwi_post_eddy.nii.gz result.mif -strides -1,2,3,4 -fslgrad dwi_post_eddy.eddy_rotated_bvecs bvals
<span class=" -Color -Color-Cyan">Command:</span>  mrconvert result.mif /data/books/diffusion_imaging/sub-02_den_preproc.mif
dwifslpreproc: <span class=" -Color -Color-Green">Changing back to original directory (/data/books/diffusion_imaging)</span>
dwifslpreproc: <span class=" -Color -Color-Green">Scratch directory retained; location: /data/books/diffusion_imaging/dwifslpreproc-tmp-ILH2V4/</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id4">
<h4><a class="headerlink" href="#id4" title="Link to this heading">#</a></h4>
<p>When it has finished running, examine the output to see how eddy current correction and unwarping have changed the data; ideally, you should see more signal restored in regions such as the orbitofrontal cortex, which is particularly susceptible to signal dropout.</p>
<p>Let’s display the newly preprocessed data (gray) as well as the original diffusion data ocolored in red. You should see a noticeable difference between the two images, especially in the frontal lobes of the brain near the eyes, which are most susceptible to eddy currents.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># File paths for both images</span>
<span class="n">mif_file_path1</span> <span class="o">=</span> <span class="s1">&#39;sub-02_den_preproc.mif&#39;</span>
<span class="n">mif_file_path2</span> <span class="o">=</span> <span class="s1">&#39;sub-02_dwi.mif&#39;</span>

<span class="c1"># Convert both .mif files to temporary .nii.gz files with -force flag</span>
<span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.nii.gz&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_file1</span><span class="p">,</span> \
     <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.nii.gz&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_file2</span><span class="p">:</span>
         
    <span class="c1"># Convert main image</span>
    <span class="n">result1</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;mrconvert&quot;</span><span class="p">,</span> <span class="n">mif_file_path1</span><span class="p">,</span> <span class="n">temp_file1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;-force&quot;</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result1</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in mrconvert for preprocessed image: </span><span class="si">{</span><span class="n">result1</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">exit</span><span class="p">()</span>
    
    <span class="c1"># Convert overlay image</span>
    <span class="n">result2</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;mrconvert&quot;</span><span class="p">,</span> <span class="n">mif_file_path2</span><span class="p">,</span> <span class="n">temp_file2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;-force&quot;</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result2</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in mrconvert for original image: </span><span class="si">{</span><span class="n">result2</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">exit</span><span class="p">()</span>
         
    <span class="c1"># Load the converted images</span>
    <span class="n">nii_image1</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">temp_file1</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">nii_image2</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">temp_file2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="n">data1</span> <span class="o">=</span> <span class="n">nii_image1</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
    <span class="n">data2</span> <span class="o">=</span> <span class="n">nii_image2</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>

    <span class="c1"># Select middle slice </span>
    <span class="n">slice_index</span> <span class="o">=</span> <span class="n">data1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">//</span> <span class="mi">3</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="c1"># Plot preprocessed data</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">data1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">slice_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greys_r&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Preprocessed data&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

    <span class="c1"># Plot original diffusion data</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">data2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">slice_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;hot&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span> 
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original diffusion data&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/8ce8e67d0223b6a9a437bcf5b47f03812786e3f24c65a4e668dfc1b857c7bbbf.png" src="../_images/8ce8e67d0223b6a9a437bcf5b47f03812786e3f24c65a4e668dfc1b857c7bbbf.png" />
</div>
</div>
</section>
<section id="checking-for-corrupt-slices">
<h4>Checking for Corrupt Slices<a class="headerlink" href="#checking-for-corrupt-slices" title="Link to this heading">#</a></h4>
<p>One of the options in the <code class="docutils literal notranslate"><span class="pre">dwifslpreproc</span></code> command, <em>-nocleanup</em>, retained a directory with the string “tmp” in its title. Within this folder is a file called “dwi_post_eddy.eddy_outlier_map”, which contains strings of 0’s and 1’s. Each 1 represents a slice that is an outlier, either because of too much motion, eddy currents, or something else.</p>
<p>The following code will navigate into the “tmp” folder and calculate the percentage of outlier slices:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>dwifslpreproc-tmp-*<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="err">\</span>
  <span class="n">totalSlices</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">mrinfo</span> <span class="n">dwi</span><span class="o">.</span><span class="n">mif</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">Dimensions</span> <span class="o">|</span> <span class="n">awk</span> <span class="s1">&#39;{print $6 * $8}&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> \
  <span class="n">totalOutliers</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">awk</span> <span class="s1">&#39;{ for(i=1;i&lt;=NF;i++) sum+=$i } END { print sum }&#39;</span> <span class="n">dwi_post_eddy</span><span class="o">.</span><span class="n">eddy_outlier_map</span><span class="p">)</span> <span class="o">&amp;&amp;</span> \
  <span class="n">percentageOutliers</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">awk</span> <span class="s2">&quot;BEGIN { print ($totalOutliers / $totalSlices * 100) }&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> \
  <span class="n">echo</span> <span class="s2">&quot;If the following number is greater than 10, you may have to discard this subject because of too much motion or corrupted slices:&quot;</span> <span class="o">&amp;&amp;</span> \
  <span class="n">echo</span> <span class="s2">&quot;$percentageOutliers&quot;</span> <span class="o">|</span> <span class="n">tee</span> <span class="n">percentageOutliers</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>If the following number is greater than 10, you may have to discard this subject because of too much motion or corrupted slices:
0.522876
</pre></div>
</div>
</div>
</div>
<p>The first two lines navigate into the “tmp” directory and calculate the total number of slices by multiplying the number of slices for a single volume by the total number of volumes in the dataset. The total number of 1’s in the outlier map is then calculated, and the percentage of outlier slices is generated by dividing the number of outlier slices by the total number of slices. If this number is greater than 10 - i.e., if more than 10 percent of the slices are flagged as outliers - you should consider removing the subject from further analyses.</p>
</section>
</section>
<section id="generating-a-mask">
<h3>Generating a Mask<a class="headerlink" href="#generating-a-mask" title="Link to this heading">#</a></h3>
<p>As with fMRI analysis, it is useful to create a mask to restrict your analysis only to brain voxels; this will speed up the rest of your analyses.</p>
<p>To do that, it can be useful to run a command beforehand called <code class="docutils literal notranslate"><span class="pre">dwibiascorrect</span></code>. This can remove inhomogeneities detected in the data that can lead to a better mask estimation. However, it can in some cases lead to a worse estimation; as with all of the preprocessing steps, you should check it before and after each step:</p>
<div style="background-color: #f0f8ff; padding: 10px; border-radius: 5px;">
    <div style="background-color: #add8e6; padding: 5px; border-radius: 5px; font-weight: bold;">
        <span style="font-size: 15px; color: #add8e6; background-color: white; border-radius: 50%; width: 20px; height: 20px; display: inline-block; text-align: center; line-height: 20px;">
            !
        </span> <span style="color: white;">Note:</span>
    </div>
    <p style="margin: 10px 0;">
The following command uses the <code>-ants</code> option, which requires that ANTs is loaded as well. Another option is FSL, then you can replace it with the <code>-fsl</code> option.
    </p>
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">await</span> <span class="n">lmod</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;ants/2.3.5&#39;</span><span class="p">)</span>
<span class="k">await</span> <span class="n">lmod</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;mrtrix3/3.0.4&#39;, &#39;fsl/6.0.7.4&#39;, &#39;ants/2.3.5&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span><span class="w"> </span>dwibiascorrect<span class="w"> </span>ants<span class="w"> </span>sub-02_den_preproc.mif<span class="w"> </span>sub-02_den_preproc_unbiased.mif<span class="w"> </span>-bias<span class="w"> </span>bias.mif
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dwibiascorrect: 
dwibiascorrect: <span class=" -Color -Color-Green">Note that this script makes use of commands / algorithms that have relevant articles for citation; INCLUDING FROM EXTERNAL SOFTWARE PACKAGES. Please consult the help page (-help option) for more information.</span>
dwibiascorrect: 
dwibiascorrect: <span class=" -Color -Color-Green">Generated scratch directory: /data/books/diffusion_imaging/dwibiascorrect-tmp-MVN0VJ/</span>
<span class=" -Color -Color-Cyan">Command:</span>  mrconvert /data/books/diffusion_imaging/sub-02_den_preproc.mif /data/books/diffusion_imaging/dwibiascorrect-tmp-MVN0VJ/in.mif
dwibiascorrect: <span class=" -Color -Color-Green">Changing to scratch directory (/data/books/diffusion_imaging/dwibiascorrect-tmp-MVN0VJ/)</span>
<span class=" -Color -Color-Cyan">Command:</span>  dwi2mask in.mif mask.mif
<span class=" -Color -Color-Cyan">Command:</span>  dwiextract in.mif - -bzero | mrmath - mean mean_bzero.mif -axis 3
<span class=" -Color -Color-Cyan">Command:</span>  mrconvert mean_bzero.mif mean_bzero.nii -strides +1,+2,+3
<span class=" -Color -Color-Cyan">Command:</span>  mrconvert mask.mif mask.nii -strides +1,+2,+3
<span class=" -Color -Color-Cyan">Command:</span>  N4BiasFieldCorrection -d 3 -i mean_bzero.nii -w mask.nii -o [corrected.nii,init_bias.nii] -s 4 -b [100,3] -c [1000,0.0]
<span class=" -Color -Color-Cyan">Command:</span>  mrcalc mean_bzero.mif mask.mif -mult - | mrmath - sum - -axis 0 | mrmath - sum - -axis 1 | mrmath - sum - -axis 2 | mrdump -
<span class=" -Color -Color-Cyan">Command:</span>  mrcalc corrected.nii mask.mif -mult - | mrmath - sum - -axis 0 | mrmath - sum - -axis 1 | mrmath - sum - -axis 2 | mrdump -
<span class=" -Color -Color-Cyan">Command:</span>  mrcalc init_bias.nii 0.6439904810433991 -mult bias.mif
<span class=" -Color -Color-Cyan">Command:</span>  mrcalc in.mif bias.mif -div result.mif
<span class=" -Color -Color-Cyan">Command:</span>  mrconvert result.mif /data/books/diffusion_imaging/sub-02_den_preproc_unbiased.mif
<span class=" -Color -Color-Cyan">Command:</span>  mrconvert bias.mif /data/books/diffusion_imaging/bias.mif
dwibiascorrect: <span class=" -Color -Color-Green">Changing back to original directory (/data/books/diffusion_imaging)</span>
dwibiascorrect: <span class=" -Color -Color-Green">Deleting scratch directory (/data/books/diffusion_imaging/dwibiascorrect-tmp-MVN0VJ/)</span>
</pre></div>
</div>
</div>
</div>
<p>You are now ready to create the mask with <code class="docutils literal notranslate"><span class="pre">dwi2mask</span></code>, which will restrict your analysis to voxels that are located within the brain:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span><span class="w"> </span>dwi2mask<span class="w"> </span>sub-02_den_preproc_unbiased.mif<span class="w"> </span>mask.mif
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dwi2mask: [100%] preloading data for &quot;sub-02_den_preproc_unbiased.mif&quot;[0K?7h?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l
dwi2mask: [done] computing dwi brain mask[0K?7h?7l?7l?7l?7l?7l?7l?7l
dwi2mask: [done] applying mask cleaning filter[0K?7h?7l?7l?7l
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mif_file_path</span> <span class="o">=</span> <span class="s1">&#39;mask.mif&#39;</span>

<span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.nii.gz&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_file</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;mrconvert&quot;</span><span class="p">,</span> <span class="n">mif_file_path</span><span class="p">,</span> <span class="n">temp_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;-force&quot;</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Check for errors in the conversion process</span>
    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in mrconvert: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Load the temporary NIfTI file</span>
        <span class="n">nii_image</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">temp_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">nii_image</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
        
        <span class="n">slice_idx1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">slice_idx2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">slice_idx3</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">slice_idx1</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="n">slice_idx2</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">slice_idx3</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Mask &#39;dwi2mask&#39;&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/fd024a7e5366cb68f0c5a5c00723c63f395cf74df29d289f48d97fa663c0e7b1.png" src="../_images/fd024a7e5366cb68f0c5a5c00723c63f395cf74df29d289f48d97fa663c0e7b1.png" />
</div>
</div>
<p>MRtrix’s <code class="docutils literal notranslate"><span class="pre">dwi2mask</span></code> command works well in most scenarios. However, you can see from the above image that there are holes in the mask. You may be uninterested in these regions, but it is still a good idea to make sure the mask doesn’t have any holes anywhere.</p>
<p>To that end, you could use a command such as FSL’s bet2. For example, you could use the following code to convert the unbiased diffusion-weighted image to NIFTI format, create a mask with bet2, and then convert the mask to .mif format.
You may have to experiment with the fractional intensity threshold (specified by -f) in order to generate a mask that you are satisfied with.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span><span class="w">  </span>mrconvert<span class="w"> </span>sub-02_den_preproc_unbiased.mif<span class="w"> </span>sub-02_unbiased.nii.gz
<span class="o">!</span><span class="w">  </span>bet2<span class="w"> </span>sub-02_unbiased.nii.gz<span class="w"> </span>sub-02_masked<span class="w"> </span>-m<span class="w"> </span>-f<span class="w"> </span><span class="m">0</span>.5
<span class="o">!</span><span class="w">  </span>mrconvert<span class="w"> </span>sub-02_masked_mask.nii.gz<span class="w"> </span>mask_bet.mif
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mrconvert: [100%] copying from &quot;sub-02_den_preproc_unbiased.mif&quot; to &quot;sub-02_unbiased.nii.gz&quot;[0K?7h?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l
mrconvert: [100%] compressing image &quot;sub-02_unbiased.nii.gz&quot;[0K?7h?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l?7l
Warning: An input intended to be a single 3D volume has multiple timepoints. Input will be truncated to first volume, but this functionality is deprecated and will be removed in a future release.
mrconvert: [100%] uncompressing image &quot;sub-02_masked_mask.nii.gz&quot;[0K?7h?7l
mrconvert: [100%] copying from &quot;sub-02_masked_mask.nii.gz&quot; to &quot;mask_bet.mif&quot;[0K?7h?7l
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the NIfTI file</span>
<span class="n">nii_image</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;sub-02_masked_mask.nii.gz&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">nii_image</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>

<span class="c1"># Define volume indices for the three volumes you want to display</span>
<span class="n">slice_idx1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
<span class="n">slice_idx2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
<span class="n">slice_idx3</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>  

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">slice_idx1</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="n">slice_idx2</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">slice_idx3</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Mask &#39;BET&#39;&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b8e556a7770ea929d44027fdf724958d7e659cda6d026e42ac60730b679d8cd2.png" src="../_images/b8e556a7770ea929d44027fdf724958d7e659cda6d026e42ac60730b679d8cd2.png" />
</div>
</div>
<p>Alternatively, inspect the mask using <strong>AnyNiivue</strong>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nv2</span> <span class="o">=</span> <span class="n">AnyNiivue</span><span class="p">()</span>
<span class="n">nv2</span><span class="o">.</span><span class="n">load_volumes</span><span class="p">([{</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s1">&#39;mask_bet.mif&#39;</span><span class="p">}])</span>

<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="s2">&quot;### Mask &#39;Bet&#39;&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">nv2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<h3 class="rubric" id="mask-bet">Mask ‘Bet’</h3>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "3013202ba88343cfa891e32cf0359693", "version_major": 2, "version_minor": 0}</script></div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./diffusion_imaging"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="MRtrix_CSD.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Diffusion Analysis with MRtrix: Part 2 - Constrained Spherical Deconvolution and Tissue estimation</p>
      </div>
    </a>
    <a class="right-next"
       href="mrtrix3tissue.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">MRtrix3Tissue</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#citation">Citation:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup-neurodesk">Setup Neurodesk</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#import-python-modules">Import Python Modules</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-packages">Load packages</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-the-dataset">Downloading the Dataset</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1"></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#looking-at-the-data">Looking at the Data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bvals-and-bvecs"><strong>Bvals and Bvecs</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualization"><strong>Visualization</strong></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preprocessing">Preprocessing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dwi-denoise">dwi_denoise</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mri-degibbs">mri_degibbs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dwipreproc">dwipreproc</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2"></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3"></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id4"></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-for-corrupt-slices">Checking for Corrupt Slices</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-a-mask">Generating a Mask</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Neurodesk Team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>